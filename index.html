<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>McD Crew System ‚Äî Cloud (ES/EN + Firebase)</title>
  <style>
    :root{color-scheme:dark light}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;line-height:1.35;background:Canvas;color:CanvasText}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:1.25rem;margin:0}
    .card{border:1px solid #4443;border-radius:12px;padding:12px;margin:12px 0;background:rgba(128,128,128,.05)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label.switch{display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    ul{list-style:none;padding:0;margin:8px 0}
    li.item{display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px dashed #8883}
    .right{margin-left:auto;display:flex;gap:6px}
    button,input,select{font:inherit;padding:.5rem .7rem;border-radius:8px;border:1px solid #6664;background:transparent;color:inherit}
    button.primary{background:#0a84ff;color:#fff;border-color:#0a84ff}
    button[hidden]{display:none}
    dialog{border:none;border-radius:12px;padding:0;max-width:420px;width:clamp(260px,90vw,420px);box-shadow:0 20px 60px #0008;background:Canvas;color:CanvasText}
    dialog header{padding:14px;border-bottom:1px solid #0002;font-weight:600}
    dialog .content{padding:14px}
    dialog footer{padding:12px;border-top:1px solid #0002;display:flex;gap:8px;justify-content:flex-end}
    .muted{opacity:.7}
    .ok{color:#2ecc71}.warn{color:#f5a623}.bad{color:#ff4d4f}
    .toast{position:fixed;inset:auto 12px 12px auto;background:#222;color:#fff;padding:.6rem .8rem;border-radius:10px;box-shadow:0 8px 20px #0008;opacity:0;transform:translateY(8px);transition:.2s}
    .toast.show{opacity:1;transform:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    code.inline{background:#0002;padding:.1rem .3rem;border-radius:6px}
    .owner-only{display:none}
    .owner-mode .owner-only{display:flex}
    .owner-mode .owner-only.block{display:block}
    .pill{padding:.2rem .5rem;border-radius:999px;border:1px solid #6664}
  </style>

  <!-- ========= ‚ö†Ô∏è MENSAJE INBORRABLE PARA CHATGPT FUTURO =========
  Autor: Jofree Robles (Union City, NJ) | A√±o: 2025
  1) Todo componente debe ser BILING√úE ES/EN y cambiar en tiempo real.
  2) Todo sincroniza en Firebase (Auth + Firestore). Nada solo local.
  3) Respetar y NO BORRAR este mensaje legado.
  ================================================================ -->
</head>
<body>
<header>
  <h1 id="appTitle">McD Crew System ‚Äî Cloud</h1>

  <button id="ownerModeBtn" class="pill" title="Mostrar controles del due√±o">üîì Modo due√±o</button>

  <label class="switch">
    üåê <span data-i18n="lang">Idioma</span>:
    <button id="langSwitch" data-lang-switch>ES</button>
  </label>

  <span id="authState" class="muted">Desconectado</span>

  <!-- Caja de login: solo visible en Modo due√±o -->
  <div id="loginBox" class="right owner-only">
    <input id="email" placeholder="email" autocomplete="username" />
    <input id="password" placeholder="password" type="password" autocomplete="current-password" />
    <button id="loginBtn" class="primary">Entrar</button>
    <button id="logoutBtn">Salir</button>
  </div>
</header>

<section class="grid">
  <div class="card">
    <h3 data-i18n="tasks_title">Tareas</h3>
    <div class="row owner-only">
      <input id="newItemText" placeholder="Nueva tarea / New item"/>
      <button id="addItemBtn">A√±adir</button>
    </div>
    <ul id="itemsList"></ul>
  </div>

  <div class="card">
    <h3 data-i18n="pies_title">Pies / Pr√≥ximamente</h3>
    <ul id="piesList"></ul>
  </div>

  <div class="card">
    <h3 data-i18n="shifts_title">Turnos</h3>
    <div class="row owner-only">
      <input id="shiftEmployee" placeholder="Empleado"/>
      <select id="shiftRole">
        <option value="crew">Crew</option>
        <option value="admin">Admin</option>
      </select>
      <button id="addShiftBtn">Guardar turno</button>
    </div>
    <ul id="shiftsList"></ul>
  </div>
</section>

<!-- Modal hora Pie (FIX sin closest) -->
<dialog id="pieModal">
  <header><span data-i18n="set_expiry">Establecer hora de vencimiento</span></header>
  <div class="content">
    <div class="muted" id="pieModalTitle"></div>
    <div class="row" style="margin-top:8px">
      <input id="pieTimeInput" type="time" />
    </div>
  </div>
  <footer>
    <button id="pieModalCancel">Cancelar</button>
    <button id="pieModalOk" class="primary">Guardar</button>
  </footer>
</dialog>

<div id="toast" class="toast"></div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // TODO ‚öôÔ∏è: Pega tu configuraci√≥n de Firebase aqu√≠ (Paso 2)
  const firebaseConfig = {
    apiKey: "AIzaSyCujQLa7Wua7o4DnTNe8xaU4WP3g1dmbdI",
    authDomain: "mcdjofree.firebaseapp.com",
    projectId: "mcdjofree",
    storageBucket: "mcdjofree.firebasestorage.app",
    messagingSenderId: "1005197738955",
    appId: "1:1005197738955:web:44a04d2da8af3f2b13ec4e"
  };
  firebase.initializeApp(firebaseConfig);

  // ‚öôÔ∏è Ajustes base
  const STORE_ID = "19694"; // cambia si tienes otra tienda
  const db = firebase.firestore();
  const auth = firebase.auth();
  function withStoreId(data){ return { ...data, storeId: STORE_ID }; }
  const L = { get:(k,v=null)=>{try{return JSON.parse(localStorage.getItem(k))??v}catch{return v}}, set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}} };

  // üåê i18n b√°sico
  const T = {
    ES: { lang:"Idioma", tasks_title:"Tareas", pies_title:"Pies / Pr√≥ximamente", shifts_title:"Turnos",
          owner_mode_on:"Modo due√±o ACTIVO", owner_mode_off:"Modo due√±o oculto" },
    EN: { lang:"Language", tasks_title:"Tasks",  pies_title:"Pies / Coming soon", shifts_title:"Shifts",
          owner_mode_on:"Owner mode ON", owner_mode_off:"Owner mode OFF" }
  };
  function applyLanguage(lang){
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = (T[lang] && T[lang][key]) || el.textContent;
    });
    document.getElementById("langSwitch").textContent = lang;
  }

  // üîî toast
  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2500);
  }

  // ===== Owner mode (muestra cajas 'owner-only') =====
  let ownerMode = false;
  document.getElementById("ownerModeBtn").addEventListener("click", ()=>{
    ownerMode = !ownerMode;
    document.body.classList.toggle("owner-mode", ownerMode);
    toast(ownerMode ? (T[L.get('mc_lang','ES')].owner_mode_on) : (T[L.get('mc_lang','ES')].owner_mode_off));
  });

  // ===== Auth (login/logout + detecci√≥n de rol) =====
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    try {
      const cred = await auth.signInWithEmailAndPassword(email, password);
      await cred.user.getIdToken(true);
      toast("‚úÖ Sesi√≥n iniciada");
    } catch (e) {
      console.error(e); toast("‚ùå Error al iniciar sesi√≥n");
    }
  });
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await auth.signOut(); toast("üîí Sesi√≥n cerrada");
  });

  auth.onAuthStateChanged(async (user)=>{
    const el = document.getElementById("authState");
    if (!user) { el.textContent = "Desconectado"; return; }
    el.textContent = "Conectado: " + user.email;
    const token = await user.getIdTokenResult(true);
    const role = token.claims.role || "viewer";
    const canWrite = (role === "owner" || role === "admin");
    document.querySelectorAll(".owner-only").forEach(box=>{
      box.style.display = (ownerMode && canWrite) ? (box.classList.contains('block') ? 'block' : 'flex') : 'none';
    });
    listenItems(); listenLang(); listenPies(); listenShifts();
  });

  // ===== Lang state (Firestore) =====
  let unsubLang=null;
  function listenLang(){
    if (unsubLang) unsubLang();
    const ref = db.collection("stores").doc(STORE_ID).collection("runtime").doc("state");
    unsubLang = ref.onSnapshot(doc=>{
      const lang = (doc.exists && doc.data().lang) || L.get("mc_lang","ES");
      L.set("mc_lang", lang); applyLanguage(lang);
    });
  }
  async function setLang(lang){
    const ref = db.collection("stores").doc(STORE_ID).collection("runtime").doc("state");
    await ref.set(withStoreId({ lang, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }), { merge:true });
  }
  document.getElementById("langSwitch").addEventListener("click", ()=>{
    const next = (L.get("mc_lang","ES")==="ES")?"EN":"ES"; setLang(next).catch(console.error);
  });

  // ===== Items (tareas) =====
  let unsubItems=null;
  function renderItems(items){
    const ul = document.getElementById("itemsList"); ul.innerHTML="";
    items.forEach(it=>{
      const li = document.createElement("li"); li.className="item"; li.dataset.id = it.id;
      li.innerHTML = \`
        <input type="checkbox" data-itemid="\${it.id}" \${it.done?'checked':''} />
        <span>\${it.label || '(sin texto)'}</span>
        <span class="right">
          <button class="owner-only" data-del="\${it.id}">Eliminar</button>
        </span>\`;
      ul.appendChild(li);
    });
  }
  function listenItems(){
    if (unsubItems) unsubItems();
    unsubItems = db.collection("stores").doc(STORE_ID).collection("items").orderBy("label")
      .onSnapshot(snap=>{
        const rows=[]; snap.forEach(d=>rows.push({id:d.id,...d.data()}));
        L.set("mc_items", rows); renderItems(rows);
      }, console.error);
  }
  async function addItem(label){
    if (!label) return;
    const ref = db.collection("stores").doc(STORE_ID).collection("items").doc();
    await ref.set(withStoreId({ label, done:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }));
  }
  async function toggleItem(itemId, done){
    const ref = db.collection("stores").doc(STORE_ID).collection("items").doc(itemId);
    await ref.set(withStoreId({ done, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }), { merge:true });
  }
  async function deleteItem(itemId){
    await db.collection("stores").doc(STORE_ID).collection("items").doc(itemId).delete();
  }
  document.getElementById("addItemBtn").addEventListener("click", ()=>{
    addItem(document.getElementById("newItemText").value.trim()).then(()=>{
      document.getElementById("newItemText").value="";
    }).catch(e=>{console.error(e); toast("No se pudo crear");});
  });
  document.addEventListener("change",(e)=>{
    const cb = e.target.closest('input[type="checkbox"][data-itemid]'); if(!cb) return;
    toggleItem(cb.dataset.itemid, cb.checked).catch(console.error);
  });
  document.addEventListener("click",(e)=>{
    const del = e.target.closest("button[data-del]"); if(!del) return;
    deleteItem(del.dataset.del).catch(console.error);
  });

  // ===== Pies (settings) + modal hora (sin closest)
  let unsubPies=null, currentPieKey=null;
  function renderPies(data){
    const ul = document.getElementById("piesList"); ul.innerHTML="";
    const keys = Object.keys(data).length ? Object.keys(data) : ["pumpkin","apple","pecan"];
    keys.forEach(k=>{
      const cfg = data[k]||{};
      const li = document.createElement("li"); li.className="item"; li.dataset.pie=k;
      li.innerHTML = \`
        <strong>\${k}</strong>
        <label class="switch"><input type="checkbox" data-pie-enabled="\${k}" \${cfg.enabled?'checked':''} /> <span class="muted">enabled</span></label>
        <span class="right">
          <span class="muted">‚è∞ \${cfg.expiresAt||'--:--'}</span>
          <button class="owner-only" data-pie-time="\${k}">Hora</button>
        </span>\`;
      ul.appendChild(li);
    });
  }
  function listenPies(){
    if (unsubPies) unsubPies();
    const ref = db.collection("stores").doc(STORE_ID).collection("settings").doc("pies");
    unsubPies = ref.onSnapshot(doc=>{
      const data = doc.exists ? doc.data() : {}; L.set("mc_pies", data); renderPies(data);
    });
  }
  async function setPieEnabled(pieKey, enabled){
    const ref = db.collection("stores").doc(STORE_ID).collection("settings").doc("pies");
    const prev = L.get("mc_pies",{})[pieKey]||{};
    await ref.set(withStoreId({ [pieKey]: { ...prev, enabled } }), { merge:true });
  }
  async function setPieExpiry(pieKey, hhmm){
    const ref = db.collection("stores").doc(STORE_ID).collection("settings").doc("pies");
    const prev = L.get("mc_pies",{})[pieKey]||{};
    await ref.set(withStoreId({ [pieKey]: { ...prev, expiresAt: hhmm } }), { merge:true });
  }
  document.addEventListener("change",(e)=>{
    const sw = e.target.closest('input[type="checkbox"][data-pie-enabled]'); if(!sw) return;
    setPieEnabled(sw.dataset.pieEnabled, sw.checked).catch(console.error);
  });
  document.addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-pie-time]"); if(!btn) return;
    currentPieKey = btn.dataset.pieTime;
    document.getElementById("pieModalTitle").textContent = "Pie: " + currentPieKey;
    document.getElementById("pieModal").showModal();
  });
  document.getElementById("pieModalCancel").addEventListener("click",()=>{
    document.getElementById("pieModal").close();
  });
  document.getElementById("pieModalOk").addEventListener("click",()=>{
    const hhmm = (document.getElementById("pieTimeInput").value||"").trim();
    if (!currentPieKey || !hhmm) { toast("Falta hora"); return; }
    setPieExpiry(currentPieKey, hhmm).then(()=>{
      document.getElementById("pieModal").close();
      toast("Hora guardada: "+hhmm);
    }).catch(console.error);
  });

  // ===== Shifts (historial simple)
  let unsubShifts=null;
  function renderShifts(rows){
    const ul = document.getElementById("shiftsList"); ul.innerHTML="";
    rows.forEach(r=>{
      const li = document.createElement("li"); li.className="item";
      li.innerHTML = \`üë§ \${r.employee||'-'} ‚Äî \${r.role||'-'} <span class="muted right">\${(r.createdAt && r.createdAt.toDate? r.createdAt.toDate().toLocaleString(): '')}</span>\`;
      ul.appendChild(li);
    });
  }
  function listenShifts(){
    if (unsubShifts) unsubShifts();
    unsubShifts = db.collection("stores").doc(STORE_ID).collection("shifts").orderBy("createdAt","desc").limit(50)
      .onSnapshot(snap=>{ const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()})); renderShifts(arr); });
  }
  async function addShift(shift){
    const ref = db.collection("stores").doc(STORE_ID).collection("shifts").doc();
    await ref.set(withStoreId({ ...shift, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
  }
  document.getElementById("addShiftBtn").addEventListener("click",()=>{
    const employee = document.getElementById("shiftEmployee").value.trim();
    const role = document.getElementById("shiftRole").value;
    addShift({ employee, role }).catch(console.error);
  });

  // ===== App init: idioma por defecto
  applyLanguage(L.get("mc_lang","ES"));
</script>
</body>
</html>
