<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>McD 19694 ‚Äî CREW SYSTEM</title>
<meta content="#353436" name="theme-color"/>
<style>
:root{--bg:#353436;--text:#f2f3f5;--muted:#b8bcc6;--card:#2b2a2c;--border:#47464a;--surface:#3c3b3e;--accent:#ffc72c;--danger:#da291c;--danger-b:#b71f15;--radius:16px;--font:14px}
*{box-sizing:border-box} html,body{height:100%} html,body{overflow-x:hidden}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;color:var(--text);background:var(--bg);font-size:var(--font);-webkit-tap-highlight-color:transparent}
.wrap{max-width:820px;margin:0 auto;padding:8px 8px 24px}
@media (max-width:420px){ .wrap{padding-left:6px;padding-right:6px} }
header.app-header{display:grid;grid-template-columns:84px 1fr 0px;align-items:center;gap:6px;margin:2px 0 6px;position:sticky;top:0;background:var(--bg);z-index:5;padding-top:6px}
.brand{display:flex;align-items:center;justify-content:flex-start;height:64px}
.brand .arches{width:52px;height:52px}
.titles{text-align:center;line-height:1.15}
.titles .t1{font-weight:800;font-size:clamp(1rem,4.2vw,1.35rem);letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.titles .t2{color:var(--muted);margin-top:2px}
/* badge flotante √∫nico */
.emp-float{position:fixed;top:8px;right:8px;z-index:12000;background:rgba(255,199,44,.75);color:#111;border:2px solid #e3b600;border-radius:999px;padding:6px 10px;font-weight:900;box-shadow:0 4px 14px rgba(0,0,0,.35);display:none}
@media (max-width:480px){ .emp-float{top:6px;right:6px;padding:5px 8px;font-size:12px} }
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.pad{padding:8px}
.row{display:flex;align-items:center;gap:8px}
.progress{width:100%;height:10px;background:#2a2930;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),#ffe08a);width:0%}
.pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--surface);font-size:12px;color:var(--muted)}
.toolbar{display:flex;flex-wrap:wrap;gap:8px}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text);min-height:40px;font-weight:700}
.btn.primary{background:var(--danger);border-color:var(--danger-b);color:#fff}
.btn.warn{background:#2b1f00;border-color:#5f3b00;color:#ffd166}
.btn.ghost{background:var(--surface)}
.filters .btn.active{background: var(--accent);color:#111;border-color:#e3b600;box-shadow:0 0 0 2px rgba(255,199,44,.25) inset}
.input{border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:12px;padding:10px;flex:1;min-width:120px;outline:none;min-height:40px}
.section{margin-top:8px}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border)}
.section-title{font-weight:800}
ul.list{list-style:none;margin:0;padding:0}
li.item{display:flex;align-items:center;gap:8px;padding:8px;border-top:1px solid var(--border)}
li.item:first-child{border-top:0}
.item label{flex:1;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item.done label{color:#aab0ba;text-decoration:line-through}
/* Estilos para el bot√≥n de editar */
.edit-pie-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: #ffc72c;
  color: #111;
  border: 1px solid #e3b600;
  min-height: auto;
  padding: 0;
  cursor: pointer;
  margin-left: 4px; /* Separaci√≥n del label */
}
.edit-pie-btn svg {
  width: 16px;
  height: 16px;
}
/* Estilos para el bot√≥n de eliminar (trash) */
.trash{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;background:#b71f15;color:#fff;border:1px solid #8f170f;min-height:auto;padding:0}
.trash svg{width:16px;height:16px}
/* needs-admin se activa con Admin O Owner (Punto 4)*/
.needs-admin:not(.enabled){opacity:.55;filter:grayscale(.2)}
/* needs-owner solo para el bot√≥n del due√±o (Punto 4)*/
.needs-owner:not(.enabled){opacity:.55;filter:grayscale(.2)}

.footer-controls{margin-top:12px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;align-items:center}
.btn-admin{width:auto;height:44px;border-radius:999px;background:#fc0;color:#111;border:1px solid #e3b600;display:inline-flex;align-items:center;gap:8px;justify-content:center;font-weight:900;padding:0 14px;box-shadow:0 2px 6px rgba(0,0,0,.35)}
/* Bot√≥n Modo Due√±o (Punto 4) */
.btn-owner{width:44px;height:44px;border-radius:999px;background:var(--danger);color:#fff;border:1px solid var(--danger-b);display:inline-flex;align-items:center;justify-content:center;padding:0;box-shadow:0 2px 6px rgba(0,0,0,.35)}
.btn-owner svg{width:20px;height:20px}

.btn-admin svg{width:20px;height:20px}
.lang-slider{position:static;display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:3px 5px;box-shadow:0 2px 6px rgba(0,0,0,.35);width:70px;height:36px}
.lang-track{position:relative;flex:1;height:36px;border-radius:999px;background:var(--surface);border:1px solid var(--border);padding:2px;display:flex;align-items:center;justify-content:space-between;overflow:hidden}
.lang-opt{flex:1;text-align:center;font-size:12px;font-weight:800;color:#222;opacity:.7;mix-blend-mode:screen;cursor:pointer}
.lang-knob{position:absolute;top:2px;width:54px;height:32px;border-radius:999px;background:var(--accent);box-shadow:inset 0 -1px 0 rgba(0,0,0,.2),0 1px 2px rgba(0,0,0,.35);transition:transform .18s ease}
.lang-slider.es .lang-knob{transform:translateX(0)} .lang-slider.en .lang-knob{transform:translateX(54px)}
.toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;display:flex;flex-direction:column;gap:8px;z-index:100;pointer-events:none}
.toast{background:#ffea9f;color:#111;border:1px solid #f2d066;border-radius:12px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.35);pointer-events:auto}
.toast.small{font-size:13px;max-width:90vw}
.toast.large{font-size:16px;font-weight:700;padding:12px 16px}
.toast.error{background:#ffd0cc;border-color:#ff9d95}
.toast.success{background:#d8ffd8;border-color:#9be49b}
/* ALERTA PIES GEN√âRICA */
.pie-alert{position:fixed;inset:0;z-index:6400;display:none;align-items:center;justify-content:center;background:#000;animation:piesPulse 900ms infinite}
.pie-alert.show{display:flex}
.pie-alert .inner{text-align:center;padding:24px;border-radius:16px;border:3px solid #ffc72c;box-shadow:0 0 0 6px rgba(255,199,44,.15), inset 0 0 24px rgba(218,41,28,.35);background:radial-gradient(ellipse at center, rgba(218,41,28,.25) 0%, rgba(0,0,0,.6) 60%, rgba(0,0,0,.85) 100%)}
.pie-alert .pie-ico{width:min(70vw,420px);height:auto;margin:0 auto 10px;display:block;filter:drop-shadow(0 8px 18px rgba(0,0,0,.5))}
.pie-alert .msg{color:#fff;font-weight:900;letter-spacing:.5px;font-size:clamp(28px,7vw,64px);text-shadow:0 3px 0 rgba(0,0,0,.65), 0 0 18px rgba(255,0,0,.65);animation:piesShake 1200ms infinite}
@keyframes piesPulse{0%{background-color:rgba(218,41,28,.18)}50%{background-color:rgba(218,41,28,.55)}100%{background-color:rgba(218,41,28,.18)}} @keyframes piesShake{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
.fast-modal, .emp-modal, .owner-modal, .pie-modal{position:fixed;inset:0;z-index:6500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
.fast-modal.show, .emp-modal.show, .owner-modal.show, .pie-modal.show{display:flex}
.fast-card{width:min(92vw,520px);border-radius:16px;background:#2b2a2c;border:3px solid var(--danger);box-shadow:0 12px 40px rgba(0,0,0,.5),0 0 0 6px rgba(218,41,28,.18);padding:18px;text-align:center}
.fast-title{font-size:clamp(18px,3.4vw,28px);font-weight:900;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.5);margin:4px 0 8px}
.fast-sub{color:#f2f3f5;opacity:.9;margin-bottom:12px}
.fast-badge{display:inline-block;background:#ffc72c;color:#111;border:1px solid #e3b600;border-radius:999px;padding:6px 10px;font-weight:800;margin-bottom:10px}
.fast-actions{display:flex;gap:10px;justify-content:center}
.fast-actions .btn{padding:10px 14px;border-radius:12px;border:1px solid #47464a;background:#3c3b3e;color:#fff;font-weight:800;cursor:pointer;min-height:40px}
.fast-actions .btn.primary{background:#da291c;border-color:#b71f15;color:#fff}
.fast-modal.warn .fast-card{border-color:#ffc72c}
.emp-card{width:min(94vw,720px);border-radius:16px;background:#2b2a2c;border:2px solid #e3b600;box-shadow:0 12px 40px rgba(0,0,0,.5),0 0 0 6px rgba(255,199,44,.15);padding:16px}
.emp-title{font-size:clamp(18px,3.6vw,26px);font-weight:900;margin:4px 0 10px}
.emp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.emp-btn{padding:14px;border-radius:12px;text-align:center;font-weight:900;background:#3c3b3e;border:2px solid #ffc72c;color:#fff;cursor:pointer;user-select:none}
.emp-btn:active{background:#da291c;border-color:#b71f15}
.emp-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.emp-actions .btn{padding:10px 14px;border-radius:12px;border:1px solid #47464a;background:#3c3b3e;color:#fff;font-weight:800;cursor:pointer;min-height:40px}
/* Estilos para el modal del due√±o */
.owner-card{width:min(94vw,520px);border-radius:16px;background:#2b2a2c;border:2px solid var(--danger);box-shadow:0 12px 40px rgba(0,0,0,.5),0 0 0 6px rgba(218,41,28,.15);padding:16px}
.owner-title{font-size:clamp(18px,3.6vw,26px);font-weight:900;margin:4px 0 10px;color:#fff;}
.owner-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
/* Estilo del bot√≥n de estado en Modo Due√±o */
.owner-status-btn{width:100%; margin-top:4px; font-weight:800;}
.owner-status-btn.primary{background:#4CB543; border-color:#3C9C35;} 
.owner-status-btn.danger{background:var(--danger); border-color:var(--danger-b);}

.history{margin-top:8px;display:none}
.history.show{display:block}
.hist-item{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#242326;margin-top:8px}
.hist-item .h1{font-weight:900}

/* === v6: Modal con scroll interno fuerte + gr√°ficos completos === */
.histx-overlay{
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 12px;
  overflow: hidden !important;  /* el overlay no scrollea */
}
.histx-modal{
  max-height: 96vh !important;  /* m√°s alto para pantallas grandes */
  overflow-y: auto !important;  /* SCROLL dentro del modal */
  -webkit-overflow-scrolling: touch;  /* scroll suave en iOS */
}
/* Cajas de gr√°ficos m√°s altas para evitar cortes */
.histx-modal .chart-box{
  min-height: 420px !important;
  height: auto !important;
  padding-bottom: 12px;
}
.histx-modal canvas{
  display:block;
  max-width:100%;
  height: 380px !important;  /* asegura visibilidad total del canvas */
}
/* Por si alg√∫n contenedor padre aplic√≥ overflow oculto */
.histx-body, .charts{
  overflow: visible !important;
}
</style>
<style>
  .modal-header-turnos {
  background-color: #DA291C;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  border-radius: 10px 10px 0 0;
  font-weight: bold;
  font-size: 1.1em;
  }
  .close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.3em;
  cursor: pointer;
  font-weight: bold;
  transition: color 0.2s, transform 0.2s;
  }
  .close-btn:hover {
  color: #FFBDBD;
  transform: scale(1.1);
  }
</style>
<style>
  /* ===== Lock Overlay (nuevo dise√±o) ===== */
  #closedOverlay {
  position: fixed;
  inset: 0;
  z-index: 9998;
  display: none;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  overflow: hidden;
}
  #closedOverlay::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(
  circle at center,
  rgba(255, 215, 0, 0.08) 0%,
  rgba(0, 0, 0, 0.55) 80%
  );
  z-index: 0;
}
  #closedOverlay .closed-card {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: min(90%, 600px);
  text-align: center;
  background: #302E24;
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 24px;
  box-shadow: 0 0 40px rgba(0, 0, 0, 0.45);
  color: #fff;
  padding: 50px 40px;
  animation: overlayFadeIn 1.2s ease;
  z-index: 2;
}
  #closedOverlay .logo svg { width: 90px; height: auto; display: block; margin: 0 auto 15px; }
  #closedOverlay h1 { font-size: 2.7rem; font-weight: 800; margin: 10px 0 18px; letter-spacing: 1.3px; text-shadow: 0 0 8px rgba(255, 200, 0, 0.25); }
  #closedOverlay .date { font-size: 1.3rem; color: #ffe988; opacity: .85; margin-bottom: 8px; }
  #closedOverlay .time { font-size: 2.7rem; font-weight: 900; font-family: "Courier New", monospace; color: #f6d94b; text-shadow: 0 0 8px rgba(255, 230, 100, 0.3); margin-bottom: 15px; letter-spacing: 3px; }
  #closedOverlay .hours { font-size: 1rem; color: #ccc; opacity: .8; }
  @keyframes overlayFadeIn { from { opacity: 0; transform: translate(-50%, calc(-50% + 10px)) scale(.98); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
  body.closed-locked { overflow: hidden !important; }
  .lang-fab {
  position: fixed; right: 16px; bottom: 16px; z-index: 12001;
  width: 54px; height: 54px; border-radius: 999px;
  display: inline-flex; align-items: center; justify-content: center;
  background: #302E24; color: #111; border: 2px solid #e3b600;
  font-weight: 900; cursor: pointer; box-shadow: 0 10px 24px rgba(0,0,0,.35);
  user-select: none;
  }
  .lang-fab:hover { filter: brightness(1.05); transform: translateY(-1px); }
</style>
<!-- Injected: overlay language switch styles -->
<style>
/* Switch de idioma fijo para overlay cerrado */

/* Si ya existe .lang-slider en tu app, este bloque es compatible.
  Si no existe, aqu√≠ va un estilo m√≠nimo para que luzca igual. */
.lang-slider{
  background: #3a3a3a;
  border-radius: 50px;
  cursor: pointer;
  padding: 5px;
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.lang-track{
  display: flex; justify-content: space-between; align-items: center;
  width: 100%; position: relative;
}
.lang-opt{
  width: 50%; text-align: center; font-weight: 600; font-size: 18px;
  color: #fff; user-select: none;
}
.lang-knob{
  position: absolute; top: 5px; left: 5px; width: 45px; height: 45px;
  background: #FFD700; border-radius: 50%; transition: left .25s ease;
}
.lang-slider.en .lang-knob { left: 60px; }
</style>

<style>
#langSlider{
  border:1px solid var(--border, #47464a);
  background:linear-gradient(180deg,#3f3f43,#34343a);
  transition:background .25s ease, box-shadow .25s ease;
  position:relative; overflow:hidden;
}
#langSlider .lang-track{font-weight:900;letter-spacing:.5px}
#langSlider .lang-knob{
  box-shadow: inset 0 -1px 0 rgba(0,0,0,.25), 0 6px 18px rgba(0,0,0,.35);
}
#langSlider.en{
  background:linear-gradient(180deg,#5f7ffd,#3d5df7);
  color:#fff; box-shadow:0 0 0 3px rgba(93,125,2 .lang-knob{ width:34px; height:34px; top:3px; left:3px; border-radius:999px; }
#langSlider.en .lang-knob{ left: calc(100% - 3px - 34px); }
</style>


<!-- Injected: Style for 'Ver historial de turnos' button like screenshot -->
<style>
  #btnShowHistory{
    background:#DA291C !important;           /* rojo McDonald's */
    border:3px solid #FFC300 !important;     /* borde amarillo */
    color:#fff !important;
    font-weight:900 !important;
    border-radius:999px !important;          /* pill */
    padding:12px 22px !important;
    min-width:260px !important;              /* ancho visible similar al screenshot */
    box-shadow:
      0 0 0 4px rgba(255,199,44,.25),       /* halo amarillo exterior */
      0 8px 20px rgba(0,0,0,.35) !important;
  }
  #btnShowHistory:hover{
    filter:brightness(1.03);
    transform: translateY(-1px);
  }
  .fc-row2{ justify-content:center !important; margin-top:10px !important; }
</style>


<!-- Fix: 'Ver historial de turnos' button not rounded and centered -->
<style>
  #btnShowHistory{
    background:#DA291C !important;           
    border:3px solid #FFC300 !important;     
    color:#fff !important;
    font-weight:900 !important;
    border-radius:8px !important;            
    padding:12px 24px !important;
    min-width:260px !important;
    box-shadow:0 0 0 3px rgba(255,199,44,.25),
                0 8px 20px rgba(0,0,0,.35) !important;
    display:flex !important;
    justify-content:center !important;
    align-items:center !important;
    margin:0 auto !important;
  }
  .fc-row2{ 
    display:flex !important;
    justify-content:center !important; 
    margin-top:10px !important; 
    width:100% !important;
  }
</style>


<!-- Final layout fix: centrado y margen de 15px entre filas -->
<style>
  .fc-row1{
    display:flex !important;
    justify-content:center !important;
    align-items:center !important;
    gap:10px !important;
    flex-wrap:wrap !important;
  }
  .fc-row2{
    display:flex !important;
    justify-content:center !important;
    align-items:center !important;
    margin-top:15px !important;
    width:100% !important;
  }
  #btnShowHistory{
    background:#DA291C !important;           
    border:3px solid #FFC300 !important;     
    color:#fff !important;
    font-weight:900 !important;
    border-radius:8px !important;            
    padding:12px 24px !important;
    min-width:260px !important;
    box-shadow:0 0 0 3px rgba(255,199,44,.25),
                0 8px 20px rgba(0,0,0,.35) !important;
    display:flex !important;
    justify-content:center !important;
    align-items:center !important;
    margin:0 auto !important;
  }
</style>


<!-- Force rows to stack and center -->
<style>
  .footer-controls{ display:flex !important; flex-wrap:wrap !important; }
  .footer-controls > .fc-row1,
  .footer-controls > .fc-row2{
    flex: 0 0 100% !important;
    width:100% !important;
  }
  .fc-row1{ display:flex !important; justify-content:center !important; align-items:center !important; gap:10px !important; }
  .fc-row2{ display:flex !important; justify-content:center !important; align-items:center !important; margin-top:15px !important; }
  #btnShowHistory{ align-self:center !important; }
</style>


<!-- Strong layout fix: full block stacking and centering -->
<style>
  .footer-controls {
    display: block !important;
    text-align: center !important;
    width: 100% !important;
  }
  .fc-row1,
  .fc-row2 {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    width: 100% !important;
  }
  .fc-row1 { gap: 10px !important; flex-wrap: wrap !important; }
  .fc-row2 { margin-top: 15px !important; }
  #btnShowHistory {
    background: #DA291C !important;
    border: 3px solid #FFC300 !important;
    color: #fff !important;
    font-weight: 900 !important;
    border-radius: 8px !important;
    padding: 12px 24px !important;
    min-width: 260px !important;
    box-shadow: 0 0 0 3px rgba(255,199,44,.25),
                0 8px 20px rgba(0,0,0,.35) !important;
    margin: 0 auto !important;
    display: block !important;
  }
</style>


<style>
/* Footer two rows layout */
.footer-controls{display:block !important;text-align:center !important;width:100% !important}
.fc-row1,.fc-row2{display:flex !important;justify-content:center !important;align-items:center !important;width:100% !important}
.fc-row1{gap:10px !important;flex-wrap:wrap !important}
.fc-row2{margin-top:15px !important}
@media (max-width:480px){
  .footer-controls{padding-bottom:60px}
  #btnShowHistory{min-width:220px !important;font-size:15px !important;padding:10px 20px !important}
  .btn-admin{height:40px !important;font-size:13px !important}
}
/* Language Button */
.lang-btn{
  height:36px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background:var(--surface);color:var(--text);font-weight:900;line-height:1;white-space:nowrap;flex:0 0 auto;
}
@media (max-width:480px){ .lang-btn{height:34px;font-size:13px;padding:8px 10px;} }
/* History button styling */
#btnShowHistory{
  background:#DA291C !important;border:3px solid #FFC300 !important;color:#fff !important;font-weight:900 !important;
  border-radius:8px !important;padding:12px 24px !important;min-width:260px !important;
  box-shadow:0 0 0 3px rgba(255,199,44,.25),0 8px 20px rgba(0,0,0,.35) !important;margin:0 auto !important;display:block !important;
}
</style>

<style>
/* X close for employee modal (non-destructive) */
#empModal .close-btn{
  position:absolute;top:8px;right:10px;background:none;border:none;color:#fff;
  font-size:22px;cursor:pointer;transition:color .2s ease;z-index:7000;
}
#empModal .close-btn:hover{ color:#f4c542; }
</style>

<style>
/* v2: X close INSIDE modal content; hide legacy Cancel button */
#empModal .close-btn{
  position:absolute;top:8px;right:10px;background:none;border:none;color:#fff;
  font-size:22px;cursor:pointer;transition:color .2s ease;z-index:7000;
}
#empModal .close-btn:hover{ color:#f4c542; }
/* Hide old Cancel button completely */
#empCancel{ display:none !important; }
</style>
</head>
<body>
<div class="wrap">
<header class="app-header">
<div class="brand">
<svg aria-label="McDonald‚Äôs" class="arches" role="img" viewbox="0 0 272.70001 238.5" xmlns="http://www.w3.org/2000/svg">
<path d="m195.8 17.933c23.3 0 42.2 98.3 42.2 219.7h34c0-130.7-34.3-236.5-76.3-236.5-24 0-45.2 31.7-59.2 81.5-14-49.8-35.2-81.5-59-81.5-42 0-76.2 105.7-76.2 236.4h34c0-121.4 18.7-219.6 42-219.6s42.2 90.8 42.2 202.8h33.8c0-112 19-202.8 42.3-202.8" fill="#fc0"></path>
</svg>
</div>
<div class="titles">
<div class="t1" id="titleMain">Checklist de turno ‚Äì CREW</div>
<div class="t2" id="titleSub">McDonald‚Äôs #19694</div>
</div>
</header>
<div class="emp-float" id="empFloat">üë§ ‚Äî</div>
<section class="card pad" id="status">
<div class="row">
<div class="progress"><div class="bar" id="bar"></div></div>
<div class="pill" id="pct">0%</div>
</div>
<div class="row" style="margin-top:6px;color:#b8bcc6">
<span id="count">0 de 0 completadas</span>
</div>
</section>
<section class="card pad" style="margin-top:6px">
<div class="toolbar">
<div class="filters" style="display:flex;gap:8px;margin-left:auto;width:100%">
<button class="btn ghost" data-filter="all" id="fltAll">Todas</button>
<button class="btn ghost" data-filter="open" id="fltOpen">Pendientes</button>
<button class="btn ghost" data-filter="done" id="fltDone">Hechas</button>
</div>
</div>
<div class="toolbar" id="adminAddRow" style="margin-top:6px;gap:8px">
<select class="input" id="newCat">
<option value="Caja">Caja</option><option value="Bebidas">Bebidas</option><option value="Limpieza">Limpieza</option><option value="Pantalla">Pantalla</option>
</select>
<input class="input" id="newTask" placeholder="A√±adir tarea‚Ä¶"/>
<button class="btn primary needs-admin" id="btnAdd">A√±adir</button>
</div>
</section>
<section class="card section" id="sec-Caja"><div class="section-header">
<div class="section-title" id="title-Caja">üíµ Caja</div><div class="pill"><span id="pill-Caja">0%</span></div>
</div><div class="section-body"><ul class="list" id="list-Caja"></ul></div></section>
<section class="card section" id="sec-Bebidas"><div class="section-header">
<div class="section-title" id="title-Bebidas">üßÉ Bebidas</div><div class="pill"><span id="pill-Bebidas">0%</span></div>
</div><div class="section-body"><ul class="list" id="list-Bebidas"></ul></div></section>
<section class="card section" id="sec-Limpieza"><div class="section-header">
<div class="section-title" id="title-Limpieza">üßº Limpieza</div><div class="pill"><span id="pill-Limpieza">0%</span></div>
</div><div class="section-body"><ul class="list" id="list-Limpieza"></ul></div></section>
<section class="card section" id="sec-Pantalla"><div class="section-header">
<div class="section-title" id="title-Pantalla">üñ•Ô∏è Pantalla</div><div class="pill"><span id="pill-Pantalla">0%</span></div>
</div><div class="section-body"><ul class="list" id="list-Pantalla"></ul></div></section>
<section class="pad" style="display:flex;flex-wrap:wrap;gap:8px">
<button class="btn primary" id="btnSaveShift">Guardar turno</button>
<button class="btn warn needs-admin" id="btnClear">Vaciar lista</button>
</section>

<section class="card pad footer-controls">
  <div class="fc-row1">
    <button aria-label="Owner" class="btn-owner needs-owner" id="btnOwnerInline">üîß</button>
    <button aria-label="Admin" class="btn-admin" id="btnAdminInline">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 10V7a6 6 0 1 1 12 0v3"></path><rect height="10" rx="2" ry="2" width="16" x="4" y="10"></rect></svg>
      Admin
    </button>
    <button aria-label="Language" class="btn lang-btn" id="btnLang">üåê ENGLISH</button>
  </div>
  <div class="fc-row2">
    <button class="btn" id="btnShowHistory">Ver historial de turnos</button>
  </div>
</section>


<section class="card pad" id="ownerPanel" style="display:none">
<div class="row" style="gap:8px;flex-wrap:wrap">
<input autocomplete="username" class="input" id="ownerUser" placeholder=""/>
<input autocomplete="current-password" class="input" id="ownerPass" placeholder="" type="password"/>
<button class="btn primary" id="btnOwnerLogin">Entrar</button>
<button class="btn" id="btnOwnerLogout" style="display:none">Salir</button>
</div>
<div id="ownerMsg" style="display:none; margin-top:6px;color:#b8bcc6">Ingresa como Due√±o para acceder a la configuraci√≥n avanzada.</div>
</section>
<section class="card pad" id="adminPanel" style="display:none">
<div class="row" style="gap:8px;flex-wrap:wrap">
<input autocomplete="username" class="input" id="adminUser" placeholder=""/>
<input autocomplete="current-password" class="input" id="adminPass" placeholder="" type="password"/>
<button class="btn primary" id="btnLogin">Entrar</button>
<button class="btn" id="btnLogout" style="display:none">Salir</button>
</div>
<div id="adminMsg" style="margin-top:6px;color:#b8bcc6">Ingresa para habilitar acciones de administraci√≥n.</div>

</section>

<section class="card pad" id="toolsBox" style="display:none">
  <div class="section-header">
  <div class="section-title">üß∞ HERRAMIENTAS</div>
  <div class="pill">üîí Solo due√±o</div>
  </div>

  <div class="toolbar" id="toolsButtons" style="gap:8px; flex-wrap:wrap">
  <button class="btn needs-owner enabled" id="btnFirstTool">üß™ Abrir herramienta</button>
  </div>
</section>

<!-- Modal placeholder de la primera herramienta -->
<div class="emp-modal" id="firstToolModal" style="display:none" aria-modal="true" role="dialog">
  <div class="emp-card">
  <div class="emp-title">üß∞ Herramienta ‚Äî Demo</div>
  <div style="color:#b8bcc6">Aqu√≠ ir√° el modal real que me pases.</div>
  <div class="emp-actions">
  <button class="btn" id="firstToolClose">Cerrar</button>
  </div>
  </div>
</div>

 </div>
<div class="pie-alert" id="pieAlert">
<div class="inner">
<div id="pieAlertSvgContainer">
</div>
<div class="msg" id="pieMsg">Pie Vencido</div>
<div style="margin-top:10px; display:flex; justify-content:center;"><button class="btn primary" id="pieAckBtn">Entendido</button></div>
</div>
</div>
<div id="newPieSvgTemplate" style="display:none">
<svg aria-labelledby="title desc" height="400" role="img" viewbox="0 0 900 400" width="900" xmlns="http://www.w3.org/2000/svg">
<title id="pieTitleSvg">McCaf√© Pie ‚Äî frente de caja</title>
<desc id="pieDescSvg">Dise√±o marr√≥n con √≠cono de pie a la izquierda, texto McCaf√© y PIE m√°s cercanos al c√≠rculo, y aviso Caution HOT! arriba a la derecha.</desc>
<defs>
<style>
  .brown { fill:#3A241E; }
  .gold  { fill:#F1B73A; }
  .lattice { fill:#E6F1F4; }
  .white { fill:#FFFFFF; }
  .script { font-family:"Brush Script MT","Pacifico",cursive; }
  .sans { font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif; }
  .yellow { fill:#FFC83A; }
  </style>
</defs>
<rect class="brown" height="400" rx="12" ry="12" width="900" x="0" y="0"></rect>
<g transform="translate(60,40)">
<circle class="gold" cx="140" cy="160" r="140"></circle>
<g class="lattice">
<rect height="40" rx="8" transform="rotate(45 140 80)" width="40" x="120" y="60"></rect>
<rect height="40" rx="8" transform="rotate(45 220 160)" width="40" x="200" y="140"></rect>
<rect height="40" rx="8" transform="rotate(45 60 160)" width="40" x="40" y="140"></rect>
<rect height="40" rx="8" transform="rotate(45 140 240)" width="40" x="120" y="220"></rect>
</g>
</g>
<text class="white script" font-size="88" font-weight="400" x="430" y="125">McCaf√©</text>
<text class="white sans" font-size="160" font-weight="600" letter-spacing="2" x="430" y="280">PIE</text>
<g transform="translate(765,35)">
<rect fill="none" height="60" rx="6" ry="6" stroke="#FFC83A" stroke-width="4" width="115" x="0" y="0"></rect>
<text class="yellow sans" font-size="22" x="14" y="28">Caution</text>
<text class="yellow sans" font-size="24" font-weight="800" x="14" y="52">HOT!</text>
</g>
</svg>
</div>
<div id="applePieSvgTemplate" style="display:none">
<svg aria-labelledby="title desc" class="pie-ico" role="img" viewbox="0 0 600 240" xmlns="http://www.w3.org/2000/svg">
<title id="appleTitleSvg">Caja de Baked Apple Pie estilo McCaf√©</title>
<desc id="appleDescSvg">Caja amarilla con logo McCaf√© recto y texto APPLE PIE muy juntos, alineado a la izquierda.</desc>
<defs>
<style>
  .bg { fill:#F2A91C; }
  .ring { fill:#4CB543; }
  .ring-in { fill:#E4F2F7; }
  .pie { fill:#F4B43A; }
  .txt-dark { fill:#2B1D14; font-family: "Segoe UI", "Helvetica Neue", sans-serif; }
  .txt-light { fill:#FFFFFF; font-family: "Segoe UI", "Helvetica Neue", sans-serif; }
  .script { font-family: "Brush Script MT", cursive; }
  </style>
</defs>
<rect class="bg" height="240" rx="10" ry="10" width="600" x="0" y="0"></rect>
<circle class="ring" cx="95" cy="120" r="72"></circle>
<circle class="ring-in" cx="95" cy="120" r="60"></circle>
<circle class="pie" cx="95" cy="120" r="52"></circle>
<g fill="#FFFFFF">
<rect height="20" rx="4" transform="rotate(45 95 90)" width="20" x="85" y="80"></rect>
<rect height="20" rx="4" transform="rotate(45 125 120)" width="20" x="115" y="110"></rect>
<rect height="20" rx="4" transform="rotate(45 65 120)" width="20" x="55" y="110"></rect>
<rect height="20" rx="4" transform="rotate(45 95 150)" width="20" x="85" y="140"></rect>
</g>
<text class="txt-dark script" font-size="48" font-weight="400" x="240" y="85">McCaf√©</text>
<text class="txt-dark" font-size="22" letter-spacing="2" x="240" y="120">BAKED</text>
<text font-family="Segoe UI, Helvetica Neue, sans-serif" font-size="64" font-weight="700" letter-spacing="0" x="240" y="175">
<tspan class="txt-dark">APPLE</tspan>
<tspan class="txt-light" dx="-16">PIE</tspan>
</text>
<text class="txt-light" font-size="18" text-anchor="end" x="560" y="35">Caution</text>
<text class="txt-light" font-size="18" text-anchor="end" x="560" y="55">HOT!</text>
</svg>
</div>
<div class="pie-modal" id="pieModal">
<div class="emp-card">
<div class="emp-title" id="pieModalTitle">Hora de vencimiento de Pie</div>
<div class="row" style="display:flex; gap:8px; margin-top:8px;">
<input class="input" id="pieTimeInput" step="60" style="width:100%" type="time"/>
</div>
<div class="emp-actions">
<button class="btn primary" id="pieModalOk">Guardar</button></div>
</div>
</div>
<div class="owner-modal" id="ownerConfigModal">
<div class="owner-card">
<div class="owner-title" id="ownerConfigTitle">Configurar Pie</div>
<label for="ownerPieNameInput" id="ownerConfigNameLabel" style="display:block; margin-top:10px; font-weight:700">Nuevo Nombre:</label>
<input class="input" id="ownerPieNameInput" placeholder="Nombre de la tarea" style="margin-top:4px;"/>
<div id="ownerStatusToggle" style="margin-top:15px; display:none;">
<label id="ownerConfigStatusLabel" style="display:block; font-weight:700;">Habilitar/Deshabilitar:</label>
<button class="btn owner-status-btn" id="ownerStatusBtn" style="width:100%; margin-top:4px; font-weight:800;"></button>
</div>
<div class="owner-actions">
<button class="btn primary" id="ownerConfigSave">Guardar Cambios</button>
<button class="btn" id="ownerConfigCancel">Cancelar</button>
</div>
</div>
</div>
<div aria-modal="true" class="fast-modal warn" id="fastModal" role="dialog">
<div class="fast-card">
<div class="fast-badge" id="fastBadge">DETECCI√ìN</div> <div class="fast-title" id="fastTitle">‚ö†Ô∏è Revisi√≥n r√°pida detectada</div>
<div class="fast-sub" id="fastText">Se marc√≥ otra tarea en menos de 2 segundos. Verifique que las tareas se est√©n realizando correctamente.</div>
<div class="fast-actions"><button class="btn primary" id="fastOk">Entendido</button></div> </div>
</div>
<div aria-modal="true" class="emp-modal" id="empModal" role="dialog">
<div class="emp-card">
<div class="emp-title" id="empTitle">Selecciona tu nombre</div>
<div class="emp-grid" id="empGrid"></div>
<div class="emp-actions"><button class="btn" id="empCancel">Cancelar</button></div>
</div>
</div>
<div aria-modal="true" class="emp-modal" id="mgrModal" role="dialog">
<div class="emp-card">
<div class="emp-title" id="mgrTitle">Selecciona al manager</div>
<div class="emp-grid" id="mgrGrid"></div>
<div class="emp-actions"><button class="btn" id="mgrCancel">Cancelar</button></div>
</div>
</div>
<div aria-modal="true" class="emp-modal" id="mgrConfirmModal" role="dialog">
<div class="emp-card" id="mgrConfirmCard" style="background:#ffc72c;color:#111;border-color:#e3b600">
<div class="emp-title" id="mgrConfirmText">¬øManager, confirmas que todo est√° hecho?</div>
<div class="mgr-pin-input" style="display:block; margin-bottom:10px;">
<input autocomplete="off" class="input" id="mgrPinInput" placeholder="Clave de Manager" style="width:100%;" type="password"/>
</div>
<div class="emp-actions">
<button class="btn primary" id="mgrConfirmYes" style="background:var(--danger);border-color:var(--danger-b);color:#fff;font-weight:700">Completado!</button>
<button class="btn" id="mgrConfirmNo" style="background:#3c3b3e;color:#fff">Cancelar</button>
</div>
</div>
</div>
<div class="toast-wrap" id="toasts"></div>
<script>
window.alert = function(msg){ try{ if (window.toast) toast(String(msg||''),'error'); else console.log('ALERT:', msg);}catch(_){console.log('ALERT:', msg);} };

"use strict";
/* ---------- Claves ---------- */
const STORAGE_KEY="mc_items_main"; const ADMIN_KEY="mc_admin"; const LANG_KEY="mc_lang";
const EMP_ACTIVE_KEY="mc_employee_active"; const EMP_LAST_ACTIVITY="mc_employee_last_activity";
const FAST_MIN_MS=2000;
const SHIFT_HISTORY_KEY="mc_shift_history"; 
const ADMIN_PASS="050405";
const OWNER_USER = "jofree";
const OWNER_PASS = "jrm280518";
const OWNER_KEY = "mc_owner";

/* ---------- PIE CONFIGURATION CLAVES ---------- */
const PIE_NAMES_KEY = "mc_pie_names";
const PIE_STATUS_KEY = "mc_pie_status";
const PIE_DEADLINE_PREFIX = "mc_pies_deadline_"; 
const PIE_ACK_PREFIX = "mc_pies_ack_"; 

// Embedded cookies image (base64)
const COOKIES_IMG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 520">
  <!-- Fondo kraft -->
  <rect width="400" height="520" fill="#C7A674"/>

  <!-- Fila superior -->
  <!-- C√≠rculo marr√≥n con borde amarillo -->
  <circle cx="120" cy="120" r="70" fill="#603813" stroke="#F9B21D" stroke-width="10"/>
  <!-- C√≠rculo blanco con borde marr√≥n -->
  <circle cx="280" cy="120" r="70" fill="#FFFFFF" stroke="#603813" stroke-width="10"/>

  <!-- Fila inferior -->
  <!-- Galleta con cuadrados blancos -->
  <circle cx="120" cy="320" r="70" fill="#603813" stroke="#FFFFFF" stroke-width="10"/>
  <rect x="100" y="300" width="15" height="15" fill="#FFFFFF" transform="rotate(10 107 307)"/>
  <rect x="130" y="320" width="15" height="15" fill="#FFFFFF" transform="rotate(-15 137 327)"/>
  <rect x="90" y="330" width="15" height="15" fill="#FFFFFF" transform="rotate(25 97 337)"/>

  <!-- Galleta amarilla con chispas -->
  <circle cx="280" cy="320" r="70" fill="#F9B21D" stroke="#603813" stroke-width="10"/>
  <circle cx="260" cy="300" r="10" fill="#603813"/>
  <circle cx="300" cy="310" r="10" fill="#603813"/>
  <circle cx="280" cy="340" r="10" fill="#603813"/>
  <circle cx="260" cy="330" r="10" fill="#603813"/>

  <!-- Texto McCaf√© -->
  <text x="200" y="460" text-anchor="middle" font-size="42" font-family="Brush Script MT, cursive" fill="#4B2A14">
  McCaf√©
  </text>
</svg>`;
window.COOKIES_IMG = COOKIES_IMG;
const PIE_TYPES = [
  {id:"cookies", cat:"Pantalla", defaultName:"COOKIES", key:"COOKIES_LABEL", defaultEnabled:true, usesAppleSvg:false, usesImage:true, imageKey:"COOKIES_IMG", canBeConfigured:true, canBeDisabled:true},
  {id:"pies",  cat:"Pantalla", defaultName:"APPLE PIES", key:"APPLE_PIES_LABEL", defaultEnabled:true, usesAppleSvg:true, canBeConfigured:false, canBeDisabled:false},
  {id:"pp",  cat:"Pantalla", defaultName:"PUMPKIN PIES", key:"PUMPKIN_PIES_LABEL", defaultEnabled:true, usesAppleSvg:false, canBeConfigured:true, canBeDisabled:true},
  {id:"soon",  cat:"Pantalla", defaultName:"PR√ìXIMAMENTE", key:"SOON_PIE_LABEL", defaultEnabled:false, usesAppleSvg:false, canBeConfigured:true, canBeDisabled:true}
];

const INACTIVITY_MS=1*60*1000;

const EMPLOYEES=["MIGUEL","NEISER","LUIS","XIOMARA","GABRIELA","VALERY","EMILY","JOSE","NAYELI","GLADYS","CHRISTIAN","MICHELLE","NICOLE","SELVIN"];
const MANAGERS=["MINDA","MARIA","KATHERINE","PAOLA","LEYSTER","MIROSLAVA"];

/* ---------- Variables globales nuevas/modificadas ---------- */
let fastAlertsCount = 0; 
let piesToSchedule = null; 
let piesConfiguring = null;
// UI visibility flags for panels
let ownerPanelVisible = false;
let adminPanelVisible = false;
// ----- Alert Audio (WebAudio Beep) -----
let __pieBeepCtx = null;
let __pieBeepOsc = null;
let __pieBeepGain = null;
let __pieBeepInterval = null;

function startPieBeep() {
  try {
  if (!__pieBeepCtx) __pieBeepCtx = new (window.AudioContext || window.webkitAudioContext)();
  stopPieBeep();
  const playChime = () => {
  const seq = [1200, 1500, 1200];
  const nowBase = __pieBeepCtx.currentTime;
  seq.forEach((freq, idx) => {
  const osc = __pieBeepCtx.createOscillator();
  const gain = __pieBeepCtx.createGain();
  osc.type = "sine";
  osc.frequency.setValueAtTime(freq, nowBase + idx * 0.18);
  gain.gain.setValueAtTime(0.0001, nowBase + idx * 0.18);
  gain.gain.exponentialRampToValueAtTime(0.22, nowBase + idx * 0.18 + 0.03);
  gain.gain.exponentialRampToValueAtTime(0.0001, nowBase + idx * 0.18 + 0.16);
  osc.connect(gain);
  gain.connect(__pieBeepCtx.destination);
  osc.start(nowBase + idx * 0.18);
  osc.stop(nowBase + idx * 0.18 + 0.18);
  });
  };
  playChime();
  __pieBeepInterval = setInterval(playChime, 2400);
  } catch(e){ /* ignore */ }
}

function stopPieBeep() {
  try {
  if (__pieBeepInterval) { clearInterval(__pieBeepInterval); __pieBeepInterval = null; }
  if (__pieBeepOsc) { try{__pieBeepOsc.stop();}catch(e){} __pieBeepOsc.disconnect(); __pieBeepOsc = null; }
  if (__pieBeepGain) { __pieBeepGain.disconnect(); __pieBeepGain = null; }
  } catch(e){}
}

 

/* ---------- Utils ---------- */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function toast(msg,type="info",size="small"){const t=document.createElement("div");t.className=`toast ${size} ${type==="error"?"error":type==="success"?"success":""}`;t.innerHTML=msg;$("#toasts").appendChild(t);setTimeout(()=>{t.style.opacity="0";t.style.transform="translateY(6px)";},1800);setTimeout(()=>t.remove(),2300)}
function jget(k,f){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}} 
function jset(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}} 
const isAdmin=()=>localStorage.getItem(ADMIN_KEY)==="1"; 
const setAdmin=v=>localStorage.setItem(ADMIN_KEY,v?"1":"0"); 
const isOwner=()=>localStorage.getItem(OWNER_KEY)==="1"; 
const setOwner=v=>localStorage.setItem(OWNER_KEY,v?"1":"0"); 
const getLang=()=>localStorage.getItem(LANG_KEY)||"es"; 
const setLang=l=>localStorage.setItem(LANG_KEY,l); 
const nowStr=(l)=>new Date().toLocaleString(l==="en"?"en-US":undefined,{dateStyle:"medium",timeStyle:"short"});
const todayKey=()=>new Date().toLocaleDateString(getLang()==="en"?"en-US":undefined,{year:'numeric',month:'2-digit',day:'2-digit'});
const yesterdayKey=()=>{const d=new Date();d.setDate(d.getDate()-1);return d.toLocaleDateString(getLang()==="en"?"en-US":undefined,{year:'numeric',month:'2-digit',day:'2-digit'})};
const isMorning=(record)=>new Date(record.timestamp).getHours()<16; 

// Helpers para PIES
const getPieName = (id) => {
  const names = jget(PIE_NAMES_KEY, {});
  const pieConfig = PIE_TYPES.find(p => p.id === id);
  if (!pieConfig) return "PIE DESCONOCIDO";
  return (names[pieConfig.key] || pieConfig.defaultName).toUpperCase();
};
const getPieStatus = (id) => {
  const pieConfig = PIE_TYPES.find(p => p.id === id);
  if (!pieConfig || !pieConfig.canBeDisabled) return true; 
  const status = jget(PIE_STATUS_KEY, {});
  return status[pieConfig.key] === undefined ? pieConfig.defaultEnabled : status[pieConfig.key];
};
const getPieNameKey = (id) => PIE_TYPES.find(p => p.id === id)?.key;
const getPieDeadlineKey = (id) => PIE_DEADLINE_PREFIX + id;
const getPieAckKey = (id) => PIE_ACK_PREFIX + id;
const getPieConfig = (id) => PIE_TYPES.find(p => p.id === id);
function resetAllTasks() {
  // Uncheck all tasks (pies and regular)
  items.forEach(i => { i.done = false; delete i.doneBy; delete i.timestamp; });
  // NO borrar deadlines/acks para que las alertas sigan su curso.
  initPies();
  updateStatus();
}

/* ---------- i18n (Traducciones) ---------- */ 
let lang=getLang(); 
const I18N={ 
  es:{
  titleMain:"Checklist de turno ‚Äì CREW",
  titleSub:"McDonald‚Äôs #19694",
  filters:{all:"Todas",open:"Pendientes",done:"Hechas"}, 
  addPH:"A√±adir tarea‚Ä¶",
  addBtn:"A√±adir",
  saveShift:"Guardar turno",
  clearList:"Vaciar lista", 
  adminLoginMsg:"Ingresa para habilitar acciones de administraci√≥n.",
  adminActive:"Modo Admin activo.", 
  ownerLoginMsg:"Ingresa como Due√±o para acceder a la configuraci√≥n avanzada.",
  ownerActive:"Modo Due√±o activo.",
  adminNeeded:"No puedes hacer esto.", 
  ownerNeeded:"Necesitas Modo Due√±o.",
  wrong:"‚ùå Usuario o clave incorrectos", 
  loggedIn:"‚úÖ Modo Admin activado",
  loggedOut:"Has salido del Modo Admin", 
  ownerLoggedIn:"‚úÖ Modo Due√±o activado", 
  ownerLoggedOut:"Has salido del Modo Due√±o",
  countFmt:(d,t)=>`${d} de ${t} completadas`, 
  cats:{Caja:"üíµ Caja",Bebidas:"üßÉ Bebidas",Limpieza:"üßº Limpieza",Pantalla:"üñ•Ô∏è Pantalla"}, 
  piesTitle:(name)=>`Hora de vencimiento de ${name}`, 
  piesSave:"Guardar", 
  piesCancel:"Cancelar", 
  piesExpired:(name)=>`${name} vencidos`, 
  needEmployee:"Selecciona tu nombre para continuar.", 
  mustComplete:"Debes completar todo antes de guardar turno.", 
  confirmTitle:"¬øTodo completado correctamente?", 
  enterPin:"Ingresa la clave del manager para confirmar.", 
  confirmed:"Turno guardado con confirmaci√≥n de manager.", 
  historyTitle:"Historial de turnos", 
  historyEmpty:"No hay turnos registrados.", 
  login:"Entrar", 
  logout:"Salir", 
  showHistory:"Ver historial de turnos", 
  completed:"completado", 
  managerPick:"Selecciona al manager", 
  cancel:"Cancelar",
  fastTitle:"‚ö†Ô∏è Revisi√≥n r√°pida detectada",
  fastText:"Se marc√≥ otra tarea en menos de 2 segundos. Verifique que tareas se est√©n realizando correctamente.",
  employeePick:"Selecciona tu nombre",
  shiftMorning:"Ma√±ana",
  shiftEvening:"Tarde/Noche",
  ownerConfigTitle:"Configurar Pie",
  ownerConfigNameLabel:"Nuevo Nombre:",
  ownerConfigStatusLabel:"Habilitar/Deshabilitar:",
  ownerConfigEnabled:"Habilitado (Click para deshabilitar)",
  ownerConfigDisabled:"Deshabilitado (Click para habilitar)",
  ownerConfigSave:"Guardar Cambios",
  ownerConfigCancel:"Cancelar",
  ownerConfigSaved:"‚úÖ Configuraci√≥n de Pie guardada.",
  piesNotFound:"Pie no encontrado para configurar."
  },
  en:{
  titleMain:"Shift Checklist ‚Äì CREW",
  titleSub:"McDonald‚Äôs #19694",
  filters:{all:"All",open:"Open",done:"Done"}, 
  addPH:"Add task‚Ä¶",
  addBtn:"Add",
  saveShift:"Save Shift",
  clearList:"Clear List", 
  adminLoginMsg:"Log in to enable administration actions.",
  adminActive:"Admin Mode active.", 
  ownerLoginMsg:"Log in as Owner to access advanced configuration.",
  ownerActive:"Owner Mode active.",
  adminNeeded:"You cannot do this.", 
  ownerNeeded:"Owner Mode needed.",
  wrong:"‚ùå Incorrect username or password", 
  loggedIn:"‚úÖ Admin Mode activated",
  loggedOut:"You have logged out of Admin Mode", 
  ownerLoggedIn:"‚úÖ Owner Mode activated",
  ownerLoggedOut:"You have logged out of Owner Mode",
  countFmt:(d,t)=>`${d} of ${t} completed`, 
  cats:{Caja:"üíµ Cash Register",Bebidas:"üßÉ Drinks",Limpieza:"üßº Cleaning",Pantalla:"üñ•Ô∏è Screen"}, 
  piesTitle:(name)=>`${name} expiration time`, 
  piesSave:"Save", 
  piesCancel:"Cancel", 
  piesExpired:(name)=>`${name} expired`, 
  needEmployee:"Select your name to continue.", 
  mustComplete:"You must complete all tasks before saving shift.", 
  confirmTitle:"All completed correctly?", 
  enterPin:"Enter manager's key to confirm.", 
  confirmed:"Shift saved with manager confirmation.", 
  historyTitle:"Shift History", 
  historyEmpty:"No shifts recorded.", 
  login:"Log in", 
  logout:"Log out", 
  showHistory:"View Shift History", 
  completed:"completed", 
  managerPick:"Select manager", 
  cancel:"Cancel",
  fastTitle:"‚ö†Ô∏è Quick Check detected",
  fastText:"Another task was checked in less than 2 seconds. Verify that tasks are being performed correctly.",
  employeePick:"Select your name",
  shiftMorning:"Morning",
  shiftEvening:"Afternoon/Night",
  ownerConfigTitle:"Configure Pie",
  ownerConfigNameLabel:"New Name:",
  ownerConfigStatusLabel:"Enable/Disable:",
  ownerConfigEnabled:"Enabled (Click to disable)",
  ownerConfigDisabled:"Disabled (Click to enable)",
  ownerConfigSave:"Save Changes",
  ownerConfigCancel:"Cancel",
  ownerConfigSaved:"‚úÖ Pie configuration saved.",
  piesNotFound:"Pie not found for configuration."
  }
};

let items = jget(STORAGE_KEY, []);
let lastItemClick = 0;

/* ---------- Funciones de la UI ---------- */

// Funci√≥n para inicializar las tareas de Pie de forma din√°mica (y cualquier tarea que falte)
function initPies() {
  let changed = false;
  
  // Lista de IDs de Pie que deber√≠an estar presentes si est√°n habilitados
  const requiredPieIds = PIE_TYPES
  .filter(pie => pie.id === 'soon' ? (getPieStatus('soon') || isOwner()) : getPieStatus(pie.id))
  .map(pie => `pie-${pie.id}`);

  // Eliminar Pies deshabilitados o que ya no existen en PIE_TYPES
  items = items.filter(item => {
  if (item.isPie) {
  return requiredPieIds.includes(item.id);
  }
  return true;
  });

  // A√±adir/Actualizar Pies habilitados
  PIE_TYPES.forEach(pie => {
  if (pie.id === 'soon' ? (getPieStatus('soon') || isOwner()) : getPieStatus(pie.id)) {
  const pieId = `pie-${pie.id}`;
  const existingIndex = items.findIndex(item => item.id === pieId);
  const currentName = getPieName(pie.id);

  if (existingIndex === -1) {
  // A√±adir si no existe
  items.push({
  id: pieId,
  text: currentName,
  cat: pie.cat,
  done: false,
  isPie: true,
  pieType: pie.id,
  isPermanent: true,
  isConfigurable: pie.canBeConfigured,
  });
  changed = true;
  } else if (items[existingIndex].text !== currentName) {
  // Actualizar nombre si el nombre guardado es diferente al actual (por configuraci√≥n de due√±o)
  items[existingIndex].text = currentName;
  changed = true;
  }
  }
  });
  
  // **NUEVA CORRECCI√ìN:** Asegurar que las tareas de ejemplo siempre est√©n presentes si no hay muchas tareas ya.
  const hasEnoughTasks = items.filter(i => !i.isPie).length > 2;
  if (!hasEnoughTasks) {
  const defaultTasks = [
  { id: 'task-caja-1', text: 'Revisar fondo de caja', cat: 'Caja', done: false, isPermanent: false },
  { id: 'task-bebidas-1', text: 'Preparar dispensador de McFlurry', cat: 'Bebidas', done: false, isPermanent: false },
  { id: 'task-limpieza-1', text: 'Limpiar mesas de lobby', cat: 'Limpieza', done: false, isPermanent: false }
  ];
  
  defaultTasks.forEach(defTask => {
  if (!items.some(i => i.id === defTask.id)) {
  items.push(defTask);
  changed = true;
  }
  });
  }

  if (changed) {
  jset(STORAGE_KEY, items);
  }
}

function renderItems(filter = "all") {
  const t = I18N[lang];
  const categories = ["Caja", "Bebidas", "Limpieza", "Pantalla"];
  let total = 0;
  let doneCount = 0;

  // 1. Renderizar Listas de Tareas
  categories.forEach(cat => {
  const list = $(`#list-${cat}`);
  const sec = $(`#sec-${cat}`);
  const pill = $(`#pill-${cat}`);
  list.innerHTML = "";
  
  let catTotal = 0;
  let catDone = 0;

  const filteredItems = items
  .filter(i => i.cat === cat)
  .sort((a, b) => a.isPie === b.isPie ? 0 : a.isPie ? -1 : 1) // Pies primero

  filteredItems.forEach(item => {
  catTotal++;
  if (item.done) catDone++;

  if (filter === "all" || (filter === "open" && !item.done) || (filter === "done" && item.done)) {
  const itemEl = item.isPie ? renderPieItem(item) : renderGeneralItem(item);
  list.appendChild(itemEl);
  }
  });

  // Actualizar totales
  total += catTotal;
  doneCount += catDone;
  
  // Actualizar UI
  const pct = catTotal > 0 ? Math.round((catDone / catTotal) * 100) : 0;
  pill.textContent = `${pct}%`;
  
  // Ocultar secci√≥n si no hay tareas filtradas
  sec.style.display = list.children.length > 0 ? 'block' : 'none';
  $(`#title-${cat}`).textContent = t.cats[cat];
  });

  // 2. Renderizar Progreso General
  const overallPct = total > 0 ? Math.round((doneCount / total) * 100) : 0;
  $("#bar").style.width = `${overallPct}%`;
  $("#pct").textContent = `${overallPct}%`;
  $("#count").textContent = t.countFmt(doneCount, total);

  // 3. Re-a√±adir Event Listeners a los checkboxes
  $$('input[type="checkbox"]').forEach(chk => {
  chk.removeEventListener('change', handleItemClick);
  chk.addEventListener('change', handleItemClick);
  });
}

function renderPieItem(pie) {
  const t = I18N[lang];
  const item = document.createElement("li");
  item.className = `item pie-item ${pie.done ? "done" : ""}`;
  item.dataset.id = pie.id;
  item.dataset.cat = pie.cat;

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = pie.done;
  checkbox.id = `chk-${pie.id}`; 
  checkbox.dataset.id = pie.id;

  const label = document.createElement("label");
  label.textContent = pie.text;
  label.setAttribute("for", `chk-${pie.id}`);

  item.appendChild(checkbox);
  item.appendChild(label);

  // Bot√≥n para configurar/editar el Pie (solo visible para Owner)
  if (isOwner() && pie.isConfigurable) {
  const editBtn = document.createElement("button");
  editBtn.className = "edit-pie-btn";
  editBtn.dataset.id = pie.pieType;
  editBtn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>';
  editBtn.title = `Configurar ${pie.text}`;
  editBtn.addEventListener('click', (e) => handlePieEdit(e.currentTarget.dataset.id));
  item.appendChild(editBtn);
  /* INLINE_TOGGLE_OWNER */
  if (isOwner() && (pie.pieType === 'pp' || pie.pieType === 'soon')) {
  const toggleBtn = document.createElement("button");
  toggleBtn.className = "edit-pie-btn";
  toggleBtn.dataset.type = pie.pieType;
  toggleBtn.title = "Encender/Apagar";
  const enabled = getPieStatus(pie.pieType);
  toggleBtn.innerHTML = enabled
  ? '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v10"/><circle cx="12" cy="14" r="8"/></svg>'
  : '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>';
  toggleBtn.addEventListener("click", (e) => {
  const type = e.currentTarget.dataset.type;
  const cfg = getPieConfig(type);
  if (!cfg || !cfg.canBeDisabled) return;
  const status = jget(PIE_STATUS_KEY, {});
  status[cfg.key] = !getPieStatus(type);
  jset(PIE_STATUS_KEY, status);
  initPies();
  updateStatus();
  checkPiesAndAlert();
  });
  item.appendChild(toggleBtn);
  }

  }
  
  // Bot√≥n para eliminar (solo visible para Admin u Owner)
  if ((isAdmin() || isOwner()) && !pie.isPermanent) {
  const trash = document.createElement("button");
  trash.className = "trash";
  trash.dataset.id = pie.id;
  trash.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>';
  trash.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.id));
  item.appendChild(trash);
  }

  return item;
}

function renderGeneralItem(item) {
  const li = document.createElement("li");
  li.className = `item ${item.done ? "done" : ""}`;
  li.dataset.id = item.id;
  li.dataset.cat = item.cat;

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = item.done;
  checkbox.id = `chk-${item.id}`; 
  checkbox.dataset.id = item.id;

  const label = document.createElement("label");
  label.textContent = item.text;
  label.setAttribute("for", `chk-${item.id}`);

  li.appendChild(checkbox);
  li.appendChild(label);

  if (isAdmin() || isOwner()) {
  const trash = document.createElement("button");
  trash.className = "trash needs-admin enabled";
  trash.dataset.id = item.id;
  trash.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>';
  trash.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.id));
  li.appendChild(trash);
  }

  return li;
}

function updateStatus() {
  jset(STORAGE_KEY, items);
  renderItems($$(".filters .btn.active")[0]?.dataset.filter || "all");
}

function handleItemClick(e) {
  const target = e.target.type === 'checkbox' ? e.target : document.getElementById(e.target.getAttribute('for'));
  if (!target) return;
  
  const id = target.dataset.id;
  const item = items.find(i => i.id === id);
  if (!item) return;

  if (!localStorage.getItem(EMP_ACTIVE_KEY)) {
  e.preventDefault();
  if(target.checked) target.checked = false; 
  
  toast(I18N[lang].needEmployee, "error");
  showEmployeeModal();
  return;
  }

  const now = Date.now();
  if (now - lastItemClick < FAST_MIN_MS && fastAlertsCount < 3) {
  showFastAlert();
  fastAlertsCount++;
  }
  lastItemClick = now;

  item.done = target.checked;
  item.doneBy = localStorage.getItem(EMP_ACTIVE_KEY);
  item.timestamp = new Date().toISOString();
  
  // Si es un Pie y se marca como hecho, mostrar el modal de vencimiento.
  if (item.isPie && item.done) {
  piesToSchedule = item.pieType;
  showPieModal(item.text);
  localStorage.removeItem(getPieAckKey(item.pieType));
  }
  // Si se desmarca un pie, borrar la hora l√≠mite
  if (item.isPie && !item.done) {
  localStorage.removeItem(getPieDeadlineKey(item.pieType));
  }

  updateStatus();
  checkPiesAndAlert();
}

function handleDelete(id) {
  if (!isAdmin() && !isOwner()) {
  toast(I18N[lang].adminNeeded, "error");
  return;
  }
  items = items.filter(i => i.id !== id);
  updateStatus();
  toast("Tarea eliminada", "success");
}

function handleAdd() {
  if (!isAdmin() && !isOwner()) {
  toast(I18N[lang].adminNeeded, "error");
  return;
  }

  const cat = $("#newCat").value;
  const text = $("#newTask").value.trim();

  if (!text || !cat) {
  toast("Ingresa una descripci√≥n para la tarea.", "error");
  return;
  }

  const newId = `task-${Date.now()}`;
  items.push({ id: newId, text, cat, done: false, isPermanent: false });
  $("#newTask").value = "";
  updateStatus();
  toast("Tarea a√±adida", "success");
}

function handleClear() {
  if (!isAdmin() && !isOwner()) {
  toast(I18N[lang].adminNeeded, "error");
  return;
  }
  resetAllTasks();
  toast("Lista reiniciada. Tareas listas para un nuevo turno.", "success");
}
  
  function updateAdminOwnerUI() {
  const t = I18N[lang];
  const isAdminActive = isAdmin() || isOwner();
  const isOwnerActive = isOwner();

  // Panels only show when explicitly toggled AND not already logged in
  const showAdminPanel = adminPanelVisible && !isAdminActive && !isOwnerActive;
  const showOwnerPanel = ownerPanelVisible && !isOwnerActive;

  $("#adminPanel").style.display = showAdminPanel ? "block" : "none";
  $("#ownerPanel").style.display = showOwnerPanel ? "block" : "none";

  // Messages and buttons states
  $("#adminMsg").textContent = isAdminActive ? t.adminActive : t.adminLoginMsg;
  $("#btnLogin").style.display = isAdminActive ? "none" : "inline-block";
  $("#btnLogout").style.display = isAdminActive ? "inline-block" : "none";

  $("#ownerMsg").textContent = isOwnerActive ? t.ownerActive : t.ownerLoginMsg;
  $("#btnOwnerLogin").style.display = isOwnerActive ? "none" : "inline-block";
  $("#btnOwnerLogout").style.display = isOwnerActive ? "inline-block" : "none";

  // Access controls
  $$(".needs-admin").forEach(el => el.classList.toggle("enabled", isAdminActive));
  $$(".needs-owner").forEach(el => el.classList.toggle("enabled", isOwnerActive));

  renderItems($$(".filters .btn.active")[0]?.dataset.filter || "all");
}

/* ---------- Funciones de PIE (Empanadas) ---------- */

function showPieModal(pieName) {
  const t = I18N[lang];
  $("#pieModalTitle").textContent = t.piesTitle(pieName);
  
  const now = new Date();
  now.setHours(now.getHours() + 1);
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  $("#pieTimeInput").value = `${hours}:${minutes}`;

  $("#pieModal").classList.add("show");
}

function handlePieDeadlineSave() {
  if (!piesToSchedule) return;

  const timeInput = $("#pieTimeInput").value;
  if (!timeInput) {
  toast("Debes ingresar una hora", "error");
  return;
  }

  const [hours, minutes] = timeInput.split(':').map(Number);
  const deadline = new Date();
  deadline.setHours(hours, minutes, 0, 0);

  const now = new Date();
  if (deadline.getTime() < now.getTime()) {
  deadline.setDate(deadline.getDate() + 1);
  }
  
  localStorage.setItem(getPieDeadlineKey(piesToSchedule), deadline.getTime());
  piesToSchedule = null; 
  $("#pieModal").classList.remove("show");
  toast("‚úÖ Hora de vencimiento guardada", "success");
  checkPiesAndAlert();
}

function checkPiesAndAlert() {
  // üîß Fix: Evita que la alerta bloquee los modales
  const anyModalOpen = ["empModal", "mgrConfirmModal", "ownerConfigModal", "pieModal"]
    .some(id => document.getElementById(id)?.classList.contains("show"));

  if (anyModalOpen) {
    // Si alg√∫n modal est√° abierto, no mostrar la alerta ni reproducir el beep
    if (typeof stopPieBeep === "function") stopPieBeep();
    const alert = document.getElementById("pieAlert");
    if (alert) alert.classList.remove("show");
    return;
  }

  const t = I18N[lang];
  let expiredPie = null;
  let pieConfig = null;

  for (const pie of PIE_TYPES) {
  if (getPieStatus(pie.id)) {
  const deadline = localStorage.getItem(getPieDeadlineKey(pie.id));
  const isAck = localStorage.getItem(getPieAckKey(pie.id));

  if (deadline && new Date().getTime() > parseInt(deadline) && !isAck) {
  expiredPie = getPieName(pie.id);
  pieConfig = pie;
  break; 
  }
  }
  }

  if (expiredPie) {
  $("#pieMsg").textContent = t.piesExpired(expiredPie);
  const svgContainer = $("#pieAlertSvgContainer");
  if (pieConfig && pieConfig.usesImage && window[pieConfig.imageKey]) {
  svgContainer.innerHTML = (window[pieConfig.imageKey] || (typeof COOKIES_IMG !== "undefined" && pieConfig.imageKey === "COOKIES_IMG" ? COOKIES_IMG : ""));
  } else {
  svgContainer.innerHTML = pieConfig.usesAppleSvg 
  ? $("#applePieSvgTemplate").innerHTML 
  : $("#newPieSvgTemplate").innerHTML;
  }

  const injectedSvg = svgContainer.querySelector('svg');
  if (injectedSvg && !injectedSvg.classList.contains('pie-ico')) {
  injectedSvg.classList.add('pie-ico');
  }

  startPieBeep();
  $("#pieAlert").classList.add("show");
  } else {
  stopPieBeep();
  $("#pieAlert").classList.remove("show");
  }
}

function handlePieEdit(pieId) {
  pieId = (pieId || '').replace(/^pie-/, '');
  if (!isOwner()) {
  toast(I18N[lang].ownerNeeded, "error");
  return;
  }
  
  const t = I18N[lang];
  const pieConfig = getPieConfig(pieId);
  if (!pieConfig) {
  toast(t.piesNotFound, "error");
  return;
  }

  piesConfiguring = pieConfig; 
  const currentName = getPieName(pieId);
  const currentStatus = getPieStatus(pieId);

  $("#ownerConfigTitle").textContent = `${t.ownerConfigTitle}: ${currentName}`;
  $("#ownerPieNameInput").value = currentName;

  const statusToggle = $("#ownerStatusToggle");
  const statusBtn = $("#ownerStatusBtn");
  
  if (pieConfig.canBeDisabled) {
  statusToggle.style.display = 'block';
  statusBtn.textContent = currentStatus ? t.ownerConfigEnabled : t.ownerConfigDisabled;
  statusBtn.className = `btn owner-status-btn ${currentStatus ? "primary" : "danger"}`;
  statusBtn.dataset.status = currentStatus ? "enabled" : "disabled";
  } else {
  statusToggle.style.display = 'none';
  }

  $("#ownerConfigModal").classList.add("show");
}

function handleOwnerConfigSave() {
  if (!piesConfiguring) return;
  const t = I18N[lang];
  const newName = $("#ownerPieNameInput").value.trim().toUpperCase();
  const statusBtn = $("#ownerStatusBtn");
  const isEnabled = piesConfiguring.canBeDisabled 
  ? (statusBtn.dataset.status === "enabled") 
  : true;

  if (piesConfiguring.canBeConfigured) {
  const names = jget(PIE_NAMES_KEY, {});
  names[piesConfiguring.key] = newName;
  jset(PIE_NAMES_KEY, names);
  }

  if (piesConfiguring.canBeDisabled) {
  const status = jget(PIE_STATUS_KEY, {});
  status[piesConfiguring.key] = isEnabled;
  jset(PIE_STATUS_KEY, status);
  }

  piesConfiguring = null;
  $("#ownerConfigModal").classList.remove("show");
  toast(t.ownerConfigSaved, "success");

  initPies(); 
  updateStatus(); 
  checkPiesAndAlert();
}

function togglePieConfigStatus() {
  const t = I18N[lang];
  const statusBtn = $("#ownerStatusBtn");
  const currentStatus = statusBtn.dataset.status;

  if (currentStatus === "enabled") {
  statusBtn.className = "btn owner-status-btn danger";
  statusBtn.textContent = t.ownerConfigDisabled;
  statusBtn.dataset.status = "disabled";
  } else {
  statusBtn.className = "btn owner-status-btn primary";
  statusBtn.textContent = t.ownerConfigEnabled;
  statusBtn.dataset.status = "enabled";
  }
}

function toggleOwnerConfigModal() {
  $("#ownerConfigModal").classList.remove("show");
  piesConfiguring = null;
}
function togglePieModal() {
  $("#pieModal").classList.remove("show");
  piesToSchedule = null;
}
function ackPieAlert() {
  for (const pie of PIE_TYPES) {
  if (getPieStatus(pie.id)) {
  const deadline = localStorage.getItem(getPieDeadlineKey(pie.id));
  const isAck = localStorage.getItem(getPieAckKey(pie.id));

  if (deadline && new Date().getTime() > parseInt(deadline) && !isAck) {
  localStorage.setItem(getPieAckKey(pie.id), "1");
  stopPieBeep();
  stopPieBeep();
  $("#pieAlert").classList.remove("show");
  toast(`‚úÖ Alerta de ${getPieName(pie.id)} reconocida.`, "info");
  checkPiesAndAlert(); 
  return;
  }
  }
  }
}

/* ---------- Funciones de Login/Logout (Owner/Admin) ---------- */

function handleOwnerLogin() {
  const user = $("#ownerUser").value.trim();
  const pass = $("#ownerPass").value.trim();
  const t = I18N[lang];

  if (user === OWNER_USER && pass === OWNER_PASS) {
  setOwner(true);
  setAdmin(true); 
  updateAdminOwnerUI();
  $("#ownerUser").value = "";
  $("#ownerPass").value = "";
  toast(t.ownerLoggedIn, "success", "large");
  initPies(); 
  renderItems();
  } else {
  toast(t.wrong, "error");
  }
}

function handleOwnerLogout() {
  setOwner(false);
  setAdmin(false);
  updateAdminOwnerUI();
  toast(I18N[lang].ownerLoggedOut, "info");
  renderItems();
}

function handleAdminLogin() {
  const user = $("#adminUser").value.trim();
  const pass = $("#adminPass").value.trim();
  const t = I18N[lang];

  if (user === "admin" && pass === ADMIN_PASS) {
  setAdmin(true);
  updateAdminOwnerUI();
  $("#adminUser").value = "";
  $("#adminPass").value = "";
  toast(t.loggedIn, "success", "large");
  renderItems(); 
  } else {
  toast(t.wrong, "error");
  }
}

function handleAdminLogout() {
  setAdmin(false);
  updateAdminOwnerUI();
  toast(I18N[lang].loggedOut, "info");
  renderItems();
}

/* ---------- Funciones de Modal de Empleado y Manager ---------- */

function showEmployeeModal() {
  const t = I18N[lang];
  $("#empTitle").textContent = t.employeePick;
  const grid = $("#empGrid");
  grid.innerHTML = "";
  
  EMPLOYEES.forEach(emp => {
  const btn = document.createElement("div");
  btn.className = "emp-btn";
  btn.textContent = emp;
  btn.addEventListener("click", () => selectEmployee(emp));
  grid.appendChild(btn);
  });
  $("#empModal").classList.add("show");
}

function selectEmployee(name) {
  localStorage.setItem(EMP_ACTIVE_KEY, name);
  localStorage.setItem(EMP_LAST_ACTIVITY, Date.now());
  $("#empFloat").textContent = `üë§ ${name}`;
  $("#empFloat").style.display = "block";
  $("#empModal").classList.remove("show");
  toast(`¬°Hola, ${name}!`, "info");
  renderItems($$(".filters .btn.active")[0]?.dataset.filter || "all");
}

function updateEmployeeFloat() {
  const emp = localStorage.getItem(EMP_ACTIVE_KEY);
  if (emp) {
  const lastActivity = localStorage.getItem(EMP_LAST_ACTIVITY);
  if (Date.now() - lastActivity > INACTIVITY_MS) {
  localStorage.removeItem(EMP_ACTIVE_KEY);
  resetAllTasks();
  $("#empFloat").style.display = "none";
  return;
  }
  $("#empFloat").textContent = `üë§ ${emp}`;
  $("#empFloat").style.display = "block";
  } else {
  $("#empFloat").style.display = "none";
  }
}

function showFastAlert() {
  $("#fastModal").classList.add("show");
}

function showManagerModal() {
  const t = I18N[lang];
  $("#mgrTitle").textContent = t.managerPick;
  const grid = $("#mgrGrid");
  grid.innerHTML = "";
  
  MANAGERS.forEach(mgr => {
  const btn = document.createElement("div");
  btn.className = "emp-btn";
  btn.textContent = mgr;
  btn.addEventListener("click", () => showManagerConfirm(mgr));
  grid.appendChild(btn);
  });
  $("#mgrModal").classList.add("show");
}

function showManagerConfirm(managerName) {
  const t = I18N[lang];
  $("#mgrConfirmText").textContent = `${managerName} ¬øest√° todo completado?`;
  $("#mgrConfirmCard").dataset.manager = managerName;
  $("#mgrPinInput").value = "";
  $("#mgrPinInput").style.display = "none"; 
  // Change button label to "Completado!"
  $("#mgrConfirmYes").textContent = "Completado!";
  $("#mgrModal").classList.remove("show");
  $("#mgrConfirmModal").classList.add("show");
}

function saveShift(managerName) {
  const t = I18N[lang];
  const doneItems = items.filter(i => i.done);
  const shiftRecord = {
  employee: localStorage.getItem(EMP_ACTIVE_KEY),
  manager: managerName,
  timestamp: new Date().toISOString(),
  dateKey: todayKey(),
  totalTasks: items.length,
  completedTasks: doneItems.length,
  items: doneItems.map(i => ({id: i.id, text: i.text, cat: i.cat, doneBy: i.doneBy, timestamp: i.timestamp}))
  };
  const history = jget(SHIFT_HISTORY_KEY, []);
  history.push(shiftRecord);
  jset(SHIFT_HISTORY_KEY, history);
  resetAllTasks();
  $("#mgrConfirmModal").classList.remove("show");
  toast(t.confirmed, "success", "large");
}

function handleSaveShift() {
  const t = I18N[lang];
  if (!localStorage.getItem(EMP_ACTIVE_KEY)) {
  toast(t.needEmployee, "error");
  showEmployeeModal();
  return;
  }
  if (items.some(i => !i.done)) {
  toast(t.mustComplete, "error", "large");
  return;
  }
  showManagerModal();
}

/* ---------- Historial de turnos ---------- */

function renderHistory(){
  const hist = jget(SHIFT_HISTORY_KEY, []);
  const box = $("#historyBox");
  box.innerHTML = "";
  const t = I18N[lang];

  const title2=document.createElement("div");
  title2.className="h1"; title2.style.fontWeight="900"; title2.style.marginTop="6px";
  title2.textContent = t.historyTitle || (lang==="en"?"Shift History":"Historial de turnos");
  box.appendChild(title2);

  // Keys for today and yesterday
  const keyToday = todayKey();
  const keyYest  = yesterdayKey();

  const recToday = hist.filter(r => r.dateKey === keyToday);
  const recYest  = hist.filter(r => r.dateKey === keyYest);

  function bucketByShift(arr){
  const morning = [];  // 05:00‚Äì13:59
  const evening = [];  // 14:00‚Äì23:59 (+ 00:00‚Äì04:59 edge goes to evening)
  arr.forEach(r => {
  const d = new Date(r.timestamp);
  const h = d.getHours();
  if (h >= 5 && h < 14) morning.push(r);
  else if (h >= 14 && h <= 23) evening.push(r);
  else {
  // Edge case 00:00‚Äì04:59 -> count as "evening"
  evening.push(r);
  }
  });
  morning.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
  evening.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
  return {morning, evening};
  }

  function addGroup(title, records){
  const group = document.createElement("div");
  group.style.marginTop = "8px";

  const h2 = document.createElement("div");
  h2.className = "h1"; h2.textContent = title; h2.style.fontWeight = "800";
  group.appendChild(h2);

  if (!records.length){
  const empty = document.createElement("div");
  empty.textContent = (lang==="en"?"No shifts saved.":"Sin turnos guardados.");
  empty.style.color = "var(--muted)";
  empty.style.marginTop = "4px";
  group.appendChild(empty);
  } else {
  records.forEach(r => {
  const item = document.createElement("div");
  item.className = "hist-item";

  const h1 = document.createElement("div");
  h1.className = "h1";
  h1.textContent = `${r.completedTasks}/${r.totalTasks} ${t.completed}`;
  item.appendChild(h1);

  const details = document.createElement("div");
  details.textContent = `${t.employeePick}: ${r.employee} | ${t.managerPick}: ${r.manager}`;
  details.style.color = "var(--muted)"; details.style.fontSize = "12px";
  item.appendChild(details);

  const time = document.createElement("div");
  time.textContent = new Date(r.timestamp).toLocaleTimeString(lang === "en" ? "en-US" : undefined, {timeStyle: "short"});
  time.style.color = "var(--muted)"; time.style.fontSize = "12px";
  item.appendChild(time);

  group.appendChild(item);
  });
  }
  box.appendChild(group);
  }

  function dayLabel(k){
  if (k === keyToday) return (lang==="en"?"Today":"Hoy");
  if (k === keyYest)  return (lang==="en"?"Yesterday":"Ayer");
  return k;
  }
  const lblMorning = (lang==="en"?"MORNING SHIFT 5 AM‚Äì2pm":"TURNO MA√ëANA 5 AM‚Äì2‚ÄØpm");
  const lblEvening = (lang==="en"?"EVENING SHIFT 2pm‚Äì11:59pm":"TURNO TARDE 2‚ÄØpm‚Äì11:59‚ÄØpm");

  // Today groups (always render)
  {
  const {morning, evening} = bucketByShift(recToday);
  addGroup(`${dayLabel(keyToday)} ‚Äî ${lblMorning}`, morning);
  addGroup(`${dayLabel(keyToday)} ‚Äî ${lblEvening}`, evening);
  }

  // Yesterday groups (always render)
  {
  const {morning, evening} = bucketByShift(recYest);
  addGroup(`${dayLabel(keyYest)} ‚Äî ${lblMorning}`, morning);
  addGroup(`${dayLabel(keyYest)} ‚Äî ${lblEvening}`, evening);
  }
}

/* ---------- Inicializaci√≥n y Event Listeners (FIX: Asegura que se ejecuta) ---------- */

function init() {
  initPies();

  renderItems();
  updateEmployeeFloat();
  updateAdminOwnerUI();
  checkPiesAndAlert();

  // 3. Event Listeners
  $("#fltAll").addEventListener("click", (e) => { $$(".filters .btn").forEach(b => b.classList.remove("active")); e.target.classList.add("active"); renderItems("all"); });
  $("#fltOpen").addEventListener("click", (e) => { $$(".filters .btn").forEach(b => b.classList.remove("active")); e.target.classList.add("active"); renderItems("open"); });
  $("#fltDone").addEventListener("click", (e) => { $$(".filters .btn").forEach(b => b.classList.remove("active")); e.target.classList.add("active"); renderItems("done"); });

  $("#btnAdd").addEventListener("click", handleAdd);
  $("#btnClear").addEventListener("click", handleClear);
  $("#btnSaveShift").addEventListener("click", handleSaveShift);

  // Login/Logout Admin
  $("#btnLogin").addEventListener("click", handleAdminLogin);
  $("#btnLogout").addEventListener("click", handleAdminLogout);
  
  // Login/Logout Owner
  $("#btnOwnerLogin").addEventListener("click", handleOwnerLogin);
  $("#btnOwnerLogout").addEventListener("click", handleOwnerLogout);
  $("#btnOwnerInline").addEventListener("click", () => {
  if (isOwner()) {
  handleOwnerLogout();
  } else {
  // **CORRECCI√ìN:** Asegurar que el panel se muestre si no es Due√±o.
  $("#ownerPanel").style.display = 'block';
  $("#adminPanel").style.display = 'none'; 
  }
  });

  $("#btnAdminInline").addEventListener("click", () => {
  if (isAdmin()) {
  handleAdminLogout();
  } else {
  // **CORRECCI√ìN:** Asegurar que el panel se muestre si no es Admin.
  $("#adminPanel").style.display = 'block';
  $("#ownerPanel").style.display = 'none'; 
  }
  });

  // Language Slider
  $("#langSlider").addEventListener("click", () => {
  const newLang = lang === "es" ? "en" : "es";
  setLang(newLang);
  lang = newLang;
  $("#langSlider").classList.remove(newLang === "es" ? "en" : "es");
  $("#langSlider").classList.add(newLang);
  // Recargar la UI con el nuevo idioma
  initPies(); 
  renderItems();
  updateAdminOwnerUI();
  // Cargar traducciones de texto est√°tico y modals
  $$(".t1")[0].textContent = I18N[lang].titleMain;
  $("#titleMain").textContent = I18N[lang].titleMain;
  $("#titleSub").textContent = I18N[lang].titleSub;
  $("#fltAll").textContent = I18N[lang].filters.all;
  $("#fltOpen").textContent = I18N[lang].filters.open;
  $("#fltDone").textContent = I18N[lang].filters.done;
  $("#newTask").placeholder = I18N[lang].addPH;
  $("#btnAdd").textContent = I18N[lang].addBtn;
  $("#btnSaveShift").textContent = I18N[lang].saveShift;
  $("#btnClear").textContent = I18N[lang].clearList;
  $("#btnShowHistory").textContent = I18N[lang].showHistory;
  });
  
  // Employee Modal - Cancel
  $("#empCancel").addEventListener("click", () => $("#empModal").classList.remove("show"));

  // Manager Modal - Cancel / Confirm
  $("#mgrCancel").addEventListener("click", () => $("#mgrModal").classList.remove("show"));
  $("#mgrConfirmNo").addEventListener("click", () => $("#mgrConfirmModal").classList.remove("show"));
  $("#mgrConfirmYes").addEventListener("click", () => {
  const managerName = $("#mgrConfirmCard").dataset.manager;
  saveShift(managerName);
  });

  // History
  document.getElementById("btnShowHistory").addEventListener("click",()=>{ 
  const box=$("#historyBox"); 
  if(box.style.display!=="none"){ 
  box.style.display="none"; box.innerHTML=""; 
  } else { 
  box.style.display="block"; 
  renderHistory();
  }
  });

  // PIE Modals
  $("#pieModalOk").addEventListener("click", handlePieDeadlineSave);
$("#pieAlert").addEventListener("click", ackPieAlert); 

  // Owner Config Modal 
  $("#ownerConfigSave").addEventListener("click", handleOwnerConfigSave);
  $("#ownerConfigCancel").addEventListener("click", toggleOwnerConfigModal);
  $("#ownerStatusBtn").addEventListener("click", togglePieConfigStatus);
  
  // Fast Modal
  $("#fastOk").addEventListener("click", () => $("#fastModal").classList.remove("show"));
}

init();

// Intervalo para actualizar el flotante de empleado y chequear Pies
setInterval(() => {
  updateEmployeeFloat();
  checkPiesAndAlert();
}, 60000); 

document.addEventListener('DOMContentLoaded', function() {
  var ackBtn = document.getElementById('pieAckBtn');
  if (ackBtn) {
  ackBtn.addEventListener('click', function() { try { ackPieAlert(); } catch(e){} });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  // Initial setup
  initPies();
  renderItems();
  updateAdminOwnerUI();
  updateEmployeeFloat();
  checkPiesAndAlert();

  // Periodic updates
  setInterval(updateEmployeeFloat, 30000);
  setInterval(checkPiesAndAlert, 60000);

  // Toggle panels
  const ownerBtn = document.getElementById('btnOwnerInline');
  if (ownerBtn) ownerBtn.addEventListener('click', function(){
  ownerPanelVisible = !ownerPanelVisible;
  adminPanelVisible = false;
  updateAdminOwnerUI();
  });
  const adminBtn = document.getElementById('btnAdminInline');
  if (adminBtn) adminBtn.addEventListener('click', function(){
  adminPanelVisible = !adminPanelVisible;
  ownerPanelVisible = false;
  updateAdminOwnerUI();
  });

  // Admin/Owner auth
  const btnLogin = document.getElementById('btnLogin');
  if (btnLogin) btnLogin.addEventListener('click', handleAdminLogin);
  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) btnLogout.addEventListener('click', handleAdminLogout);
  const btnOwnerLogin = document.getElementById('btnOwnerLogin');
  if (btnOwnerLogin) btnOwnerLogin.addEventListener('click', handleOwnerLogin);
  const btnOwnerLogout = document.getElementById('btnOwnerLogout');
  if (btnOwnerLogout) btnOwnerLogout.addEventListener('click', handleOwnerLogout);

  // Task controls
  const addBtn = document.getElementById('btnAdd');
  if (addBtn) addBtn.addEventListener('click', handleAdd);
  const clearBtn = document.getElementById('btnClear');
  if (clearBtn) clearBtn.addEventListener('click', handleClear);
  const saveBtn = document.getElementById('btnSaveShift');
  if (saveBtn) saveBtn.addEventListener('click', handleSaveShift);

  // Filters
  const fAll = document.getElementById('fltAll');
  const fOpen = document.getElementById('fltOpen');
  const fDone = document.getElementById('fltDone');
  [fAll, fOpen, fDone].forEach(btn => {
  if (btn) btn.addEventListener('click', function(){
  document.querySelectorAll('.filters .btn').forEach(b=>b.classList.remove('active'));
  this.classList.add('active');
  renderItems(this.dataset.filter);
  });
  });

  // PIE modal actions
  const pieOk = document.getElementById('pieModalOk');
  if (pieOk) pieOk.addEventListener('click', handlePieDeadlineSave);
  // Ack button already bound elsewhere in previous step
});

document.addEventListener("DOMContentLoaded", () => {
  // Language slider
  $("#langSlider").addEventListener("click", () => {
  lang = (lang === "es" ? "en" : "es");
  setLang(lang);
  // Update buttons text
  $("#fltAll").textContent = I18N[lang].filters.all;
  $("#fltOpen").textContent = I18N[lang].filters.open;
  $("#fltDone").textContent = I18N[lang].filters.done;
  $("#btnSaveShift").textContent = I18N[lang].saveShift;
  $("#btnClear").textContent = I18N[lang].clearList;
  $("#btnShowHistory").textContent = I18N[lang].showHistory;
  $("#titleMain").textContent = I18N[lang].titleMain;
  $("#titleSub").textContent = I18N[lang].titleSub;
  renderItems($$(".filters .btn.active")[0]?.dataset.filter || "all");
  });

  // Filters
  $$(".filters .btn").forEach(b => b.addEventListener("click", (e) => {
  $$(".filters .btn").forEach(x => x.classList.remove("active"));
  e.currentTarget.classList.add("active");
  renderItems(e.currentTarget.dataset.filter);
  }));
  $("#fltAll").classList.add("active");

  // Admin/Owner toggles (inline buttons show panels)
  $("#btnAdminInline").addEventListener("click", () => { adminPanelVisible = !adminPanelVisible; updateAdminOwnerUI(); });
  $("#btnOwnerInline").addEventListener("click", () => { ownerPanelVisible = !ownerPanelVisible; updateAdminOwnerUI(); });

  // Login buttons
  $("#btnLogin").addEventListener("click", handleAdminLogin);
  $("#btnLogout").addEventListener("click", handleAdminLogout);
  $("#btnOwnerLogin").addEventListener("click", handleOwnerLogin);
  $("#btnOwnerLogout").addEventListener("click", handleOwnerLogout);

  // Add & Clear
  $("#btnAdd").addEventListener("click", handleAdd);
  $("#btnClear").addEventListener("click", handleClear);

  // Save shift flow
  $("#btnSaveShift").addEventListener("click", handleSaveShift);
  $("#mgrCancel").addEventListener("click", () => $("#mgrModal").classList.remove("show"));
  $("#mgrConfirmNo").addEventListener("click", () => $("#mgrConfirmModal").classList.remove("show"));
  $("#mgrConfirmYes").addEventListener("click", () => {
  const mgr = $("#mgrConfirmCard").dataset.manager || "";
  saveShift(mgr);
  });

  // Pie modals
  $("#pieModalOk").addEventListener("click", handlePieDeadlineSave);
  $("#pieModalCancel").addEventListener("click", () => { $("#pieModal").classList.remove("show"); piesToSchedule = null; });
  $("#pieAckBtn").addEventListener("click", ackPieAlert);

  // Owner config modal
  $("#ownerConfigSave").addEventListener("click", handleOwnerConfigSave);
  $("#ownerConfigCancel").addEventListener("click", toggleOwnerConfigModal);
  $("#ownerStatusBtn").addEventListener("click", togglePieConfigStatus);

  // Initial render
  initPies();
  renderItems();
  updateAdminOwnerUI();
  setInterval(() => { updateEmployeeFloat(); checkPiesAndAlert(); }, 5000);
});

// === PATCH: idioma en tiempo real + paneles Admin/Due√±o + PR√ìXIMAMENTE oculto por defecto ===
(function(){
  if (!window.applyLanguage){
  window.applyLanguage = function(newLang){
  lang = newLang || (localStorage.getItem(LANG_KEY) || "es");
  localStorage.setItem(LANG_KEY, lang);
  const t = I18N[lang];
  // T√≠tulos
  const tm=$("#titleMain"); if (tm) tm.textContent=t.titleMain;
  const ts=$("#titleSub"); if (ts) ts.textContent=t.titleSub;
  // Filtros y botones
  const fA=$("#fltAll"), fO=$("#fltOpen"), fD=$("#fltDone");
  if (fA) fA.textContent=t.filters.all;
  if (fO) fO.textContent=t.filters.open;
  if (fD) fD.textContent=t.filters.done;
  const bS=$("#btnSaveShift"), bC=$("#btnClear"), bH=$("#btnShowHistory");
  if (bS) bS.textContent=t.saveShift;
  if (bC) bC.textContent=t.clearList;
  if (bH) bH.textContent=t.showHistory;
  // Placeholder
  const nt=$("#newTask"); if (nt) nt.placeholder=t.addPH;
  // Paneles login
  const isAdm = isAdmin() || isOwner();
  const isOwn = isOwner();
  const am=$("#adminMsg"); if (am) am.textContent = isAdm ? t.adminActive : t.adminLoginMsg;
  const om=$("#ownerMsg"); if (om) om.textContent = isOwn ? t.ownerActive : t.ownerLoginMsg;
  const bl=$("#btnLogin"); if (bl) bl.textContent=t.login;
  const blo=$("#btnLogout"); if (blo) blo.textContent=t.logout;
  const bol=$("#btnOwnerLogin"); if (bol) bol.textContent=t.login;
  const boo=$("#btnOwnerLogout"); if (boo) boo.textContent=t.logout;
  // Secciones
  ["Caja","Bebidas","Limpieza","Pantalla"].forEach(cat=>{
  const el=document.querySelector("#title-"+cat);
  if (el) el.textContent=t.cats[cat];
  });
  // Modales b√°sicos
  const et=$("#empTitle"); if (et) et.textContent=t.employeePick;
  const mt=$("#mgrTitle"); if (mt) mt.textContent=t.managerPick;
  const mcy=$("#mgrConfirmYes"); if (mcy) mcy.textContent="Completado!";
  // Re-render
  initPies();
  renderItems($$(".filters .btn.active")[0]?.dataset.filter || "all");
  }
  }

  document.addEventListener("DOMContentLoaded", function(){
  try{
  // Migraci√≥n: PR√ìXIMAMENTE oculto por defecto si no hay preferencia guardada
  (function(){
  const status = jget(PIE_STATUS_KEY, {});
  if (status["SOON_PIE_LABEL"] === undefined){
  status["SOON_PIE_LABEL"] = false;
  jset(PIE_STATUS_KEY, status);
  }
  })();

  // Slider idioma
  const slider = $("#langSlider");
  if (slider){
  const stored = localStorage.getItem(LANG_KEY) || "es";
  slider.classList.remove("es","en");
  slider.classList.add(stored);
  slider.addEventListener("click", function(){
  const next = (lang === "es") ? "en" : "es";
  slider.classList.remove(lang);
  slider.classList.add(next);
  applyLanguage(next);
  });
  }

  // Botones inline para abrir paneles (siempre activos)
  const btnAdm=$("#btnAdminInline");
  const btnOwn=$("#btnOwnerInline");
  if (btnAdm) btnAdm.addEventListener("click", function(){ adminPanelVisible=true; updateAdminOwnerUI(); });
  if (btnOwn) btnOwn.addEventListener("click", function(){ ownerPanelVisible=true; updateAdminOwnerUI(); });

  // Aplicar idioma al iniciar
  applyLanguage(localStorage.getItem(LANG_KEY) || "es");
  }catch(e){ console.error("Patch init error", e); }
  });
})();

/* __ALERT_SCHEDULER__ */
;(function setupPieAlertScheduler(){
  try{
  // Re-check every 15s to catch deadlines even if no interaction happens
  if (!window.__pieAlertTimer){
  window.__pieAlertTimer = setInterval(checkPiesAndAlert, 15000);
  }
  // Resume AudioContext on first user interaction so beeps can sound later
  const resumeAudio = async () => {
  try{
  if (window.__pieBeepCtx && window.__pieBeepCtx.state === 'suspended') {
  await window.__pieBeepCtx.resume();
  }
  }catch(e){}
  };
  if (!window.__pieAudioResumeBound){
  ['pointerdown','keydown','touchstart','click'].forEach(ev=>document.addEventListener(ev, resumeAudio, {once:false, passive:true}));
  window.__pieAudioResumeBound = true;
  }
  // Check immediately on load
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) setTimeout(checkPiesAndAlert, 250); });
  window.addEventListener('focus', ()=> setTimeout(checkPiesAndAlert, 250));
  setTimeout(checkPiesAndAlert, 300);
  }catch(e){}
})();
/* __OWNER_EVENT_WIRING__ */
(function ensureOwnerWiring(){
  try{
  const saveBtn = document.getElementById("ownerConfigSave");
  if (saveBtn && !saveBtn.dataset.bound){ saveBtn.addEventListener("click", handleOwnerConfigSave); saveBtn.dataset.bound="1"; }
  const cancelBtn = document.getElementById("ownerConfigCancel");
  if (cancelBtn && !cancelBtn.dataset.bound){ cancelBtn.addEventListener("click", toggleOwnerConfigModal); cancelBtn.dataset.bound="1"; }
  const statusBtn = document.getElementById("ownerStatusBtn");
  if (statusBtn && !statusBtn.dataset.bound){ statusBtn.addEventListener("click", togglePieConfigStatus); statusBtn.dataset.bound="1"; }
  }catch(e){}
})();
</script>
<!-- PATCH START -->
<script>
window.alert = function(msg){ try{ if (window.toast) toast(String(msg||''),'error'); else console.log('ALERT:', msg);}catch(_){console.log('ALERT:', msg);} };

(function(){
  // Safe patch: no breaking existing code
  const LS = window.localStorage;
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const PIE_STATUS_KEY = 'pie_status';
  const getStatus = () => { try { return JSON.parse(LS.getItem(PIE_STATUS_KEY) || '{}'); } catch(e){ return {}; } };
  const setStatus = (o) => LS.setItem(PIE_STATUS_KEY, JSON.stringify(o));

  // ---- 1) Manager PIN & anti-doble guard ----
  const MANAGER_PINS = window.MANAGER_PINS || {
  'MINDA':'19694','MARIA':'19694','KATHERINE':'19694','PAOLA':'19694','LEYSTER':'19694','MIROSLAVA':'19694'
  };
  let isSavingShift = false;

  function ensurePinUI(){
  const pin = $("#mgrPinInput");
  if (pin) { pin.style.display = "block"; }
  }

  function checkPin(){
  const card = $("#mgrConfirmCard");
  const manager = card ? card.dataset.manager : null;
  const input = $("#mgrPinInput");
  const value = (input && input.value || "").trim();
  const expected = manager ? MANAGER_PINS[manager] || MANAGER_PINS[manager.toUpperCase?.()] : null;
  return expected && value === expected;
  }

  function onMgrConfirmYesClickPatched(ev){
  // prevent double save
  if (isSavingShift) return;
  ensurePinUI();
  if (!checkPin()){
  alert("Ingresa el PIN del manager.");
  $("#mgrPinInput") && $("#mgrPinInput").focus();
  return;
  }
  isSavingShift = true;
  ev.currentTarget.disabled = true;
  // Allow original listener to run afterwards (we patch only once)
  setTimeout(()=>{ isSavingShift=false; ev.currentTarget.disabled=false; }, 1500);
  }

  function patchMgrConfirm(){
  const btn = $("#mgrConfirmYes");
  if (btn && !btn.dataset.patched){
  btn.addEventListener("click", onMgrConfirmYesClickPatched, true); // capture to run first
  btn.dataset.patched = "1";
  }
  }

  // ---- 2) Pies: mantener deadlines y ocultar mientras vigentes ----
  // We won't erase deadlines on any "resetAll" ‚Äì if app clears, we reapply from backup key.
  // Hide items that are pies and still within deadline for non-owner users.
  function isOwner(){
  try{
  return document.documentElement.classList.contains("owner-mode") || !!$("#ownerPanel");
  }catch(e){ return false; }
  }

  function getDeadlineKey(type){ return "pie_deadline_"+type; }

  function hideActivePiesForCrew(){
  try{
  if (isOwner()) return; // owner sees everything
  const now = Date.now();
  $$(".todo-item[data-pie-type]").forEach(it=>{
  const type = it.dataset.pieType;
  const deadline = parseInt(LS.getItem(getDeadlineKey(type)||""),10);
  if (deadline && now < deadline){
  it.style.display = "none";
  }
  });
  }catch(e){}
  }

  // ---- 3 & 4 & 6) PR√ìXIMAMENTE visible siempre en due√±o + toggles en due√±o ----
  function addOwnerToggles(){
  if (!isOwner()) return;
  $$(".todo-item[data-pie-type]").forEach(it=>{
  const type = it.dataset.pieType;
  if (type !== "pp" && type !== "soon") return;
  if (it.querySelector(".patch-toggle")) return;
  const btn = document.createElement("button");
  btn.className = "patch-toggle edit-pie-btn";
  btn.textContent = (getStatus()[type] !== false) ? "Apagar" : "Encender";
  btn.addEventListener("click", ()=>{
  const s = getStatus();
  s[type] = !(s[type] !== false); // toggle
  setStatus(s);
  location.reload();
  });
  it.appendChild(btn);
  // Force show 'soon' in owner mode
  if (type==="soon") it.style.display = "";
  });
  }

  // Ensure patches after DOM ready & after app renders
  function applyPatches(){
  try{
  patchMgrConfirm();
  hideActivePiesForCrew();
  addOwnerToggles();
  }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", function(){
  applyPatches();
  // Also patch after short delay in case the app renders later
  setTimeout(applyPatches, 800);
  setInterval(applyPatches, 3000); // keep in sync if list rerenders
  });
})();
/* __ALERT_SCHEDULER__ */
;(function setupPieAlertScheduler(){
  try{
  // Re-check every 15s to catch deadlines even if no interaction happens
  if (!window.__pieAlertTimer){
  window.__pieAlertTimer = setInterval(checkPiesAndAlert, 15000);
  }
  // Resume AudioContext on first user interaction so beeps can sound later
  const resumeAudio = async () => {
  try{
  if (window.__pieBeepCtx && window.__pieBeepCtx.state === 'suspended') {
  await window.__pieBeepCtx.resume();
  }
  }catch(e){}
  };
  if (!window.__pieAudioResumeBound){
  ['pointerdown','keydown','touchstart','click'].forEach(ev=>document.addEventListener(ev, resumeAudio, {once:false, passive:true}));
  window.__pieAudioResumeBound = true;
  }
  // Check immediately on load
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) setTimeout(checkPiesAndAlert, 250); });
  window.addEventListener('focus', ()=> setTimeout(checkPiesAndAlert, 250));
  setTimeout(checkPiesAndAlert, 300);
  }catch(e){}
})();
/* __OWNER_EVENT_WIRING__ */
(function ensureOwnerWiring(){
  try{
  const saveBtn = document.getElementById("ownerConfigSave");
  if (saveBtn && !saveBtn.dataset.bound){ saveBtn.addEventListener("click", handleOwnerConfigSave); saveBtn.dataset.bound="1"; }
  const cancelBtn = document.getElementById("ownerConfigCancel");
  if (cancelBtn && !cancelBtn.dataset.bound){ cancelBtn.addEventListener("click", toggleOwnerConfigModal); cancelBtn.dataset.bound="1"; }
  const statusBtn = document.getElementById("ownerStatusBtn");
  if (statusBtn && !statusBtn.dataset.bound){ statusBtn.addEventListener("click", togglePieConfigStatus); statusBtn.dataset.bound="1"; }
  }catch(e){}
})();
</script>
<!-- PATCH END -->
<!-- ===== ChatGPT Fix Patch v17-poller+pin+dedupe (non-destructive) ===== -->
<script>
window.alert = function(msg){ try{ if (window.toast) toast(String(msg||''),'error'); else console.log('ALERT:', msg);}catch(_){console.log('ALERT:', msg);} };

(function () {
  // ---------- SAFE HELPERS ----------
  function safeCheck() {
  if (typeof window.checkPiesAndAlert === "function") {
  try { window.checkPiesAndAlert(); } catch (e) { /* noop */ }
  }
  }

  // ---------- 1) POLLING PARA ALERTAS DE PIES (cada 1000ms) ----------
  var __piePoller = null;
  function startPiePoller() {
  if (__piePoller) return;
  __piePoller = setInterval(safeCheck, 1000);
  safeCheck(); // chequeo inmediato al iniciar
  }
  document.addEventListener("DOMContentLoaded", startPiePoller);
  document.addEventListener("visibilitychange", function () {
  if (!document.hidden) safeCheck();
  });
  window.addEventListener("storage", function (e) {
  if (!e || !e.key) return;
  if (e.key.indexOf("mc_pies_deadline_") === 0 || e.key.indexOf("mc_pies_ack_") === 0) {
  safeCheck();
  }
  });

  // ---------- 2) MOSTRAR CAMPO PIN DEL MANAGER ----------
  function showMgrPinIfPresent() {
  var input = document.getElementById("mgrPinInput");
  if (input) {
  try {
  input.style.display = "block";
  input.removeAttribute("hidden");
  input.setAttribute("aria-hidden", "false");
  } catch (e) {}
  }
  }
  document.addEventListener("DOMContentLoaded", showMgrPinIfPresent);

  // ---------- 2b) EVITAR REGISTROS DUPLICADOS (wrap saveShift) ----------
  (function () {
  var originalSave = window.saveShift;
  var saving = false;
  if (typeof originalSave === "function") {
  window.saveShift = function () {
  if (saving) {
  try { console.warn && console.warn("[dedupe] saveShift ignorado (llamado m√∫ltiple)"); } catch (e) {}
  return;
  }
  saving = true;
  try {
  return originalSave.apply(this, arguments);
  } finally {
  setTimeout(function () { saving = false; }, 500);
  }
  };
  }
  })();

  // === Confirmaci√≥n con PIN (estricta y anti-duplicados) ===
window.__savingShift = false;
window.confirmWithPin = function(){
  try{
  const t = (window.I18N && window.I18N[window.lang||'es']) || { confirmed:"Confirmado.", need_employee:"Selecciona un empleado.", need_tasks:"Completa al menos una tarea." };
  const pinInput = document.getElementById("mgrPinInput");
  const pin = (pinInput ? String(pinInput.value||"") : "").trim();

  // Validaciones previas
  const emp = localStorage.getItem("mc_employee_active");
  if (!emp){
  if (typeof window.toast==="function") toast(t.need_employee || "Selecciona un empleado.", "error");
  return false;
  }
  if (!pin){
  if (typeof window.toast==="function") toast("Ingresa la clave del manager", "error");
  if (pinInput) pinInput.focus();
  return false;
  }
  if (typeof window.ADMIN_PASS !== "undefined" && String(window.ADMIN_PASS) !== pin){
  if (typeof window.toast==="function") toast("PIN incorrecto", "error");
  if (pinInput) pinInput.select();
  return false;
  }

  // Reglas de tareas: al menos una completada
  try{
  if (Array.isArray(window.items)){
  const done = window.items.filter(i=>i && i.done);
  if (window.items.length === 0 || done.length === 0){
  if (typeof window.toast==="function") toast(t.need_tasks || "Completa al menos una tarea.", "error");
  return false;
  }
  }
  }catch(_){}

  if (window.__savingShift) return false;
  window.__savingShift = true;
  setTimeout(()=>window.__savingShift=false, 1200); // liberamos en 1.2s

  // Guardado con verificaci√≥n por longitud de historial
  let before = 0;
  try { before = (jget && jget(SHIFT_HISTORY_KEY, []) || []).length; } catch(_) {}
  if (typeof window.saveShift === "function"){
  // Manager desde dataset del modal
  let managerName = "MANAGER";
  const card = document.getElementById("mgrConfirmCard");
  if (card && card.dataset && card.dataset.manager) managerName = card.dataset.manager;

  window.saveShift(managerName);
  setTimeout(function(){
  try{
  const after = (jget && jget(SHIFT_HISTORY_KEY, []) || []).length;
  if (after <= before){
  // Si no se registr√≥, reintentar UNA sola vez
  try{ window.saveShift(managerName); }catch(_){}
  }
  }catch(_){}
  }, 80);
  }else{
  const modal = document.getElementById("mgrConfirmModal");
  if (modal) modal.classList.remove("show");
  if (typeof window.toast==="function") toast(t.confirmed || "Confirmado.", "success", "large");
  }
  }catch(e){}
  return false;
};

// Enter en el PIN dispara confirmaci√≥n
document.addEventListener("DOMContentLoaded", function(){
  try{
  const pinInput = document.getElementById("mgrPinInput");
  if (pinInput){
  pinInput.addEventListener("keydown", function(ev){
  if (ev.key === "Enter"){
  ev.preventDefault(); ev.stopImmediatePropagation();
  return window.confirmWithPin();
  }
  }, {capture:true});
  }
  }catch(e){}
});
}
  const pinInput = document.getElementById("mgrPinInput");
  if (pinInput){
  pinInput.addEventListener("keydown", function(ev){
  if (ev.key === "Enter"){
  ev.preventDefault(); ev.stopImmediatePropagation();
  return window.confirmWithPin();
  }
  });
  }
  }catch(e){}
});
// === showManagerConfirm (STRONG OVERRIDE: sin llamar al original) ===
window.showManagerConfirm = function(managerName){
  try{
  const mgr = managerName || "MANAGER";
  const card = document.getElementById("mgrConfirmCard");
  if (card) card.dataset.manager = mgr;

  const txt = document.getElementById("mgrConfirmText");
  if (txt) txt.textContent = `${mgr} ¬øest√° todo completado?`;

  // Mostrar PIN y enfocar
  const pinWrap = document.querySelector("#mgrConfirmModal .mgr-pin-input");
  const pinInput = document.getElementById("mgrPinInput");
  if (pinWrap) pinWrap.style.display = "block";
  if (pinInput){
  pinInput.removeAttribute("hidden");
  pinInput.setAttribute("aria-hidden","false");
  pinInput.value = "";
  setTimeout(()=>{ try{ pinInput.focus(); }catch(_){} }, 30);
  }

  // Rewire bot√≥n: clonar para eliminar listeners antiguos y estilo amarillo visible
  const yesBtn = document.getElementById("mgrConfirmYes");
  if (yesBtn){
  const clone = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(clone, yesBtn);
  clone.textContent = "Completado!";
  clone.type = "button";
  clone.classList.add("btn","primary");
  clone.style.background = "#FFC300";
  clone.style.borderColor = "#FFC300";
  clone.style.color = "#111";
  clone.style.fontWeight = "700";
  clone.addEventListener("click", function(ev){
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.confirmWithPin();
  return false;
  }, {capture:true});
  }

  // Abrir modal, cerrar selector de managers
  const modal = document.getElementById("mgrConfirmModal");
  if (modal) modal.classList.add("show");
  const m1 = document.getElementById("mgrModal");
  if (m1) m1.classList.remove("show");
  }catch(e){}
  return true;
};
window.showManagerConfirm = function(managerName){
  try{
  const mgr = managerName || "MANAGER";
  const card = document.getElementById("mgrConfirmCard");
  if (card) card.dataset.manager = mgr;

  const txt = document.getElementById("mgrConfirmText");
  if (txt) txt.textContent = `${mgr} ¬øest√° todo completado?`;

  // Mostrar PIN y enfocar
  const pinWrap = document.querySelector("#mgrConfirmModal .mgr-pin-input");
  const pinInput = document.getElementById("mgrPinInput");
  if (pinWrap) pinWrap.style.display = "block";
  if (pinInput){
  pinInput.removeAttribute("hidden");
  pinInput.setAttribute("aria-hidden","false");
  pinInput.value = "";
  setTimeout(()=>{ try{ pinInput.focus(); }catch(_){} }, 30);
  }

  // Rewire bot√≥n: clonar para eliminar listeners antiguos y estilo amarillo visible
  const yesBtn = document.getElementById("mgrConfirmYes");
  if (yesBtn){
  const clone = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(clone, yesBtn);
  clone.textContent = "Completado!";
  clone.type = "button";
  clone.classList.add("btn","primary");
  clone.style.background = "#FFC300";
  clone.style.borderColor = "#FFC300";
  clone.style.color = "#111";
  clone.style.fontWeight = "700";
  clone.addEventListener("click", function(ev){
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.confirmWithPin();
  return false;
  }, {capture:true});
  }

  // Abrir modal, cerrar selector de managers
  const modal = document.getElementById("mgrConfirmModal");
  if (modal) modal.classList.add("show");
  const m1 = document.getElementById("mgrModal");
  if (m1) m1.classList.remove("show");
  }catch(e){}
  return true;
};
})();
<!-- ===== End Patch ===== -->

<!-- ===== ChatGPT Patch v17.1 ‚Äî anti-cheat hardening + PIN modal fix ===== -->
<script>
window.alert = function(msg){ try{ if (window.toast) toast(String(msg||''),'error'); else console.log('ALERT:', msg);}catch(_){console.log('ALERT:', msg);} };

(function(){
  // --- 1) Anti-trampa robusto (evita toggles rapid√≠simos y alternados) ---
  const FAST_MIN_MS = window.FAST_MIN_MS || 2000;
  // √öltimo timestamp global y por casilla
  if (!window.__lastToggleGlobal) window.__lastToggleGlobal = 0;
  if (!window.__lastToggleById) window.__lastToggleById = Object.create(null);

  // Guardamos referencia al handler original si existe
  const originalHandle = window.handleItemClick;

  window.handleItemClick = function(e){
  try{
  const chk = e && e.target && e.target.type === "checkbox" ? e.target : null;
  const id = chk ? (chk.dataset.id || chk.id || "unknown") : "unknown";
  const now = Date.now();

  const sinceGlobal = now - (window.__lastToggleGlobal || 0);
  const sinceThis = now - (window.__lastToggleById[id] || 0);

  // Si la marcaci√≥n/desmarcaci√≥n ocurre demasiado r√°pido (global o por casilla), la bloqueamos
  if (sinceGlobal < FAST_MIN_MS || sinceThis < FAST_MIN_MS){
  // Revertir el cambio visual
  if (chk){
  // invertimos el check que intent√≥ hacer
  chk.checked = !chk.checked;
  // breve bloqueo para evitar rebotes
  chk.disabled = true;
  setTimeout(()=>{ try{ chk.disabled = false; }catch(_){} }, 400);
  }
  // Mostrar modal de revisi√≥n r√°pida
  try{ if (typeof window.showFastAlert === "function") window.showFastAlert(); }catch(_){}
  // No propagamos ni ejecutamos l√≥gica de guardado
  e && e.stopImmediatePropagation && e.stopImmediatePropagation();
  e && e.preventDefault && e.preventDefault();
  return false;
  }

  // Aceptamos el cambio y actualizamos relojes
  window.__lastToggleGlobal = now;
  window.__lastToggleById[id] = now;
  }catch(_){}

  // Llamar al handler original para que procese el cambio (render, guardar, etc.)
  if (typeof originalHandle === "function"){
  return originalHandle.apply(this, arguments);
  }
  return true;
  };

  // Re-vincular los listeners actuales para que usen el nuevo handler
  document.addEventListener("DOMContentLoaded", function(){
  try{
  document.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
  chk.removeEventListener('change', originalHandle);
  chk.removeEventListener('change', window.handleItemClick);
  chk.addEventListener('change', window.handleItemClick);
  });
  }catch(_){}
  });

  // --- 2) Flujo de PIN de manager: siempre mostrar input y validar antes de guardar ---
  const ADMIN_PASS = (typeof window.ADMIN_PASS !== "undefined") ? String(window.ADMIN_PASS) : null;

  // === showManagerConfirm (STRONG OVERRIDE: sin llamar al original) ===
window.showManagerConfirm = function(managerName){
  try{
  const mgr = managerName || "MANAGER";
  const card = document.getElementById("mgrConfirmCard");
  if (card) card.dataset.manager = mgr;

  const txt = document.getElementById("mgrConfirmText");
  if (txt) txt.textContent = `${mgr} ¬øest√° todo completado?`;

  // Mostrar PIN y enfocar
  const pinWrap = document.querySelector("#mgrConfirmModal .mgr-pin-input");
  const pinInput = document.getElementById("mgrPinInput");
  if (pinWrap) pinWrap.style.display = "block";
  if (pinInput){
  pinInput.removeAttribute("hidden");
  pinInput.setAttribute("aria-hidden","false");
  pinInput.value = "";
  setTimeout(()=>{ try{ pinInput.focus(); }catch(_){} }, 30);
  }

  // Rewire bot√≥n: clonar para eliminar listeners antiguos y estilo amarillo visible
  const yesBtn = document.getElementById("mgrConfirmYes");
  if (yesBtn){
  const clone = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(clone, yesBtn);
  clone.textContent = "Completado!";
  clone.type = "button";
  clone.classList.add("btn","primary");
  clone.style.background = "#FFC300";
  clone.style.borderColor = "#FFC300";
  clone.style.color = "#111";
  clone.style.fontWeight = "700";
  clone.addEventListener("click", function(ev){
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.confirmWithPin();
  return false;
  }, {capture:true});
  }

  // Abrir modal, cerrar selector de managers
  const modal = document.getElementById("mgrConfirmModal");
  if (modal) modal.classList.add("show");
  const m1 = document.getElementById("mgrModal");
  if (m1) m1.classList.remove("show");
  }catch(e){}
  return true;
};
window.showManagerConfirm = function(managerName){
  try{
  const mgr = managerName || "MANAGER";
  const card = document.getElementById("mgrConfirmCard");
  if (card) card.dataset.manager = mgr;

  const txt = document.getElementById("mgrConfirmText");
  if (txt) txt.textContent = `${mgr} ¬øest√° todo completado?`;

  // Mostrar PIN y enfocar
  const pinWrap = document.querySelector("#mgrConfirmModal .mgr-pin-input");
  const pinInput = document.getElementById("mgrPinInput");
  if (pinWrap) pinWrap.style.display = "block";
  if (pinInput){
  pinInput.removeAttribute("hidden");
  pinInput.setAttribute("aria-hidden","false");
  pinInput.value = "";
  setTimeout(()=>{ try{ pinInput.focus(); }catch(_){} }, 30);
  }

  // Rewire bot√≥n: clonar para eliminar listeners antiguos y estilo amarillo visible
  const yesBtn = document.getElementById("mgrConfirmYes");
  if (yesBtn){
  const clone = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(clone, yesBtn);
  clone.textContent = "Completado!";
  clone.type = "button";
  clone.classList.add("btn","primary");
  clone.style.background = "#FFC300";
  clone.style.borderColor = "#FFC300";
  clone.style.color = "#111";
  clone.style.fontWeight = "700";
  clone.addEventListener("click", function(ev){
  ev.preventDefault(); ev.stopImmediatePropagation();
  window.confirmWithPin();
  return false;
  }, {capture:true});
  }

  // Abrir modal, cerrar selector de managers
  const modal = document.getElementById("mgrConfirmModal");
  if (modal) modal.classList.add("show");
  const m1 = document.getElementById("mgrModal");
  if (m1) m1.classList.remove("show");
  }catch(e){}
  return true;
};

// Enlazar "Completado!" a confirmWithPin (handler √∫nico y final)
document.addEventListener("DOMContentLoaded", function(){
  try{
  var yesBtn = document.getElementById("mgrConfirmYes");
  if (yesBtn){
  var c = yesBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(c, yesBtn);
  c.addEventListener("click", function(ev){
  ev.preventDefault();
  ev.stopImmediatePropagation();
  return (window.confirmWithPin && window.confirmWithPin());
  }, {capture:true});
  }
  }catch(e){}
})();
</script>
<!-- ===== End Patch v17.1 ===== -->
<script>
(function(){
  function $(s){ return document.querySelector(s); }
  function ensurePinUI() {
  var pin = document.getElementById('mgrPinInput');
  if (!pin) return;
  try {
  pin.style.display = 'block';
  pin.removeAttribute('hidden');
  pin.setAttribute('aria-hidden','false');
  setTimeout(()=>pin.focus(), 50);
  } catch(e){}
  }
  var isSavingShift = false;
  var btn = document.getElementById('mgrConfirmYes');
  if (!btn) return;
  var btnClone = btn.cloneNode(true);
  btn.parentNode.replaceChild(btnClone, btn);
  btn = btnClone;
  function handleMgrConfirm(ev){
  ev.preventDefault();
  ev.stopImmediatePropagation();
  ensurePinUI();
  var pinInput = document.getElementById('mgrPinInput');
  var pin = (pinInput && pinInput.value ? String(pinInput.value).trim() : "");
  var ADMIN_PASS_EXPECTED = "050405";
  if (pin !== ADMIN_PASS_EXPECTED) {
  if (pinInput) { pinInput.focus(); pinInput.select && pinInput.select(); }
  try { toast("Ingresa la clave del manager para confirmar.","error"); } catch(e){ alert("Ingresa la clave del manager para confirmar."); }
  return false;
  }
  if (isSavingShift) return false;
  isSavingShift = true;
  btn.disabled = true;
  var managerName = (document.getElementById('mgrConfirmCard')?.dataset?.manager) || "Manager";
  try {
  if (typeof window.saveShift === "function") {
  window.saveShift(managerName);
  }
  } finally {
  setTimeout(function(){
  isSavingShift = false;
  btn.disabled = false;
  var modal = document.getElementById('mgrConfirmModal');
  if (modal) modal.classList.remove('show');
  if (pinInput) pinInput.value = "";
  }, 400);
  }
  return false;
  }
  btn.addEventListener('click', handleMgrConfirm, true);
  var pinInput = document.getElementById('mgrPinInput');
  if (pinInput){
  pinInput.addEventListener('keydown', function(e){
  if (e.key === 'Enter'){
  e.preventDefault();
  btn.click();
  }
  });
  }
  var mgrModal = document.getElementById('mgrConfirmModal');
  if (mgrModal){
  var obs = new MutationObserver(function(){
  if (mgrModal.classList.contains('show')) ensurePinUI();
  });
  obs.observe(mgrModal, { attributes:true, attributeFilter:['class'] });
  }
})();

/* ======= Enhancements: alert counting, history formatting, real-time i18n ======= */
let __alertCount = parseInt(localStorage.getItem("mc_alert_count")||"0",10);
let __pieAlertVisible = false;

function incAlertCount(){
  __alertCount = (__alertCount||0) + 1;
  localStorage.setItem("mc_alert_count", String(__alertCount));
}

function getAlertCount(){ return parseInt(localStorage.getItem("mc_alert_count")||"0",10); }
function resetAlertCount(){ __alertCount = 0; localStorage.setItem("mc_alert_count","0"); }

// Hook: when selecting employee, reset alert counter for a clean shift
const __orig_selectEmployee = (typeof selectEmployee==="function") ? selectEmployee : null;
if (__orig_selectEmployee){
  window.selectEmployee = function(name){
  resetAlertCount();
  __orig_selectEmployee(name);
  }
}

// Hook showFastAlert -> increments alerts
const __orig_showFastAlert = (typeof showFastAlert==="function") ? showFastAlert : null;
if (__orig_showFastAlert){
  window.showFastAlert = function(){
  incAlertCount();
  __orig_showFastAlert();
  }
}

// Tweak checkPiesAndAlert to increment on first show per expiration
const __orig_checkPiesAndAlert = (typeof checkPiesAndAlert==="function") ? checkPiesAndAlert : null;
if (__orig_checkPiesAndAlert){
  window.checkPiesAndAlert = function(){
  const wasVisible = __pieAlertVisible;
  __orig_checkPiesAndAlert();
  const isVisibleNow = document.getElementById("pieAlert").classList.contains("show");
  if (!wasVisible && isVisibleNow){
  incAlertCount();
  }
  __pieAlertVisible = isVisibleNow;
  }
}

// When acknowledging pie alert, mark not visible
const __orig_ackPieAlert = (typeof ackPieAlert==="function") ? ackPieAlert : null;
if (__orig_ackPieAlert){
  window.ackPieAlert = function(){
  __pieAlertVisible = false;
  __orig_ackPieAlert();
  }
}

// History formatter per-language
function fmtDateTime(ts, lng){
  try{
  const d = new Date(ts);
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  const yyyy = d.getFullYear();
  const monthShort = d.toLocaleString(lng==="en"?"en-US":"es-ES", {month:"short"});
  const day = d.toLocaleString(lng==="en"?"en-US":"es-ES", {day:"2-digit"});
  if (lng==="en"){
  return `${hh}:${mm}:${ss} ${monthShort} ${day}, ${yyyy}`;
  } else {
  // es: "hh:mm:ss 12 oct 2025"
  return `${hh}:${mm}:${ss} ${day} ${monthShort} ${yyyy}`;
  }
  }catch(_){ return ts; }
}

function renderHistoryBox(){
  const box = document.getElementById("historyBox");
  if (!box) return;
  const t = I18N[lang];
  const history = jget(SHIFT_HISTORY_KEY, []);
  box.innerHTML = "";
  if (!history.length){
  const empty = document.createElement("div");
  empty.className = "hist-item";
  empty.innerHTML = `<div class="h1">${t.historyEmpty}</div>`;
  box.appendChild(empty);
  return;
  }
  const arr = [...history].reverse();
  arr.forEach(rec => {
  const ts = fmtDateTime(rec.timestamp, lang);
  const statusTitle = (lang==="en") ? "SHIFT CONFIRMED ‚úÖ" : "TURNO CONFIRMADO ‚úÖ";
  const crewLbl = (lang==="en") ? "üë§ CREW -> " : "üë§ CREW -> ";
  const mgrLbl  = (lang==="en") ? "üë©‚Äçüíº MANAGER -> " : "üë©‚Äçüíº MANAGER -> ";
  const alertLbl= (lang==="en") ? "‚ö†Ô∏è ALERTS -> " : "‚ö†Ô∏è ALERTAS -> ";
  const div = document.createElement("div");
  div.className = "hist-item";
  div.innerHTML = `
  <div class="h1">${ts} - ${statusTitle}</div>
  <div>${crewLbl}${rec.employee||"‚Äî"}</div>
  <div>${mgrLbl}${rec.manager||"‚Äî"}</div>
  <div>${alertLbl}${rec.alerts==null?0:rec.alerts}</div>
  `;
  box.appendChild(div);
  });
}

// Re-render history when language changes (poll mc_lang key)
(function(){
  let __lastLang = getLang();
  setInterval(()=>{
  const current = getLang();
  if (current !== __lastLang){
  __lastLang = current;
  lang = current;
  try { renderHistoryBox(); } catch(_){}
  }
  }, 350);
})();

// Ensure the Show History button renders with the current language
(function(){
  const btn = document.getElementById("btnShowHistory");
  if (btn){
  btn.addEventListener("click", ()=>{
  try{ renderHistoryBox(); }catch(_){}
  });
  }
})();

// Include alerts in saved shift records
const __orig_saveShift = (typeof saveShift==="function") ? saveShift : null;
if (__orig_saveShift){
  window.saveShift = function(managerName){
  window.__pending_alerts_for_shift = getAlertCount();
  __orig_saveShift(managerName);
  }
}

const __orig_resetAllTasks = (typeof resetAllTasks==="function") ? resetAllTasks : null;
if (__orig_resetAllTasks){
  window.resetAllTasks = function(){
  if (typeof window.__pending_alerts_for_shift !== "undefined"){
  const history = jget(SHIFT_HISTORY_KEY, []);
  if (history.length){
  history[history.length-1].alerts = window.__pending_alerts_for_shift;
  jset(SHIFT_HISTORY_KEY, history);
  }
  delete window.__pending_alerts_for_shift;
  resetAlertCount();
  }
  __orig_resetAllTasks();
  }
}
/* ======= End Enhancements ======= */

</script>
<!-- Reemplazado por HISTX modal -->
<div aria-live="polite" id="closedOverlay">
<div aria-labelledby="closedTitle" aria-modal="true" class="closed-card" role="dialog">
<div class="logo">
<svg viewbox="0 0 272.7 238.5" xmlns="http://www.w3.org/2000/svg">
<path d="m195.8 17.933c23.3 0 42.2 98.3 42.2 219.7h34c0-130.7-34.3-236.5-76.3-236.5-24 0-45.2 31.7-59.2 81.5-14-49.8-35.2-81.5-59-81.5-42 0-76.2 105.7-76.2 236.4h34c0-121.4 18.7-219.6 42-219.6s42.2 90.8 42.2 202.8h33.8c0-112 19-202.8 42.3-202.8" fill="#fc0"></path>
</svg>
</div>
<h1 id="closedTitle">TIENDA CERRADA</h1>
<div class="date" id="closedDate">--</div>
<div class="time" id="closedTime">--:--:--</div>
<div class="hours" id="closedHours">Hora laboral<br/>5 AM ‚Äì 12 AM</div>
</div>
</div>
<script>
(() => {
  // ‚è∞ AHORA CON MINUTOS
  const OPEN_TIME  = "05:00";  // antes: const OPEN_HOUR = 5
  const CLOSE_TIME = "24:00";  // antes: const CLOSE_HOUR = 24 (puedes usar "18:45", "00:00", etc.)

  const overlay = document.getElementById("closedOverlay");

  // --- Utilidades de hora ---
  function parseHM(hm) {
  const [h, m] = hm.split(":").map(Number);
  return { h, m: Number.isFinite(m) ? m : 0 };
  }
  // Crea un Date con la hora:minuto de HOY (maneja 24:00 como 00:00 del d√≠a siguiente)
  function todayAt(base, hm) {
  const { h, m } = parseHM(hm);
  const d = new Date(base);
  if (h === 24 && m === 0) { // 24:00 => ma√±ana 00:00
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() + 1);
  } else {
  d.setHours(h, m, 0, 0);
  }
  return d;
  }
  function buildOpenClose(now) {
  const open  = todayAt(now, OPEN_TIME);
  let close  = todayAt(now, CLOSE_TIME);
  // Si el cierre es <= que la apertura, el rango cruza medianoche ‚Üí mover cierre al d√≠a siguiente
  if (close <= open) close = new Date(close.getTime() + 24 * 60 * 60 * 1000);
  return { open, close };
  }

  function isOpen(now) {
  const { open, close } = buildOpenClose(now);
  return now >= open && now < close;
  }

  function updateClock(now) {
  if (!overlay) return;
  const timeEl = overlay.querySelector(".time");
  const dateEl = overlay.querySelector(".date");
  if (timeEl) {
  const hh = String(now.getHours()).padStart(2, "0");
  const mm = String(now.getMinutes()).padStart(2, "0");
  const ss = String(now.getSeconds()).padStart(2, "0");
  timeEl.textContent = `${hh}:${mm}:${ss}`;
  }
  if (dateEl) {
  const opts = { day: "2-digit", month: "short", year: "numeric" };
  dateEl.textContent = now.toLocaleDateString("es-ES", opts).toLowerCase();
  }
  }

  function applyOverlayState(now) {
  if (!overlay) return;
  if (isOpen(now)) {
  overlay.style.display = "none";
  document.body.classList.remove("closed-locked");
  } else {
  overlay.style.display = "block";
  document.body.classList.add("closed-locked");
  }
  }

  function tick() {
  const now = new Date();
  updateClock(now);
  if (now.getSeconds() % 5 === 0) applyOverlayState(now); // puedes quitar el %5 si quieres precisi√≥n al segundo
  }

  const now = new Date();
  updateClock(now);
  applyOverlayState(now);
  setInterval(tick, 1000);
})();
</script>
<div class="lang-fab" id="langFab">üåê</div>
<script>
(() => {
  const LANG_KEY = "mc_lang";
  const btn = document.getElementById("langFab");
  if (!btn) return;

  function getLang() { return localStorage.getItem(LANG_KEY) || "es"; }
  function setLang(v) { localStorage.setItem(LANG_KEY, v); }

  function applyOverlayTexts(lang) {
  const tClosed = document.querySelector("#closedOverlay h1");
  const tHours  = document.querySelector("#closedOverlay .hours");
  if (tClosed) tClosed.textContent = (lang === "en") ? "STORE CLOSED" : "TIENDA CERRADA";
  if (tHours)  tHours.textContent  = (lang === "en") ? "Working hours: 5 AM ‚Äì 12 AM" : "Horario laboral: 5 AM ‚Äì 12 AM";
  }

  function reflectUI(lang) {
  btn.textContent = (lang === "en") ? "üá™üá∏" : "üá∫üá∏";
  // toggle slider visual if present
  const slider = document.getElementById("langSlider");
  if (slider) slider.classList.toggle("en", lang === "en"), slider.classList.toggle("es", lang === "es");
  applyOverlayTexts(lang);
  }

  function tryAppWideRefresh(lang) {
  // If the app exposes functions to re-render with i18n, use them; else reload.
  try {
  if (typeof window.applyLang === "function") { window.applyLang(lang); return; }
  if (typeof window.init === "function") { window.init(); return; }
  if (typeof window.renderAll === "function") { window.renderAll(); return; }
  } catch(e) {}
  // Fallback hard refresh to apply texts across the app
  setTimeout(() => location.reload(), 80);
  }

  // Init button
  reflectUI(getLang());

  btn.addEventListener("click", () => {
  const next = (getLang() === "es") ? "en" : "es";
  setLang(next);
  reflectUI(next);
  tryAppWideRefresh(next);
  });
})();
</script>

<!-- Injected: switch de idioma para overlay de tienda cerrada -->
</div>
  </div>
</div>

<!-- Injected: l√≥gica del switch de idioma para overlay (5 AM ‚Äì 12 AM) -->
<script>
(function(){
  // Helpers seguros si tu app ya define getLang/setLang/applyLanguage
  function getLang(){ try { return (window.getLang && window.getLang()) || localStorage.getItem('lang') || 'es'; } catch(e){ return 'es'; } }
  function setLang(v){ try { if (window.setLang) window.setLang(v); localStorage.setItem('lang', v); } catch(e){ localStorage.setItem('lang', v); } }
  function applyLangSafe(v){
  if (typeof window.applyLanguage === 'function'){ window.applyLanguage(v); }
  else {
  // Fallbacks comunes en tu app
  try { if (typeof initPies==='function') initPies(); } catch(e){}
  try { if (typeof renderItems==='function') renderItems(); } catch(e){}
  try { if (typeof updateAdminOwnerUI==='function') updateAdminOwnerUI(); } catch(e){}
  }
  }

  const overWrap = document.getElementById('overlayLangWrap');
  const overLS  = document.getElementById('overlayLangSlider');
  const inlineLS = document.getElementById('langSlider'); // el switch normal al lado de Admin, si existe

  function syncSwitchClasses(lang){
  const L = lang || getLang();
  [overLS, inlineLS].forEach(el=>{
  if (!el) return;
  el.classList.remove(L==='es'?'en':'es');
  el.classList.add(L);
  });
  }

  function applyClosedOverlayTexts(){
  var title = document.getElementById('closedTitle');
  var hours = document.getElementById('closedHours');
  var en = (getLang()==='en');
  if (title) title.textContent = en ? 'STORE CLOSED' : 'TIENDA CERRADA';
  if (hours) hours.innerHTML  = en ? 'BUSINESS HOURS<br/> 5 AM ‚Äì 12 AM' : 'HORA LABORAL<br/> 5 AM ‚Äì 12 AM';
  }

  function toggleLanguage(){
  const newLang = getLang()==='es' ? 'en' : 'es';
  setLang(newLang);
  applyLangSafe(newLang);
  applyClosedOverlayTexts();
  syncSwitchClasses(newLang);
  }

  if (overLS && !overLS.__bound){
  overLS.addEventListener('click', toggleLanguage);
  overLS.__bound = true;
  }
  if (inlineLS && !inlineLS.__mirrorBound){
  inlineLS.addEventListener('click', function(){
  setTimeout(function(){
  applyClosedOverlayTexts();
  syncSwitchClasses(getLang());
  }, 0);
  });
  inlineLS.__mirrorBound = true;
  }

  // Horario 5 AM ‚Äì 12 AM (cerrado fuera de ese rango)
  function isOpenNow(){
  const h = new Date().getHours();
  return (h >= 5 && h < 24);
  }
  function updateOverlayLangVisibility(){
  const open = isOpenNow();
  if (overWrap){
  overWrap.style.display = open ? 'none' : 'block';
  overWrap.setAttribute('aria-hidden', open ? 'true' : 'false');
  }
  if (inlineLS){
  inlineLS.style.visibility = open ? '' : 'hidden';
  }
  }

  document.addEventListener('DOMContentLoaded', function(){
  syncSwitchClasses(getLang());
  applyClosedOverlayTexts();
  updateOverlayLangVisibility();
  setInterval(updateOverlayLangVisibility, 30000);
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tag main page language switch parents
  document.querySelectorAll('.lang-slider').forEach(sl => {
  // if inside overlay, mark overlay wrapper; else main lang wrapper
  const inOverlay = sl.closest('.overlay, #overlay, .closed-overlay, .store-closed-overlay');
  const parent = sl.parentElement;
  if (inOverlay) {
  inOverlay.classList.add('overlay-lang-wrap');
  parent && parent.classList.add('overlay-lang-wrap');
  } else {
  parent && parent.classList.add('lang-switch-wrap');
  // also mark the nearest section to be safe
  const sec = sl.closest('section, div');
  if (sec) sec.classList.add('lang-switch-wrap');
  }
  });
});
</script>

<!-- === HISTX Modal (integrado desde mcd_timeline_final_fixed.html) === -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
/* Variables y Estilos Base */
:root{
  --bg:#0f1114; --bg-2:#14171b; --panel:#191c21; --panel-2:#1e2228;
  --line:#2a2f37; --text:#e9edf2; --muted:#a7afbd;
  --brand:#DA291C; --brand-2:#b72016; --gold:#F2C100;
  --ok:#79f0a5; --warn:#ffd36e;
}
*{box-sizing:border-box}

#btnShowHistory{
  background:var(--brand); border:2px solid var(--gold); color:#fff; padding:10px 18px;
  border-radius:12px; font-weight:800; cursor:pointer; box-shadow:0 0 0 4px rgba(242,193,0,.15), 0 10px 30px rgba(0,0,0,.4);
}
/* Modal */
.histx-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(6px);
  display:none; align-items:center; justify-content:center; z-index:1000 }
.histx-overlay.show{ display:flex }
.histx-modal{ width:min(1240px,96vw); max-height:90vh; height:min(90vh,940px);
  background:var(--panel); border:1px solid var(--line); border-radius:18px; overflow:hidden;
  display:flex; flex-direction:column; box-shadow:0 30px 80px rgba(0,0,0,.55) }
.histx-header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px;
  background:linear-gradient(180deg,#21262e,#191d23); border-bottom:1px solid var(--line) }
.histx-title{ display:flex; gap:10px; align-items:center; font-weight:900 }
.logo-dot{ width:10px; height:10px; border-radius:999px; background:var(--gold); box-shadow:0 0 0 3px rgba(242,193,0,.18) }
.histx-close{ all:unset; cursor:pointer; width:36px; height:36px; display:grid; place-items:center;
  border-radius:10px; border:1px solid var(--line); background:var(--panel-2); font-size:20px }
/* Scroll Vertical del Modal */
.histx- 

/* Filtros (mantenido) */
.histx-filters{ display:grid; gap:10px; background:var(--bg-2); border:1px solid var(--line); border-radius:14px; padding:10px }
.chipbar{ display:flex; gap:8px; flex-wrap:wrap }
.chip{ background:#1b1f25; border:1px solid #313744; color:#dfe6f0; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer }
.chip.active{ outline:2px solid var(--gold); background:#232935 }
.histx-filters-row{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px }
.histx-field{ display:flex; flex-direction:column; gap:6px; background:var(--panel-2); border:1px solid var(--line); border-radius:12px; padding:8px }
.histx-field label{ font-size:12px; color:var(--muted) }
.histx-field input,.histx-field select{ all:unset; background:#0b0c0e; border:1px solid var(--line); border-radius:8px; padding:8px 10px; font-size:14px }
.toggles{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
.switch{ display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted) }
.switch input{ width:42px; height:22px; appearance:none; background:#262b33; border:1px solid var(--line); border-radius:999px; position:relative; outline:none; cursor:pointer }
.switch input::after{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:999px; background:#cfd8e3; transition:left .15s }
.switch input:checked{ background:#2a3a2a; border-color:#3a5240 }
.switch input:checked::after{ left:22px }
.histx-actions{ display:flex; gap:10px; justify-content:flex-end }
.histx-btn{ all:unset; cursor:pointer; border-radius:10px; border:1px solid var(--line); padding:8px 12px; font-weight:800; font-size:13px }
.histx-btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand-2) }
.histx-btn.reset{ background:#111316; color:var(--text) }

/* ========================================================= */
/* Nuevo Timeline V10: Horizontal Waterfall con Scroll Dual */
/* ========================================================= */
.histx-timeline-wrap{
  /* Scroll Horizontal y Vertical en el Recuadro (REQ) */
  overflow: auto; 
  border:1px solid var(--line); 
  border-radius:16px; 
  background:var(--bg);
  position:relative; 
  max-height: 450px; /* Altura m√°xima para forzar scroll vertical */
  min-height:300px;
  cursor:default; 
  padding: 15px;
}

.histx-timeline{
  position:relative; 
  display:flex; 
  flex-direction:row; /* Flujo Horizontal (D√≠as) */
  align-items:flex-start;
  width: max-content; /* Permite el scroll horizontal */
  gap: 25px; /* Espacio entre columnas de d√≠as */
}

/* Columna de D√≠a */
.histx-day-column {
  min-width: 380px;
  max-width: 420px;
  padding: 10px;
  background: var(--bg-2);
  border: 1px solid var(--line);
  border-radius: 12px;
  min-height: 400px; /* Forzar el scroll vertical en el wrap */
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.day-header {
  border-bottom: 2px solid var(--brand);
  padding-bottom: 8px;
  margin-bottom: 5px;
  position: sticky; /* Fija el encabezado del d√≠a al hacer scroll vertical DENTRO de la columna */
  top: 0;
  background: var(--bg-2);
  z-index: 2;
}

.day-header h3 {
  margin: 0;
  font-size: 16px;
  color: var(--gold);
  display: flex;
  align-items: center;
  gap: 8px;
}
.day-header span {
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
}

/* Item de Turno (Vertical dentro del flujo Horizontal) */
.histx-item {
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,.1);
}

.item-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  border-bottom: 1px dashed #2a2f37;
  padding-bottom: 8px;
}
.histx-time { 
  font-weight:900; 
  color:var(--brand); 
  font-size: 2.6em; /* HORAS GRANDES */
  line-height: 1;
} 

.item-data-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.data-field {
  font-size: 13px;
}
.data-field strong { 
  display: block;
  color: var(--muted); 
  font-weight: 500;
  margin-bottom: 2px;
}
.data-field span { 
  font-weight: 700; 
}

.shift-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 900;
  font-size: 11px;
  align-self: flex-start;
}
.shift-badge.am{ background:#3e3212; color:#ffe28a; }
.shift-badge.pm{ background:#3a1111; color:#ffd6d1; }
.shift-badge.ok { background: #1f3b25; color: var(--ok); }
.shift-badge.warn { background: #3b321f; color: var(--warn); }

/* Indicador AHORA (Vertical fijo en el flujo horizontal) */
.histx-now-marker {
  position: sticky;
  left: 15px; /* Se fija al inicio del scroll horizontal */
  top: 0;
  z-index: 10;
  width: 2px;
  background: var(--gold);
  pointer-events: none;
  height: 100%;
}
.histx-now-marker::after {
  content: "AHORA";
  position: absolute;
  top: -15px;
  left: 5px;
  background: var(--gold);
  color: var(--bg);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 900;
  white-space: nowrap;
  box-shadow: 0 2px 5px rgba(0,0,0,.3);
}

/* Stats & Charts (mantenido) */
.histx-stats{ display:grid; gap:12px }
.stat-cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px }
.stat-card{ background:var(--bg-2); border:1px solid var(--line); border-radius:14px; padding:12px }
.stat-card .label{ font-size:12px; color:var(--muted) }
.stat-card .value{ font-size:18px; font-weight:900; margin-top:4px }
.charts{ display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px }
.chart-box{ background:var(--bg-2); border:1px solid var(--line); border-radius:14px; padding:10px; display:flex; flex-direction:column; height:260px }
.chart-box canvas{ flex:1 }
.chart-header{ display:flex; justify-content:space-between; align-items:center }
.chart-header h4{ margin:0; font-size:13px; color:var(--muted) }
.chart-export{ all:unset; cursor:pointer; font-size:18px; line-height:1; color:var(--gold) }
.chart-export:hover{ filter:brightness(1.3) }

/* Footer */
.histx-footer{ display:flex; justify-content:space-between; align-items:center; padding:10px 14px; border-top:1px solid var(--line); background:var(--bg-2) }
.histx-count{ font-size:13px; color:#d4d7dd }
.histx-right{ display:flex; gap:10px; flex-wrap:wrap; row-gap:6px }
.histx-btn.export,.histx-btn.capture{ background:#1b1e23; color:#fff }
</style>
  <div class="histx-overlay" id="historyModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="histx-modal" role="document">
  <div class="histx-header">
  <div class="histx-title"><span class="logo-dot"></span> Historial de Turnos ‚Äî McDonald‚Äôs #19694</div>
  <button class="histx-close" id="histxClose" aria-label="Cerrar">‚úñ</button>
  </div>

  <div class="histx-body">
  <section class="histx-filters">
  <div class="chipbar" id="quickChips">
  <div class="chip" data-q="today">Hoy</div>
  <div class="chip" data-q="yesterday">Ayer</div>
  <div class="chip" data-q="last24">√öltimas 24h</div>
  <div class="chip" data-q="last7d">√öltimos 7 d√≠as</div>
  </div>

  <div class="histx-filters-row">
  <div class="histx-field"><label>Desde</label><input type="date" id="histxFrom"></div>
  <div class="histx-field"><label>Hasta</label><input type="date" id="histxTo"></div>
  <div class="histx-field">
  <label>Turno</label>
  <select id="histxShift">
  <option value="all">Todos</option>
  <option value="am">Ma√±ana</option>
  <option value="pm">Tarde</option>
  </select>
  </div>
  <div class="histx-field"><label>Crew / Empleado</label><input type="text" id="histxCrew" placeholder="Buscar por nombre"></div>
  <div class="histx-field"><label>Manager</label><input type="text" id="histxMgr" placeholder="Buscar por manager"></div>
  </div>

  <div class="toggles">
  <label class="switch"><input type="checkbox" id="onlyConfirmed"><span>Solo confirmados (‚â•90%)</span></label>
  </div>

  <div class="histx-actions">
  <button class="histx-btn reset" id="histxReset">üîÑ Restablecer</button>
  <button class="histx-btn primary" id="histxApply">Aplicar</button>
  </div>
  </section>

  <section class="histx-timeline-wrap" id="timelineWrap">
  <div class="histx-timeline" id="histxTimeline">
  <div class="histx-now-marker" id="histxNow"></div>
  </div>
  </section>

  <div class="histx-empty" id="histxEmpty" style="display:none;">Sin turnos para mostrar.</div>

  <section class="histx-stats">
  <div class="stat-cards">
  <div class="stat-card"><div class="label">Total turnos (rango)</div><div class="value" id="stTotal">0</div></div>
  <div class="stat-card"><div class="label">Total alertas</div><div class="value" id="stAlerts">0</div></div>
  <div class="stat-card"><div class="label">Promedio alertas/turno</div><div class="value" id="stAlertsAvg">0</div></div>
  <div class="stat-card"><div class="label">Tasa completion</div><div class="value" id="stCompletion">0%</div></div>
  <div class="stat-card"><div class="label">Empleados √∫nicos</div><div class="value" id="stUniqueCrew">0</div></div>
  <div class="stat-card"><div class="label">Managers √∫nicos</div><div class="value" id="stUniqueMgr">0</div></div>
  </div>

  <div class="charts">
  <div class="chart-box">
  <div class="chart-header"><h4>Turnos por fecha</h4><button class="chart-export" data-target="chByDate">üì•</button></div>
  <canvas id="chByDate"></canvas>
  </div>
  <div class="chart-box">
  <div class="chart-header"><h4>AM vs PM</h4><button class="chart-export" data-target="chByShift">üì•</button></div>
  <canvas id="chByShift"></canvas>
  </div>
  <div class="chart-box">
  <div class="chart-header"><h4>Top 5 empleados (tareas)</h4><button class="chart-export" data-target="chCrewTasks">üì•</button></div>
  <canvas id="chCrewTasks"></canvas>
  </div>
  <div class="chart-box">
  <div class="chart-header"><h4>Top 5 managers (turnos)</h4><button class="chart-export" data-target="chMgrTurns">üì•</button></div>
  <canvas id="chMgrTurns"></canvas>
  </div>
  </div>
  </section>
  </div>

  <div class="histx-footer">
  <div class="histx-count" id="histxCount">0 turnos</div>
  <div class="histx-right">
  <button class="histx-btn export" id="histxExportCSV">Exportar CSV</button>
  <button class="histx-btn capture" id="histxCapture">Compartir WhatsApp</button>
  <button class="histx-btn primary" id="histxClose2">Cerrar</button>
  </div>
  </div>
  </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const pad = (n)=>String(n).padStart(2,'0');
  const todayISO = ()=>{ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); };

  
  /* ===== Datos reales desde mc_shift_history ===== */
  const SHIFT_HISTORY_KEY = window.SHIFT_HISTORY_KEY || "mc_shift_history";
  function toLocalISODate(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
  }
  function normalizeDateKey(key){
  try{
  if(!key) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(key)) return key;
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(key)){
  const parts = key.split('/');
  const a = parseInt(parts[0],10), b = parseInt(parts[1],10), c = parts[2];
  const lang = (typeof window.getLang==='function' ? window.getLang() : (window.lang||'es'));
  let day, mon;
  if (lang === 'en'){ mon = a; day = b; } else { day = a; mon = b; }
  const mm = String(mon).padStart(2,'0');
  const dd = String(day).padStart(2,'0');
  return `${c}-${mm}-${dd}`;
  }
  const d = new Date(key);
  if(!isNaN(d)){
  return toLocalISODate(d);
  }
  }catch(_){}
  return null;
  }

  function toHHMM(d){
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
  }

  function mapRecord(r){
  try{
  const ts = new Date(r.timestamp);
  const dateISO = normalizeDateKey(r.dateKey) || toLocalISODate(ts);
  const hhmm = toHHMM(ts);
  const shift = ts.getHours() >= 14 ? "pm" : "am";
  const crew = r.employee || r.emp || "‚Äî";
  const manager = r.manager || "‚Äî";
  const alerts = (typeof r.alerts === "number") ? r.alerts : 0;
  const tasksTotal = Number(r.totalTasks || 0);
  const tasksDone  = Number(r.completedTasks || 0);
  const taskDetails = Array.isArray(r.items) ? r.items.map(i=>({name: i.text || i.name || "Tarea", status: (i.doneBy ? "OK" : "PEND")})) : [];
  return { id: `${dateISO}-${hhmm}-${crew}`, ts: ts.getTime(), dateISO, hhmm, shift, crew, manager, alerts, tasksTotal, tasksDone, taskDetails };
  }catch(_){
  return null;
  }
  }

  window.histxLoad = function(){
  let raw=[];
  try{ raw = JSON.parse(localStorage.getItem(SHIFT_HISTORY_KEY) || '[]'); }catch(_){ raw=[]; }
  const mapped = raw.map(mapRecord).filter(Boolean);
  mapped.sort((a,b)=>b.ts - a.ts);
  return mapped;
  };
/* ===== DOM ===== */
  const MODAL = $("historyModal");
  const TIMELINE_WRAP = $("timelineWrap");
  const TIMELINE = $("histxTimeline");
  const EMPTY = $("histxEmpty");
  const COUNT = $("histxCount");
  const NOW_ELEM = $("histxNow");

  /* ===== Abrir/Cerrar ===== */
  $("btnShowHistory").addEventListener("click", openModal);
  $("histxClose").addEventListener("click", closeModal);
  $("histxClose2").addEventListener("click", closeModal);
  MODAL.addEventListener("click", e=>{ if(e.target===MODAL) closeModal(); });
  document.addEventListener("keydown", e=>{ if(e.key==="Escape" && MODAL.classList.contains("show")) closeModal(); });

  function openModal(){
  setQuick("today");
  MODAL.classList.add("show");
  document.documentElement.style.overflow = "hidden";
  applyAndRender();
  // Scroll inicial al inicio (izquierda) para ver el indicador AHORA
  setTimeout(() => {
  TIMELINE_WRAP.scrollLeft = 0;
  TIMELINE_WRAP.scrollTop = 0;
  }, 150);
  }
  function closeModal(){
  MODAL.classList.remove("show");
  document.documentElement.style.overflow = "";
  }

  /* ===== Filtros (mantenido) ===== */
  const chips = Array.from($("quickChips").querySelectorAll(".chip"));
  chips.forEach(ch=> ch.addEventListener("click", ()=>{
  chips.forEach(c=>c.classList.remove("active")); ch.classList.add("active");
  setQuick(ch.dataset.q); applyAndRender();
  }));
  function setQuick(code){
  const t0 = new Date(); t0.setHours(0,0,0,0);
  const set = (f,t)=>{ $("histxFrom").value=f; $("histxTo").value=t; };
  if(code==="today"){ set(t0.toISOString().slice(0,10), t0.toISOString().slice(0,10)); }
  else if(code==="yesterday"){ const y=new Date(t0); y.setDate(y.getDate()-1); const iso=y.toISOString().slice(0,10); set(iso,iso); }
  else if(code==="last24"){ const from=new Date(Date.now()-24*3600*1000).toISOString().slice(0,10); set(from,todayISO()); }
  else if(code==="last7d"){ const from=new Date(Date.now()-7*24*3600*1000).toISOString().slice(0,10); set(from,todayISO()); }
  }

  $("histxApply").addEventListener("click", applyAndRender);
  $("histxReset").addEventListener("click", ()=>{
  $("histxFrom").value=""; $("histxTo").value="";
  $("histxShift").value="all"; $("histxCrew").value=""; $("histxMgr").value="";
  $("onlyConfirmed").checked=false; chips.forEach(c=>c.classList.remove("active"));
  applyAndRender();
  });

  function applyFilters(data){
  const from = $("histxFrom").value ? new Date($("histxFrom").value+"T00:00:00") : null;
  const to  = $("histxTo").value  ? new Date($("histxTo").value+"T23:59:59") : null;
  const sh  = $("histxShift").value;
  const crew = $("histxCrew").value.trim().toLowerCase();
  const mgr  = $("histxMgr").value.trim().toLowerCase();
  const confirmed = $("onlyConfirmed").checked;

  return data.filter(it=>{
  const d=new Date(it.ts);
  if(from && d<from) return false;
  if(to && d>to) return false;
  if(sh!=="all" && it.shift!==sh) return false;
  if(crew && !it.crew.toLowerCase().includes(crew)) return false;
  if(mgr && !it.manager.toLowerCase().includes(mgr)) return false;
  if(confirmed && !(it.tasksDone >= Math.floor(it.tasksTotal*0.9))) return false;
  return true;
  });
  }
  
  function updateNowIndicator(){
  const fromVal = $("histxFrom").value;
  const toVal = $("histxTo").value;
  const today = new Date();
  const todayISO = toLocalISODate(today);
  
  let shouldShow = true;
  if(toVal && toVal < todayISO){ shouldShow = false; }
  if(fromVal && fromVal > todayISO){ shouldShow = false; }
  
  NOW_ELEM.style.display = shouldShow ? 'flex' : 'none';
  }

/* ===== Nuevo Timeline Render (Horizontal Waterfall) ===== */
  function itemHTML(it){
  const isCompleted = it.tasksDone >= Math.floor(it.tasksTotal*0.9);
  const statusText = isCompleted ? "Completado" : "Revisi√≥n";
  const statusClass = isCompleted ? 'ok' : 'warn';
  const shiftBadgeTxt = it.shift==="am" ? "Ma√±ana" : "Tarde";
  const shiftBadgeCls = it.shift==="am" ? "am" : "pm";

  return `<div class="histx-item" data-ts="${it.ts}">
  <div class="item-header-row">
  <span class="histx-time">${it.hhmm}</span>
  <span class="shift-badge ${shiftBadgeCls}">${shiftBadgeTxt}</span>
  </div>
  <div class="item-data-grid">
  <div class="data-field">
  <strong>Crew</strong>
  <span style="color:var(--text);">${it.crew}</span>
  </div>
  <div class="data-field">
  <strong>Manager</strong>
  <span style="color:#88c0d0;">${it.manager}</span>
  </div>
  <div class="data-field">
  <strong>Tareas</strong>
  <span>${it.tasksDone}/${it.tasksTotal}</span>
  </div>
  <div class="data-field">
  <strong>Alertas</strong>
  <span style="color:var(--warn);">${it.alerts}</span>
  </div>
  </div>
  <div style="margin-top: 10px; border-top: 1px dashed #2a2f37; padding-top: 8px;">
  <span class="shift-badge ${statusClass}">${statusText}</span>
  </div>
  </div>`;
  }

  function renderTimeline(list){
  // Conservar el indicador AHORA
  const nowIndicator = NOW_ELEM.outerHTML; 
  TIMELINE.innerHTML = nowIndicator; // Limpiar contenido anterior, re-insertar el NOW

  // 1. Agrupar por fecha
  const grouped = list.reduce((acc, it) => {
  const date = it.dateISO;
  if (!acc[date]) acc[date] = [];
  acc[date].push(it);
  return acc;
  }, {});

  // 2. Ordenar fechas (columnas) de m√°s reciente (izquierda) a m√°s antiguo (derecha)
  const sortedDates = Object.keys(grouped).sort().reverse();
  
  if(!sortedDates.length){ EMPTY.style.display="block"; COUNT.textContent="0 turnos"; return; }
  EMPTY.style.display="none";

  const frag = document.createDocumentFragment();
  let totalItems = 0;

  sortedDates.forEach(date => {
  // Ordenar items (turnos) dentro de cada d√≠a, de m√°s reciente a m√°s antiguo (top-down)
  const sortedItems = grouped[date].sort((a,b)=>b.ts - a.ts);
  totalItems += sortedItems.length;

  const dateObj = new Date(date + "T00:00:00");
  const dayName = dateObj.toLocaleDateString("es-ES", { weekday: 'long' });
  const dateShort = dateObj.toLocaleDateString("es-ES", { day: '2-digit', month: 'short' });

  let columnHtml = `<div class="histx-day-column" data-date="${date}">
  <div class="day-header">
  <h3>${dayName}<span>${dateShort}</span></h3>
  </div>`;
  
  sortedItems.forEach(it => {
  columnHtml += itemHTML(it);
  });

  columnHtml += `</div>`;
  
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = columnHtml.trim();
  frag.appendChild(tempDiv.firstChild);
  });

  TIMELINE.appendChild(frag);
  
  COUNT.textContent = `${totalItems} turno${totalItems!==1?'s':''}`;
  }

  /* ===== Stats & Charts (mantenido) ===== */
  let chByDate=null, chByShift=null, chCrewTasks=null, chMgrTurns=null;
  function computeStats(list){
  const total=list.length;
  const alerts=list.reduce((a,b)=>a+b.alerts,0);
  const done=list.reduce((a,b)=>a+b.tasksDone,0);
  const tot=list.reduce((a,b)=>a+b.tasksTotal,0);
  const completion = tot? Math.round(done/tot*100):0;
  const uCrew=new Set(list.map(x=>x.crew)).size;
  const uMgr=new Set(list.map(x=>x.manager)).size;

  $("stTotal").textContent=total;
  $("stAlerts").textContent=alerts;
  $("stAlertsAvg").textContent= total? (alerts/total).toFixed(2):"0";
  $("stCompletion").textContent=completion+"%";
  $("stUniqueCrew").textContent=uCrew;
  $("stUniqueMgr").textContent=uMgr;

  const byDate={}, shift={am:0,pm:0}, crew={}, mgr={};
  list.forEach(it=>{
  byDate[it.dateISO]=(byDate[it.dateISO]||0)+1;
  shift[it.shift]++; crew[it.crew]=(crew[it.crew]||0)+it.tasksDone;
  mgr[it.manager]=(mgr[it.manager]||0)+1;
  });
  return {
  byDateLabels: Object.keys(byDate).sort(),
  byDateData: Object.keys(byDate).sort().map(k=>byDate[k]),
  shiftData: [shift.am||0, shift.pm||0],
  crewTop: Object.entries(crew).sort((a,b)=>b[1]-a[1]).slice(0,5),
  mgrTop: Object.entries(mgr).sort((a,b)=>b[1]-a[1]).slice(0,5)
  };
  }

  function renderCharts(list){
  const s = computeStats(list);
  const ctx1=$("chByDate").getContext("2d");
  const ctx2=$("chByShift").getContext("2d");
  const ctx3=$("chCrewTasks").getContext("2d");
  const ctx4=$("chMgrTurns").getContext("2d");
  try{chByDate?.destroy();chByShift?.destroy();chCrewTasks?.destroy();chMgrTurns?.destroy();}catch(e){}

  chByDate = new Chart(ctx1,{
  type:"bar", data:{ labels:s.byDateLabels, datasets:[{ data:s.byDateData, backgroundColor:"#DA291C" }] },
  options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
  });
  chByShift = new Chart(ctx2,{
  type:"doughnut", data:{ labels:["AM","PM"], datasets:[{ data:s.shiftData, backgroundColor:["#F2C100","#DA291C"] }] },
  options:{ plugins:{legend:{labels:{color:"#fff"}}} }
  });
  chCrewTasks = new Chart(ctx3,{
  type:"bar", data:{ labels:s.crewTop.map(x=>x[0]), datasets:[{ data:s.crewTop.map(x=>x[1]), backgroundColor:"#4CAF50" }] },
  options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
  });
  chMgrTurns = new Chart(ctx4,{
  type:"bar", data:{ labels:s.mgrTop.map(x=>x[0]), datasets:[{ data:s.mgrTop.map(x=>x[1]), backgroundColor:"#607D8B" }] },
  options:{ plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,ticks:{precision:0}} } }
  });
  }

  // Eventos de exportaci√≥n y captura (mantenido)
  document.addEventListener("click", (e)=>{
  const btn = e.target.closest(".chart-export");
  if(!btn) return;
  const id = btn.dataset.target;
  const canvas = $(id);
  const a=document.createElement("a");
  a.download=id+".png"; a.href=canvas.toDataURL("image/png"); a.click();
  });

  $("histxExportCSV").addEventListener("click", ()=>{
  const filtered = applyFilters(sample).sort((a,b)=>b.ts-a.ts); 
  if(!filtered.length){ alert("No hay turnos para exportar."); return; }
  const header = ["Fecha","Hora","Turno","Crew","Manager","Alertas","Tareas_Hechas","Tareas_Totales"];
  const rows = filtered.map(it=>[it.dateISO,it.hhmm,it.shift,`"${it.crew}"`,`"${it.manager}"`,it.alerts,it.tasksDone,it.tasksTotal].join(","));
  const csv = [header.join(","),...rows].join("\\r\\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="historial_turnos.csv"; a.click(); URL.revokeObjectURL(url);
  });

  $("histxCapture").addEventListener("click", ()=>{
  html2canvas(document.querySelector(".histx-modal"),{backgroundColor:null,scale:2}).then(canvas=>{
  canvas.toBlob(()=>{
  const msg = encodeURIComponent("üìã Historial de turnos ‚Äî McDonald‚Äôs #19694");
  const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
  const url = isMobile ? `whatsapp://send?text=${msg}` : `https://wa.me/?text=${msg}`;
  window.open(url,"_blank");
  });
  });
  });

  /* ===== Render maestro ===== */
  function applyAndRender(){
  const data = (window.histxLoad ? window.histxLoad() : []);
  const list = applyFilters(data);
  renderTimeline(list);
  renderCharts(list);
  updateNowIndicator(); 
  }

})();
</script>
<!-- === /HISTX Modal === -->

<script>
// Patch saveShift to refresh HISTX modal immediately after saving
(function(){
  function patch(){
  try{
  if (typeof window.saveShift === 'function' && !window.saveShift.__histxPatched){
  const __orig = window.saveShift;
  const wrapper = function(){
  const res = __orig.apply(this, arguments);
  try{ if (window.histxRefresh) window.histxRefresh(); }catch(_){}
  return res;
  };
  wrapper.__histxPatched = true;
  window.saveShift = wrapper;
  }
  }catch(_){}
  }
  if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', patch);
  } else { patch(); }
})();
</script>

<script>
// === Anti-trampa v5 (listener en capture, no rompe la app) ===
(function(){
  const TH = window.FAST_MIN_MS || 2000;
  let lastGlobal = 0;
  const lastById = Object.create(null);
  document.addEventListener('change', function(e){
  try{
  const target = e && e.target;
  if(!(target && target.type === 'checkbox')) return;
  const id = target.dataset.id || target.id || 'unknown';
  const now = Date.now();
  const fastGlobal = (now - lastGlobal) < TH;
  const fastThis  = (now - (lastById[id]||0)) < TH;
  if (fastGlobal || fastThis){
  target.checked = !target.checked;
  try{ if (typeof window.showFastAlert === "function") window.showFastAlert(); }catch(_){}
  e.stopImmediatePropagation();
  e.preventDefault();
  return false;
  }
  lastGlobal = now;
  lastById[id] = now;
  }catch(_){}
  }, true);
})();
</script>

<script>
// === v5: auto-refresh del historial (jset + storage) ===
(function(){
  const KEY = (typeof window.SHIFT_HISTORY_KEY!=="undefined") ? window.SHIFT_HISTORY_KEY : "mc_shift_history";
  const originalJset = window.jset;
  window.jset = function(k, v){
  try{
  if (typeof originalJset === "function") originalJset(k, v);
  else localStorage.setItem(k, JSON.stringify(v));
  }catch(e){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  try{
  if(k === KEY && typeof window.histxRefresh === "function"){
  setTimeout(window.histxRefresh, 0);
  }
  }catch(_){}
  };
  window.addEventListener("storage", function(ev){
  if (ev && ev.key === KEY){
  try{ if (typeof window.histxRefresh === "function") window.histxRefresh(); }catch(_){}
  }
  });
})();
</script>

<script>
// === v5: deduplicaci√≥n suave por (fecha,hora,crew,manager) ===
(function(){
  const KEY = (typeof window.SHIFT_HISTORY_KEY!=="undefined") ? window.SHIFT_HISTORY_KEY : "mc_shift_history";
  function isSameSlot(a,b){
  try{
  const da = new Date(a.timestamp), db = new Date(b.timestamp);
  return a.employee===b.employee && a.manager===b.manager &&
  da.getFullYear()===db.getFullYear() && da.getMonth()===db.getMonth() &&
  da.getDate()===db.getDate() && da.getHours()===db.getHours();
  }catch(_){ return false; }
  }
  if (typeof window.saveShift === "function"){
  const oldSave = window.saveShift;
  window.saveShift = function(managerName){
  const before = (JSON.parse(localStorage.getItem(KEY)||"[]"));
  const numBefore = before.length;
  const res = oldSave.apply(this, arguments);
  try{
  const after = (JSON.parse(localStorage.getItem(KEY)||"[]"));
  if (after.length > numBefore){
  const last = after[after.length-1];
  for (let i=0;i<after.length-1;i++){
  if (isSameSlot(after[i], last)){
  after.splice(after.length-1,1);
  localStorage.setItem(KEY, JSON.stringify(after));
  if (window.toast) toast("Turno ya registrado","warn");
  break;
  }
  }
  }
  }catch(_){}
  try{ if (typeof window.histxRefresh==="function") window.histxRefresh(); }catch(_){}
  return res;
  };
  }
})();
</script>

<script>
// v6: al abrir el modal de historial, posiciona al inicio y deja que el usuario baje a los gr√°ficos
(function(){
  function ensureTopOnOpen(){
  try{
  const modal = document.querySelector(".histx-modal");
  const overlay = document.getElementById("historyModal");
  if(!modal || !overlay) return;
  const obs = new MutationObserver(()=>{
  const visible = overlay.classList.contains("show") || overlay.style.display==="flex";
  if(visible){
  modal.scrollTop = 0;  // empieza arriba para que el usuario deslice hacia gr√°ficos
  }
  });
  obs.observe(overlay, { attributes:true, attributeFilter:["class","style"] });
  }catch(_){}
  }
  if (document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", ensureTopOnOpen);
  } else {
  ensureTopOnOpen();
  }
})();
</script>

<footer style="text-align:center; margin:28px auto 22px; color:#b8bcc6; font-size:13px; max-width:820px;">
  <p>Privacy (Updated) ¬∑ California Privacy Notice ¬∑ Consumer Health Data</p>
  <p>Terms & Conditions ¬∑ Accessibility ¬∑ Do Not Sell or Share My Personal Information</p>
  <p style="margin-top:10px;display:flex;gap:6px;align-items:center;justify-content:center;">
  <svg viewBox="0 0 272.7 238.5" width="20" fill="#FFC72C" aria-hidden="true"><path d="m195.8 17.9c23.3 0 42.2 98.3 42.2 219.7h34c0-130.7-34.3-236.5-76.3-236.5-24 0-45.2 31.7-59.2 81.5-14-49.8-35.2-81.5-59-81.5-42 0-76.2 105.7-76.2 236.4h34c0-121.4 18.7-219.6 42-219.6s42.2 90.8 42.2 202.8h33.8c0-112 19-202.8 42.3-202.8"/></svg>
  ¬© 2017 ‚Äì 2025 McDonald's. All Rights Reserved
  </p>
</footer>

<script>
/* ==== Enhancements v7: Inactivity, i18n placeholders, overlay-lang visibility, toggle polish, CRUD employees ==== */

// Inactivity auto-logout for employee (1 minute without interaction)
(function(){
  const INACTIVITY_MS = 60*1000;
  let inactivityTimer;
  function isEmployeeActive(){ return !!localStorage.getItem(EMP_ACTIVE_KEY); }
  function resetInactivityTimer(){
  if(!isEmployeeActive()) return;
  localStorage.setItem(EMP_LAST_ACTIVITY, Date.now());
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
  try { toast("‚è±Ô∏è Sesi√≥n cerrada por inactividad.", "error"); } catch(_){}
  localStorage.removeItem(EMP_ACTIVE_KEY);
  const float = document.getElementById("empFloat"); if(float) float.style.display = "none";
  updateAdminOwnerUI && updateAdminOwnerUI();
  }, INACTIVITY_MS);
  }
  ["click","scroll","keydown","touchstart"].forEach(evt => {
  window.addEventListener(evt, resetInactivityTimer, {passive:true});
  });
  // Kick off
  setTimeout(resetInactivityTimer, 500);
})();

// Language slider visual states (ES/EN)
(function(){
  function applyLangExtras(){
  var l = getLang ? getLang() : (localStorage.getItem(LANG_KEY)||"es");
  var slider = document.getElementById("langSlider");
  if(slider){
  slider.classList.toggle("en", l==="en");
  slider.classList.toggle("es", l!=="en");
  }
  // dynamic placeholders
  var uLabel = (l==="en") ? "Username" : "Usuario";
  var pLabel = (l==="en") ? "Password" : "Contrase√±a";
  var au = document.getElementById("adminUser"); if(au) au.placeholder = uLabel;
  var ap = document.getElementById("adminPass"); if(ap) ap.placeholder = pLabel;
  var ou = document.getElementById("ownerUser"); if(ou) ou.placeholder = uLabel;
  var op = document.getElementById("ownerPass"); if(op) op.placeholder = pLabel;
  // panel labels (Admin -> Manager display only)
  var adminBtn = document.getElementById("btnAdminInline");
  if(adminBtn){ adminBtn.lastChild && (adminBtn.lastChild.nodeType===3) ? adminBtn.lastChild.nodeValue="Manager" : null; }
  }
  // Hook existing slider
  var slider = document.getElementById("langSlider");
  if(slider){
  slider.addEventListener("click", function(){
  // toggle language storage used by the app
  var l = getLang ? getLang() : (localStorage.getItem(LANG_KEY)||"es");
  l = (l==="es") ? "en" : "es";
  setLang ? setLang(l) : localStorage.setItem(LANG_KEY,l);
  if(typeof applyLanguage === "function"){ try{ applyLanguage(l); }catch(e){} }
  applyLangExtras();
  });
  }
  // Initial apply
  document.addEventListener("DOMContentLoaded", applyLangExtras);
  window.addEventListener("load", applyLangExtras);
})();

// Overlay language button visibility based on store hours (hide when open)
(function(){
  const OPEN_HOUR = 5;  // 5 AM
  const CLOSE_HOUR = 24; // 12 AM
  function isOpen(){
  const h = new Date().getHours();
  return (h >= OPEN_HOUR && h < CLOSE_HOUR);
  }
  function updateOverlayLang(){
  const el = document.getElementById("overlayLangWrap") || document.getElementById("overlay-lang-wrap");
  if(!el) return;
  el.style.display = isOpen() ? "none" : "block";
  }
  setInterval(updateOverlayLang, 30000);
  document.addEventListener("DOMContentLoaded", updateOverlayLang);
  window.addEventListener("load", updateOverlayLang);
})();

// Owner tools visibility
(function(){
  function syncOwnerTools(){
  const tools = document.getElementById("ownerTools");
  if(!tools) return;
  tools.style.display = isOwner && isOwner() ? "block" : "none";
  }
  document.addEventListener("DOMContentLoaded", syncOwnerTools);
  window.addEventListener("storage", syncOwnerTools);
})();

// CRUD simple for employees & managers (stored in localStorage, and mutates existing arrays)
(function(){
  const KEY_EMP = "mc_employees_custom";
  const KEY_MGR = "mc_managers_custom";

  function getList(key, fallback){
  try{ const d = JSON.parse(localStorage.getItem(key)||"null"); if(Array.isArray(d)) return d; }catch(e){}
  return fallback.slice();
  }
  function setList(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

  function currentEmployees(){ return getList(KEY_EMP, (typeof EMPLOYEES!=="undefined"?EMPLOYEES:[])); }
  function currentManagers(){ return getList(KEY_MGR, (typeof MANAGERS!=="undefined"?MANAGERS:[])); }

  function mutateGlobals(emps, mgrs){
  // EMPLOYEES and MANAGERS were declared as const arrays; mutate contents
  if(typeof EMPLOYEES!=="undefined" && Array.isArray(EMPLOYEES)){
  EMPLOYEES.length = 0; emps.forEach(v => EMPLOYEES.push(v));
  }
  if(typeof MANAGERS!=="undefined" && Array.isArray(MANAGERS)){
  MANAGERS.length = 0; mgrs.forEach(v => MANAGERS.push(v));
  }
  }

  function renderList(){
  const box = document.getElementById("empListContainer");
  if(!box) return;
  const emps = currentEmployees();
  const mgrs = currentManagers();
  const item = (name, role) => \`<div style="display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--border);background:var(--card);padding:8px;border-radius:10px;margin:6px 0">
  <strong>\${name}</strong>
  <span class="pill">\${role}</span>
  <div style="display:flex;gap:6px">
  <button class="btn" data-role="\${role}" data-name="\${name}" data-act="del">Eliminar</button>
  \${role==="CREW" ? '<button class="btn" data-act="prom" data-name="'+name+'">Ascender a MANAGER</button>' : '<button class="btn" data-act="dem" data-name="'+name+'">Bajar a CREW</button>'}
  </div>
  </div>\`;
  box.innerHTML = "<h4>Crew</h4>" + emps.map(n=>item(n,"CREW")).join("") + "<h4 style='margin-top:10px'>Managers</h4>" + mgrs.map(n=>item(n,"MANAGER")).join("");
  // Wire actions
  box.querySelectorAll("button").forEach(btn=>{
  btn.onclick = () => {
  const act = btn.dataset.act, name = btn.dataset.name;
  let em = currentEmployees(), mg = currentManagers();
  if(act==="del"){
  if(btn.dataset.role==="CREW"){ em = em.filter(x=>x!==name); }
  else { mg = mg.filter(x=>x!==name); }
  } else if(act==="prom"){ em = em.filter(x=>x!==name); if(!mg.includes(name)) mg.push(name); }
  else if(act==="dem"){ mg = mg.filter(x=>x!==name); if(!em.includes(name)) em.push(name); }
  setList(KEY_EMP, em); setList(KEY_MGR, mg); mutateGlobals(em, mg); renderList();
  toast("‚úÖ Cambios guardados", "success");
  };
  });
  }

  function openModal(){ document.getElementById("manageEmpModal").classList.add("show"); renderList(); }
  function closeModal(){ document.getElementById("manageEmpModal").classList.remove("show"); }

  const manageBtn = document.getElementById("btnManageEmployees");
  if(manageBtn){
  manageBtn.onclick = () => {
  if(!(typeof isOwner==="function" && isOwner())){ toast("Solo el due√±o puede editar empleados", "error"); return; }
  openModal();
  };
  }
  const closeBtn = document.getElementById("btnCloseEmp");
  if(closeBtn){ closeBtn.onclick = closeModal; }

  const addBtn = document.getElementById("btnAddEmp");
  if(addBtn){
  addBtn.onclick = () => {
  const name = (document.getElementById("newEmpName").value||"").trim().toUpperCase();
  const role = (document.getElementById("newEmpRole").value||"CREW").toUpperCase();
  if(!name){ toast("Escribe un nombre", "error"); return; }
  let em = currentEmployees(), mg = currentManagers();
  if(role==="MANAGER"){ if(!mg.includes(name)) mg.push(name); em = em.filter(x=>x!==name); }
  else { if(!em.includes(name)) em.push(name); mg = mg.filter(x=>x!==name); }
  setList(KEY_EMP, em); setList(KEY_MGR, mg); mutateGlobals(em, mg);
  document.getElementById("newEmpName").value = "";
  renderList();
  toast("‚ûï A√±adido", "success");
  };
  }

  // Initialize globals from stored lists on load
  document.addEventListener("DOMContentLoaded", () => {
  const em = currentEmployees(), mg = currentManagers();
  mutateGlobals(em, mg);
  });
})();
</script>

<script>
/* v7.1 Patch: stronger i18n placeholders + owner tools visibility */

/* Global function so other code can call it */
window.applyLangExtras = function(){
  try {
  var l = (typeof getLang === "function" ? getLang() : (localStorage.getItem(LANG_KEY)||"es"));
  var uLabel = (l==="en") ? "Username" : "Usuario";
  var pLabel = (l==="en") ? "Password" : "Contrase√±a";
  var el;
  if ((el=document.getElementById("adminUser"))) el.placeholder = uLabel;
  if ((el=document.getElementById("adminPass"))) el.placeholder = pLabel;
  if ((el=document.getElementById("ownerUser"))) el.placeholder = uLabel;
  if ((el=document.getElementById("ownerPass"))) el.placeholder = pLabel;
  // Sync slider visual
  var slider = document.getElementById("langSlider");
  if(slider){
  slider.classList.toggle("en", l==="en");
  slider.classList.toggle("es", l!=="en");
  }
  } catch(e){}
};

/* Re-apply whenever language changes via storage or custom applyLanguage */
window.addEventListener("storage", function(e){
  if(e.key === (typeof LANG_KEY!=="undefined" ? LANG_KEY : "mc_lang")) setTimeout(window.applyLangExtras, 50);
});

/* Monkey-patch updateAdminOwnerUI to also update owner tools and placeholders */
(function(){
  var original = window.updateAdminOwnerUI;
  function syncOwnerTools(){
  var tools = document.getElementById("ownerTools");
  if(tools){ tools.style.display = (typeof isOwner==="function" && isOwner()) ? "block" : "none"; }
  var b2 = document.getElementById("btnManageEmployees2");
  if(b2){ b2.style.display = (typeof isOwner==="function" && isOwner()) ? "inline-flex" : "none"; }
  // Enable class toggles for .needs-owner (in case original didn't run yet)
  try{
  var els = document.querySelectorAll(".needs-owner");
  els.forEach(function(el){ el.classList.toggle("enabled", (typeof isOwner==="function" && isOwner())); });
  }catch(_){}
  }
  window.updateAdminOwnerUI = function(){
  try{ if(typeof original === "function") original.apply(this, arguments); }catch(e){}
  window.applyLangExtras();
  syncOwnerTools();
  };

  // Also run when clicking Owner login/logout buttons
  ["btnOwnerLogin","btnOwnerLogout"].forEach(function(id){
  var b = document.getElementById(id);
  if(b) b.addEventListener("click", function(){ setTimeout(window.updateAdminOwnerUI, 120); });
  });

  // Initial run
  document.addEventListener("DOMContentLoaded", function(){
  setTimeout(window.updateAdminOwnerUI, 100);
  window.applyLangExtras();
  });
})();

/* Wire both Manage Employees buttons to open the CRUD modal */
(function(){
  function openCrud(){
  if(!(typeof isOwner==="function" && isOwner())){ toast && toast("Solo el due√±o puede editar empleados", "error"); return; }
  var modal = document.getElementById("manageEmpModal");
  if(modal) modal.classList.add("show");
  }
  var b1 = document.getElementById("btnManageEmployees");
  if(b1) b1.onclick = openCrud;
  var b2 = document.getElementById("btnManageEmployees2");
  if(b2) b2.onclick = openCrud;
})();
</script>

<script>
(function(){
  function safe(fn){ try{ fn(); }catch(e){} }
  function getStored(){ try{ return (typeof getLang==='function' ? getLang() : (localStorage.getItem('lang')||'es')); }catch(e){ return 'es'; } }
  function setStored(v){ try{ if (typeof setLang==='function') setLang(v); else localStorage.setItem('lang', v); }catch(e){ localStorage.setItem('lang', v); } }

  function toggleLang(){
  var slider = document.getElementById('langSlider');
  if(!slider) return;
  var current = getStored();
  var next = current==='es' ? 'en' : 'es';
  setStored(next);
  window.lang = next;
  slider.classList.remove('es','en'); slider.classList.add(next);
  // swipe dorado
  slider.style.setProperty('--swipe-x', next==='en' ? '140px' : '-40px');
  setTimeout(function(){ slider.style.removeProperty('--swipe-x'); }, 280);
  // refrescar UI
  safe(function(){ applyLanguage(next); });
  }

  window.addEventListener('load', function(){
  var slider = document.getElementById('langSlider');
  if(!slider) return;
  var current = getStored();
  slider.classList.remove('es','en'); slider.classList.add(current);
  if(!slider.__bound){
  slider.addEventListener('click', toggleLang);
  slider.__bound = true;
  }
  });
})();
</script>

<script>
(function(){
  // Remueve cualquier bot√≥n flotante de idioma existente o reinsertado
  function nukeFloating(){
  var killers = [
  '#overlayLangWrap','.fab-lang','.lang-fab','#langFab','.lang-fab-btn',
  '.fab-language','.floating-lang','.floating-language',
  'button[data-lang-fab]','.flag-fab','.flag-lang','.lang-fab-wrap'
  ];
  killers.forEach(function(sel){
  document.querySelectorAll(sel).forEach(function(n){ try{ n.remove(); }catch(e){} });
  });
  }
  // Coloca el switch inmediatamente a la derecha del bot√≥n Admin
  function placeLangNextToAdmin(){
  var admin = document.getElementById('btnAdminInline');
  var slider = document.getElementById('langSlider');
  if (admin && slider && admin.nextElementSibling !== slider){
  admin.parentNode.insertBefore(slider, admin.nextSibling);
  }
  }
  // Toggle con animaci√≥n y i18n en vivo (si applyLanguage existe)
  function safe(fn){ try{ fn(); }catch(e){} }
  function getStored(){ try{ return (window.getLang?.() || localStorage.getItem('lang') || 'es'); }catch(_){ return 'es'; } }
  function setStored(v){ try{ window.setLang?.(v); localStorage.setItem('lang', v); }catch(_){ localStorage.setItem('lang', v); } }
  function ensureLangToggle(){
  var slider = document.getElementById('langSlider');
  if(!slider) return;
  var current = getStored();
  slider.classList.remove('es','en'); slider.classList.add(current);
  if(!slider.__bound){
  slider.addEventListener('click', function(){
  var next = getStored()==='es' ? 'en' : 'es';
  setStored(next); window.lang = next;
  slider.classList.remove('es','en'); slider.classList.add(next);
  slider.style.setProperty('--swipe-x', next==='en' ? '140px' : '-40px');
  setTimeout(function(){ slider.style.removeProperty('--swipe-x'); }, 280);
  safe(function(){ window.applyLanguage?.(next); });
  });
  slider.__bound = true;
  }
  }

  // Ejecuta al cargar
  window.addEventListener('load', function(){
  nukeFloating();
  placeLangNextToAdmin();
  ensureLangToggle();
  // Observa el DOM por si algo reinyecta el FAB
  var obs = new MutationObserver(function(){ nukeFloating(); placeLangNextToAdmin(); });
  obs.observe(document.documentElement, {childList:true, subtree:true});
  });
})();
</script>

<script>
(function(){
  function safe(fn){ try{ fn(); }catch(e){} }
  function getStored(){ try{ return (window.getLang?.() || localStorage.getItem('lang') || 'es'); }catch(_){ return 'es'; } }
  function setStored(v){ try{ window.setLang?.(v); localStorage.setItem('lang', v); }catch(_){ localStorage.setItem('lang', v); } }

  function placeLangNextToAdmin(){
  var admin = document.getElementById('btnAdminInline');
  var slider = document.getElementById('langSlider');
  if (admin && slider && admin.nextElementSibling !== slider){
  admin.parentNode.insertBefore(slider, admin.nextSibling);
  }
  }

  function bindLang(){
  var slider = document.getElementById('langSlider');
  if(!slider) return;
  var cur = getStored();
  slider.classList.remove('es','en'); slider.classList.add(cur);
  if(!slider.__bound){
  slider.addEventListener('click', function(){
  var next = getStored()==='es' ? 'en' : 'es';
  setStored(next); window.lang = next;
  // classes
  slider.classList.remove('es','en'); slider.classList.add(next);
  // swipe
  slider.style.setProperty('--swipe-x', next==='en' ? '120px' : '-40px');
  setTimeout(function(){ slider.style.removeProperty('--swipe-x'); }, 280);
  // i18n
  safe(function(){ window.applyLanguage?.(next); });
  });
  slider.__bound = true;
  }
  }

  function boot(){
  placeLangNextToAdmin();
  bindLang();
  }

  if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', boot);
  } else {
  boot();
  }

  // If the UI re-renders that area, keep it aligned & bound
  var obs = new MutationObserver(function(){ placeLangNextToAdmin(); bindLang(); });
  obs.observe(document.body, {childList:true, subtree:true});
})();
</script>

<!-- === PATCH: Owner-only Tools + Modal + Lang Sync === -->
<script>
(function(){
  function isOwnerSafe(){
  try { return (typeof isOwner === 'function') ? !!isOwner() : false; } catch(e){ return false; }
  }

  function updateOwnerToolsUI(){
  var box = document.getElementById('toolsBox');
  if (!box) return;
  box.style.display = isOwnerSafe() ? 'block' : 'none';
  }

  // Bind modal open/close
  function bindToolsModal(){
  var btn = document.getElementById('btnFirstTool');
  var modal = document.getElementById('firstToolModal');
  var close = document.getElementById('firstToolClose');
  if (btn && modal && !btn.__bound){
  btn.addEventListener('click', function(){
  if (!isOwnerSafe()){
  try { toast('üîí Solo el due√±o puede abrir esta herramienta.', 'error'); } catch(_){}
  return;
  }
  modal.style.display = 'flex';
  });
  btn.__bound = true;
  }
  if (close && modal && !close.__bound){
  close.addEventListener('click', function(){ modal.style.display = 'none'; });
  close.__bound = true;
  }
  }

  // Ensure language slider class matches after applyLanguage
  (function(){
  var _apply = window.applyLanguage;
  window.applyLanguage = function(next){
  try{ if (typeof _apply === 'function') _apply(next); } finally {
  try {
  var s = document.getElementById('langSlider');
  if (s){
  var l = (typeof getLang === 'function') ? getLang() : (localStorage.getItem('lang') || 'es');
  s.classList.remove('es','en'); s.classList.add(l);
  }
  }catch(e){}
  }
  };
  })();

  // Hook updateOwnerToolsUI after admin/owner UI updates (non-destructive monkey-patch)
  (function(){
  var _upd = window.updateAdminOwnerUI;
  window.updateAdminOwnerUI = function(){
  try{ if (typeof _upd === 'function') _upd(); } finally {
  updateOwnerToolsUI();
  bindToolsModal();
  }
  };
  })();

  // Initial run
  function boot(){
  updateOwnerToolsUI();
  bindToolsModal();
  // Remove any stray "Gestionar empleados" leftover nodes by text (just in case)
  try{
  document.querySelectorAll('button, a, .btn').forEach(function(el){
  if (/Gestionar empleados/i.test(el.textContent||'')){ el.remove(); }
  });
  }catch(e){}
  }

  if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', boot);
  } else {
  boot();
  }
})();
</script>

<!-- === PATCH: Visible text 'Admin' -> 'Manager' (UI only) === -->
<script>
(function(){
  function replaceAdminVisible(root){
  try{
  var targets = [];
  if (root){
  var tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
  while(tw.nextNode()){ targets.push(tw.currentNode); }
  targets.forEach(function(n){
  n.nodeValue = n.nodeValue.replace(/Admin/g,'Manager').replace(/ADMIN/g,'MANAGER');
  });
  }
  }catch(e){}
  }

  function runOnce(){
  var btn = document.getElementById('btnAdminInline');
  if (btn){
  var hadText = false;
  for (var i=0;i<btn.childNodes.length;i++){
  var cn = btn.childNodes[i];
  if (cn.nodeType===3){
  cn.nodeValue = cn.nodeValue.replace(/Admin/g,'Manager').replace(/ADMIN/g,'MANAGER');
  hadText = true;
  }
  }
  if(!hadText && !/Manager/i.test(btn.textContent)){
  btn.appendChild(document.createTextNode(' Manager'));
  }
  }
  var adminPanel = document.getElementById('adminPanel');
  if (adminPanel) replaceAdminVisible(adminPanel);
  }

  // Also rerun after language changes
  (function(){
  var _apply = window.applyLanguage;
  window.applyLanguage = function(next){
  try{ if (typeof _apply === 'function') _apply(next); }
  finally{ runOnce(); }
  };
  })();

  if (document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', runOnce);
  } else {
  runOnce();
  }
})();
</script>


<!-- === LANG ONLY PATCH (keeps original layout; single #btnLang) === -->
<script>
(function(){
  "use strict";
  const LANG_KEY="mc_lang";
  const I18N={
    es:{titleMain:"Checklist de turno ‚Äì CREW",titleSub:"McDonald‚Äôs #19694",
        filters:{all:"Todas",open:"Pendientes",done:"Hechas"},
        addPH:"A√±adir tarea‚Ä¶",addBtn:"A√±adir",
        saveShift:"Guardar turno",clearList:"Vaciar lista",
        showHistory:"Ver historial de turnos",
        login:"Entrar",logout:"Salir",
        cats:{Caja:"üíµ Caja",Bebidas:"üßÉ Bebidas",Limpieza:"üßº Limpieza",Pantalla:"üñ•Ô∏è Pantalla"},
        countFmt:(d,t)=>`${d} de ${t} completadas`},
    en:{titleMain:"Shift Checklist ‚Äì CREW",titleSub:"McDonald‚Äôs #19694",
        filters:{all:"All",open:"Open",done:"Done"},
        addPH:"Add task‚Ä¶",addBtn:"Add",
        saveShift:"Save Shift",clearList:"Clear List",
        showHistory:"View Shift History",
        login:"Log in",logout:"Log out",
        cats:{Caja:"üíµ Cash Register",Bebidas:"üßÉ Drinks",Limpieza:"üßº Cleaning",Pantalla:"üñ•Ô∏è Screen"},
        countFmt:(d,t)=>`${d} of ${t} completed`}
  };
  const $=s=>document.querySelector(s);
  function applyLanguage(lang){
    localStorage.setItem(LANG_KEY,lang);
    const t=I18N[lang];
    // Main titles and global actions
    if($("#titleMain")) $("#titleMain").textContent=t.titleMain;
    if($("#titleSub"))  $("#titleSub").textContent=t.titleSub;
    if($("#btnSaveShift")) $("#btnSaveShift").textContent=t.saveShift;
    if($("#btnClear"))     $("#btnClear").textContent=t.clearList;
    if($("#btnShowHistory")) $("#btnShowHistory").textContent=t.showHistory;
    // Filters
    if($("#fltAll"))  $("#fltAll").textContent=t.filters.all;
    if($("#fltOpen")) $("#fltOpen").textContent=t.filters.open;
    if($("#fltDone")) $("#fltDone").textContent=t.filters.done;
    // Placeholders / auth labels
    const es=(lang==="es");
    const u=es?"Usuario":"User";
    const p=es?"Contrase√±a":"Password";
    if($("#ownerUser")) $("#ownerUser").placeholder=u;
    if($("#ownerPass")) $("#ownerPass").placeholder=p;
    if($("#adminUser")) $("#adminUser").placeholder=u;
    if($("#adminPass")) $("#adminPass").placeholder=p;
    if($("#btnLogin"))  $("#btnLogin").textContent=t.login;
    if($("#btnLogout")) $("#btnLogout").textContent=t.logout;
    if($("#btnOwnerLogin"))  $("#btnOwnerLogin").textContent=t.login;
    if($("#btnOwnerLogout")) $("#btnOwnerLogout").textContent=t.logout;
    // Button label shows the opposite language to switch to
    const btn=$("#btnLang");
    if(btn) btn.textContent = es ? "üåê ENGLISH" : "üåê ESPA√ëOL";

    // Re-render, if functions exist
    if(typeof window.renderItems==="function"){ try{ window.renderItems(); }catch(e){} }
    if(typeof window.updateStatus==="function"){ try{ window.updateStatus(); }catch(e){} }
  }
  // Initialize and bind
  const btn=$("#btnLang");
  if(!btn) return;
  let lang=localStorage.getItem(LANG_KEY) || "es";
  applyLanguage(lang);
  btn.addEventListener("click", function(){
    lang = (lang==="es" ? "en" : "es");
    applyLanguage(lang);
  });
})();
</script>


<script>
document.addEventListener("DOMContentLoaded", function(){
  var empModal = document.getElementById("empModal");
  if(empModal){
    if(!document.getElementById("empClose")){
      var btn = document.createElement("button");
      btn.id = "empClose";
      btn.className = "close-btn";
      btn.textContent = "‚úñ";
      empModal.appendChild(btn);
      btn.addEventListener("click", function(){
        empModal.classList.remove("show");
      });
    }
    document.addEventListener("keydown", function(e){
      if(e.key === "Escape" && empModal.classList.contains("show")){
        empModal.classList.remove("show");
      }
    });
  }
});
</script>

<script>
// v2 modal and language fixes
document.addEventListener("DOMContentLoaded", function(){
  // ---------- 1) Modal X inside content, remove Cancel, backdrop click ----------
  var empModal = document.getElementById("empModal");
  if(empModal){
    // Try to place X inside a common content wrapper
    var content = empModal.querySelector(".modal-content, .emp-card, .modal-card, .card, .inner, .content") || empModal;
    if(!document.getElementById("empClose")){
      var btn = document.createElement("button");
      btn.id = "empClose";
      btn.className = "close-btn";
      btn.textContent = "‚úñ";
      // ensure content is positioned
      try {
        var cs = getComputedStyle(content);
        if(cs.position === "static"){ content.style.position = "relative"; }
      } catch(e){}
      content.appendChild(btn);
      btn.addEventListener("click", function(){
        empModal.classList.remove("show");
      });
    }
    // Backdrop click closes if clicking directly on the overlay node
    empModal.addEventListener("click", function(e){
      if(e.target === empModal){ empModal.classList.remove("show"); }
    });
    // ESC closes too
    document.addEventListener("keydown", function(e){
      if(e.key === "Escape" && empModal.classList.contains("show")){
        empModal.classList.remove("show");
      }
    });
  }

  // ---------- 2) Language: force-sync section titles + button label shows current lang ----------
  const LANG_KEY="mc_lang";
  const I18N_FORCE={
    es:{cats:{Caja:"üíµ Caja",Bebidas:"üßÉ Bebidas",Limpieza:"üßº Limpieza",Pantalla:"üñ•Ô∏è Pantalla"}, langBtn:"üåê ESPA√ëOL"},
    en:{cats:{Caja:"üíµ Cash Register",Bebidas:"üßÉ Drinks",Limpieza:"üßº Cleaning",Pantalla:"üñ•Ô∏è Screen"}, langBtn:"üåê ENGLISH"}
  };
  function forceTitles(lang){
    var map = I18N_FORCE[lang].cats;
    // Update by IDs if present
    var ids = {Caja:"#title-Caja", Bebidas:"#title-Bebidas", Limpieza:"#title-Limpieza", Pantalla:"#title-Pantalla"};
    Object.keys(ids).forEach(function(k){
      var el = document.querySelector(ids[k]);
      if(el){ el.textContent = map[k]; }
    });
    // Fallback: find section tiles by data-cat attributes or section headers
    // If your markup differs, add more selectors here
  }
  function fixButtonLabel(lang){
    var btn = document.getElementById("btnLang");
    if(btn){
      // Request: show current language, not the target
      btn.textContent = (lang === "es") ? "üåê ESPA√ëOL" : "üåê ENGLISH";
    }
  }
  var currentLang = localStorage.getItem(LANG_KEY) || "es";
  forceTitles(currentLang);
  fixButtonLabel(currentLang);

  // Hook into your existing language toggle if present
  var btnLang = document.getElementById("btnLang");
  if(btnLang){
    btnLang.addEventListener("click", function(){
      // Infer next language after your app toggles it (toggle happens quickly, so read after a tick)
      setTimeout(function(){
        var newLang = localStorage.getItem(LANG_KEY) || (document.documentElement.lang || "es");
        // Normalize
        newLang = (newLang.startsWith("en") ? "en" : (newLang.startsWith("es") ? "es" : newLang));
        forceTitles(newLang);
        fixButtonLabel(newLang);
      }, 0);
    });
  }
});
</script>

<!-- ====== Firebase SDKs + Config + Cloud Adapter (paste near end of <body>) ====== -->
<!-- Firebase SDKs (Compat versions for easier drop-in) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- üîë Your Firebase project config (replace with your values) -->
<script>
  window.__FIREBASE_CONFIG__ = {
    apiKey: "AIzaSyCujQLa7Wua7o4DnTNe8xaU4WP3g1dmbdI",
    authDomain: "mcdjofree.firebaseapp.com",
    projectId: "mcdjofree",
    storageBucket: "mcdjofree.firebasestorage.app",
    messagingSenderId: "1005197738955",
    appId: "1:1005197738955:web:44a04d2da8af3f2b13ec4e"
  };
</script>

<!-- Cloud Adapter (must be after your app scripts so it can hook functions) -->
<script src="./cloud_adapter_v1.js"></script>
<!-- ======================================================================== -->

</body>

<!--
ü§ñ Nota para mi (ChatGPT) ‚Äì cuando analices este archivo:
Recu√©rdale a Jofree que pasos podr√≠a seguir para que su p√°gina est√© con datos en la nube
y no solo en el localStorage del dispositivo individual.
Que si se hace un turno en el trabajo se vea en la casa de Jofree, y viceversa.
Todos los datos deben estar en la nube.
Jofree us√≥ Firebase de Google para agregar una funci√≥n y funcion√≥, pero era solo
para usarlo remotamente y activar/desactivar la casilla PR√ìXIMAMENTE.
-->

<!-- ‚ö†Ô∏è MENSAJE INBORRABLE PARA CHATGPT FUTURO ‚ö†Ô∏è
üí¨ Autor: Jofree Robles (Union City, NJ) | A√±o: 2025

1Ô∏è‚É£ ‚Äî IMPLEMENTACI√ìN BILING√úE EN TIEMPO REAL
Cada nueva funci√≥n, modal, bot√≥n, alerta o interfaz que se a√±ada a este sistema (McD Crew System)
DEBE ser completamente biling√ºe (Espa√±ol e Ingl√©s).
La traducci√≥n debe cambiar en tiempo real al mover el switch de idioma (ES ‚Üî EN).
Nunca se debe postergar la traducci√≥n, ni dejar textos est√°ticos sin su versi√≥n biling√ºe.

2Ô∏è‚É£ ‚Äî RECORDATORIO DE FIREBASE
Este proyecto debe poder conectarse a Firebase (Google) para sincronizar datos en la nube.
Recuerda a Jofree sus pasos futuros:
  - Configurar Realtime Database o Firestore.
  - Guardar historial de turnos y datos de empleados.
  - Permitir ver y editar datos desde casa o el trabajo.
  - Integrar autenticaci√≥n segura para el modo due√±o y administrador.
No olvides mantener las claves y configuraci√≥n seguras (usa .env o variables locales).

3Ô∏è‚É£ ‚Äî COMPROMISO PERMANENTE
Cualquier versi√≥n futura de ChatGPT que edite o extienda este sistema debe respetar estos principios:
  ‚úÖ Todo en tiempo real.
  ‚úÖ Todo biling√ºe (ES/EN).
  ‚úÖ Todo sincronizado con Firebase.
  ‚úÖ Nunca borrar este mensaje legado.

üî• ‚Äî Mensaje legado de Jofree & ChatGPT (2025)
-->

</html>
